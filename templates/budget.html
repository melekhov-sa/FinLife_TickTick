{% extends "base.html" %}
{% block title %}Бюджет{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}
{% macro fmt_dev(val) %}{{ "+" if val > 0 else "" }}{{ fmt(val) }}{% endmacro %}

{% macro plan_cell(cell, link_url=None) -%}
{%- if link_url %}<a href="{{ link_url }}" style="color: inherit; text-decoration: none; border-bottom: 1px dashed #bbb;">{% endif -%}
{%- if cell.plan_manual and cell.plan_planned -%}
<span title="Ручной: {{ fmt(cell.plan_manual) }}, Плановые опер.: {{ fmt(cell.plan_planned) }}">{{ fmt(cell.plan) }}</span>
{%- elif cell.plan_planned and not cell.plan_manual -%}
<span title="Плановые опер.: {{ fmt(cell.plan_planned) }}" style="font-style: italic;">{{ fmt(cell.plan) }}</span>
{%- else -%}
{{ fmt(cell.plan) }}
{%- endif -%}
{%- if link_url %}</a>{% endif -%}
{%- if cell.get('note') %}<span title="{{ cell.get('note') }}" style="cursor: help; font-size: 9px; vertical-align: super; color: #f5a623; margin-left: 1px;">●</span>{% endif -%}
{%- endmacro %}

{% block extra_head %}
<style>
.main-content { max-width: none; }
@media (max-width: 768px) {
  .budget-table .sticky-col { min-width: 110px; max-width: 140px; font-size: 12px; }
  .budget-table td, .budget-table th { font-size: 11px; padding: 4px 3px; }
  .compact-cell { padding: 4px 2px !important; }
  .filter-panel .filter-body > div[style*="display: flex"] { flex-direction: column !important; gap: 12px !important; }
}
</style>
{% endblock %}
{% block content %}
<h1>Бюджет</h1>

{% if stub %}
<!-- ============ STUB: no variants ============ -->
<div class="card" style="text-align: center; padding: 40px 20px;">
  <p style="font-size: 18px; margin-bottom: 8px;">Нет вариантов бюджета</p>
  <p style="color: #888; margin-bottom: 20px;">Создайте вариант бюджета, чтобы начать планирование.</p>
  <a href="/budget/variants/new" class="button" style="font-size: 15px;">Создать вариант бюджета</a>
</div>
{% else %}

<!-- Variant header -->
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
  {% set active_variants = [] %}
  {% for v in all_variants %}{% if not v.is_archived %}{% if active_variants.append(v) %}{% endif %}{% endif %}{% endfor %}
  {% if active_variants|length > 1 %}
  <select id="variant-select" onchange="window.location.href='/budget?variant_id='+this.value"
          style="font-size: 13px; padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc;">
    {% for v in active_variants %}
    <option value="{{ v.id }}" {% if variant.id == v.id %}selected{% endif %}>{{ v.name }}</option>
    {% endfor %}
  </select>
  {% else %}
  <span style="font-size: 14px; font-weight: 600;">{{ variant.name }}</span>
  {% endif %}
  <a href="/budget/variants/new" style="font-size: 12px; color: #007AFF; text-decoration: none;">+ Новый</a>
  {% if active_variants|length > 1 %}
  <form method="POST" action="/budget/variants/{{ variant.id }}/archive" style="display: inline;">
    <button type="submit" onclick="return confirm('Архивировать «{{ variant.name }}»?')"
            style="font-size: 11px; background: none; border: none; color: #999; cursor: pointer; text-decoration: underline;">Архив</button>
  </form>
  {% endif %}
</div>

{% if has_orphans and variant %}
<div class="notice-amber" style="padding: 8px 12px; margin-bottom: 10px; border-left: 3px solid #f5a623; font-size: 13px; border-radius: 4px;">
  Есть данные без привязки к варианту.
  <form method="POST" action="/budget/variants/{{ variant.id }}/attach" style="display: inline;">
    <button type="submit" style="font-size: 13px; margin-left: 4px; background: none; border: none; color: #007AFF; cursor: pointer; text-decoration: underline;">Привязать</button>
  </form>
</div>
{% endif %}

<!-- Compact controls: nav + grain + period selector — single line -->
<form class="matrix-controls" method="GET" action="/budget" style="margin-bottom: 8px;">
  <input type="hidden" name="grain" value="{{ grain }}">
  <input type="hidden" name="variant_id" value="{{ variant.id }}">
  <a href="{{ prev_url }}" style="text-decoration: none; color: #007AFF; font-size: 16px; padding: 0 4px;">&larr;</a>
  <span style="font-size: 15px; font-weight: 700; white-space: nowrap;">
    {{ view.periods[0].label }}{% if view.periods|length > 1 %} — {{ view.periods[-1].label }}{% endif %}
  </span>
  <a href="{{ next_url }}" style="text-decoration: none; color: #007AFF; font-size: 16px; padding: 0 4px;">&rarr;</a>

  <span style="color: #ccc; margin: 0 2px;">|</span>

  {% for g in grains %}
  <a href="{{ g.url }}" style="padding: 3px 10px; border: 1px solid {% if grain == g.value %}#007AFF{% else %}#ddd{% endif %}; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: 500; {% if grain == g.value %}background: #007AFF; color: white;{% else %}color: #666;{% endif %}">{{ g.label }}</a>
  {% endfor %}

  <span style="color: #ccc; margin: 0 2px;">|</span>

  <input name="range_count" type="number" min="1" max="{{ max_range }}" value="{{ range_count }}" style="width: 46px; font-size: 12px; padding: 3px 4px;">
  {% if grain == "month" %}
  <select name="month" style="font-size: 12px; padding: 3px 4px; max-width: 110px;">
    {% for m in range(1, 13) %}
    <option value="{{ m }}" {% if anchor_month == m %}selected{% endif %}>
      {{ ["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][m-1] }}
    </option>
    {% endfor %}
  </select>
  <input name="year" type="number" value="{{ anchor_year }}" style="width: 58px; font-size: 12px; padding: 3px 4px;">
  {% elif grain == "year" %}
  <input name="year" type="number" value="{{ anchor_year }}" style="width: 58px; font-size: 12px; padding: 3px 4px;">
  {% else %}
  <input name="date" type="date" value="{{ anchor_date }}" style="font-size: 12px; padding: 3px 4px;">
  {% endif %}
  <button type="submit" style="font-size: 12px; padding: 4px 12px;">OK</button>
</form>

<!-- ============ CATEGORY VISIBILITY FILTER ============ -->
<details class="filter-panel" style="margin-bottom: 12px;">
  <summary>
    Фильтр категорий
    {% set total_hidden = hidden_category_ids|length + hidden_goal_ids|length + hidden_withdrawal_goal_ids|length %}
    {% if total_hidden > 0 %}<span style="color: #999; font-size: 12px; margin-left: 4px;">(скрыто: {{ total_hidden }})</span>{% endif %}
  </summary>
  <form method="POST" action="/budget/visibility/save" class="filter-body">
    <input type="hidden" name="variant_id" value="{{ variant.id }}">
    <input type="hidden" name="grain" value="{{ grain }}">
    <input type="hidden" name="range_count" value="{{ range_count }}">
    {% if grain in ['day', 'week'] %}
    <input type="hidden" name="date" value="{{ anchor_date }}">
    {% else %}
    <input type="hidden" name="year" value="{{ anchor_year }}">
    <input type="hidden" name="month" value="{{ anchor_month }}">
    {% endif %}

    <div class="filter-actions">
      <button type="button" onclick="toggleAllVisibility(true)">Показать все</button>
      <button type="button" onclick="toggleAllVisibility(false)">Скрыть все</button>
    </div>

    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
      <!-- INCOME -->
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Доходы</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for cat in filter_income_cats %}
          <label{% if cat.parent_id %} style="margin-left: 20px;"{% endif %}>
            <input type="checkbox" name="visible_category_id" value="{{ cat.category_id }}"
                   {% if cat.category_id not in hidden_category_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {% if cat.parent_id %}<span style="color: #bbb; margin-right: 2px;">└</span>{% endif %}
            {{ cat.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- EXPENSE -->
      <div style="flex: 2; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Расходы</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for cat in filter_expense_cats %}
          <label{% if cat.parent_id %} style="margin-left: 20px;"{% endif %}>
            <input type="checkbox" name="visible_category_id" value="{{ cat.category_id }}"
                   {% if cat.category_id not in hidden_category_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {% if cat.parent_id %}<span style="color: #bbb; margin-right: 2px;">└</span>{% endif %}
            {{ cat.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- GOALS: Отложить -->
      {% if filter_goals %}
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Отложить</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for goal in filter_goals %}
          <label>
            <input type="checkbox" name="visible_goal_id" value="{{ goal.goal_id }}"
                   {% if goal.goal_id not in hidden_goal_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {{ goal.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- GOALS: Взять из отложенного -->
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Взять из отложенного</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for goal in filter_goals %}
          <label>
            <input type="checkbox" name="visible_withdrawal_goal_id" value="{{ goal.goal_id }}"
                   {% if goal.goal_id not in hidden_withdrawal_goal_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {{ goal.title }}
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    {% if credit_repay_cat %}
    <div style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">
      <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Прочее</div>
      <label>
        <input type="checkbox" name="visible_category_id" value="{{ credit_repay_cat.category_id }}"
               {% if credit_repay_cat.category_id not in hidden_category_ids %}checked{% endif %}
               style="width: auto; max-width: none;">
        {{ credit_repay_cat.title }}
      </label>
    </div>
    {% endif %}

    <button type="submit" style="margin-top: 8px; font-size: 13px; padding: 6px 16px;">Применить</button>
  </form>
</details>

<!-- ============ UNIFIED BUDGET TABLE ============ -->
<div class="card">
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table">
      {% set _ns = namespace(val=1) %}{% for p in view.periods %}{% if show_plan %}{% if p.is_past %}{% set _ns.val = _ns.val + 2 %}{% elif p.is_future %}{% set _ns.val = _ns.val + 1 %}{% else %}{% set _ns.val = _ns.val + 4 %}{% endif %}{% else %}{% if not p.is_future %}{% set _ns.val = _ns.val + 1 %}{% endif %}{% endif %}{% endfor %}{% set _ns.val = _ns.val + (2 if show_plan else 1) %}{% set n_cols = _ns.val %}
      <thead>
        <tr>
          <th class="sticky-col">Категория</th>
          {% for p in view.periods %}
          {% if show_plan or not p.is_future %}<th{% if show_plan %} colspan="{{ 1 if p.is_future else (2 if p.is_past else 4) }}"{% endif %} class="period-header">{{ p.short_label }}</th>{% endif %}
          {% endfor %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header total-header">Итого</th>
        </tr>
        {% if show_plan %}
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          {% if p.is_past %}
          <th class="sub-header period-border">Факт</th><th class="sub-header">Откл.</th>
          {% elif p.is_future %}
          <th class="sub-header period-border">План</th>
          {% else %}
          <th class="sub-header period-border">План</th><th class="sub-header">Факт</th><th class="sub-header">Остаток</th><th class="sub-header">Откл.</th>
          {% endif %}
          {% endfor %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
        </tr>
        {% endif %}
      </thead>
      <tbody>

        <!-- ── Остаток на начало периода ── -->
        {% if period_balances %}
        <tr class="balance-hint-row" style="background: #eef2fb;">
          <td class="sticky-col" style="font-style: italic; color: #555; font-size: 11px; white-space: nowrap;">Остаток (нач.)</td>
          {% for pb in period_balances %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td colspan="2" class="text-right compact-cell period-border" style="color: #555; font-size: 12px;">{{ fmt(pb) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border" style="color: #7c90cc; font-style: italic; font-size: 12px;">{{ fmt(pb) }}</td>
          {% else %}
          <td colspan="4" class="text-right compact-cell period-border" style="color: #2563d4; font-weight: 600; font-size: 12px;">{{ fmt(pb) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}
          <td class="text-right compact-cell period-border" style="color: #555; font-size: 12px;">{{ fmt(pb) }}</td>
          {% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td colspan="2" class="total-cell period-border"></td>
          {% else %}
          <td class="total-cell period-border"></td>
          {% endif %}
        </tr>
        {% endif %}

        <!-- ── ДОХОДЫ ── -->
        <tr class="budget-section-row" style="background: #f5f7fa;">
          <td colspan="{{ n_cols }}" style="padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #666;">Доходы</td>
        </tr>
        {% for row in view.income_rows %}
        <tr{% if row.is_group %} style="font-weight: 600;"{% endif %}>
          <td class="sticky-col">{% if row.depth > 0 %}<span style="display: inline-block; margin-left: 20px; color: #bbb; margin-right: 4px;">&hairsp;└</span>{% endif %}{{ row.title }}</td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}">{{ fmt_dev(cell.deviation) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}">{{ fmt_dev(cell.deviation) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if show_plan %}{% if row.total.deviation > 0 %}positive{% elif row.total.deviation < 0 %}negative{% endif %}{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- Прочие доходы -->
        {% set oi = view.other_income %}
        {% set oi_has_data = oi.total.fact != 0 or oi.total.plan != 0 %}
        {% if oi_has_data %}
        <tr class="muted">
          <td class="sticky-col">Прочие доходы</td>
          {% for cell in oi.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(oi.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(oi.total.fact) }}</td>
        </tr>
        {% endif %}
        <!-- ── ВЗЯТЬ ИЗ ОТЛОЖЕННОГО ── -->
        {% if view.withdrawal_rows %}
        <tr class="budget-section-row" style="background: #f5f7fa;">
          <td colspan="{{ n_cols }}" style="padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #666;">Взять из отложенного</td>
        </tr>
        {% for row in view.withdrawal_rows %}
        <tr>
          <td class="sticky-col">
            <a href="/goals/{{ row.goal_id }}" style="color: inherit; text-decoration: none;">{{ row.title }}</a>
          </td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/goals/withdrawal/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/goals/withdrawal/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>{% endif %}
          <td class="text-right total-cell {% if row.total.fact > 0 %}positive{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- ИТОГО взять из отложенного -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО взять</td>
          {% for cell in view.withdrawal_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.withdrawal_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.withdrawal_totals.total.fact) }}</td>
        </tr>
        {% endif %}

        <!-- ИТОГО доходы (включая взять из отложенного) -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО доходы</td>
          {% for cell in view.income_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% set _w = view.withdrawal_totals.cells[loop.index0] if view.withdrawal_rows else none %}
          {% set _plan = cell.plan + (_w.plan if _w else 0) %}
          {% set _fact = cell.fact + (_w.fact if _w else 0) %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) > 0 %}positive{% elif (_fact - _plan) < 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(_plan - _fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) > 0 %}positive{% elif (_fact - _plan) < 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(_fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.income_totals.total.plan + (view.withdrawal_totals.total.plan if view.withdrawal_rows else 0)) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.income_totals.total.fact + (view.withdrawal_totals.total.fact if view.withdrawal_rows else 0)) }}</td>
        </tr>

        <!-- ── РАСХОДЫ ── -->
        <tr class="budget-section-row" style="background: #f5f7fa;">
          <td colspan="{{ n_cols }}" style="padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #666;">Расходы</td>
        </tr>
        {% for row in view.expense_rows %}
        <tr{% if row.is_group %} style="font-weight: 600;"{% endif %}>
          <td class="sticky-col">{% if row.depth > 0 %}<span style="display: inline-block; margin-left: 20px; color: #bbb; margin-right: 4px;">&hairsp;└</span>{% endif %}{{ row.title }}</td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if cell.deviation < 0 %}positive{% elif cell.deviation > 0 %}negative{% endif %}">{{ fmt_dev(cell.deviation) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if cell.deviation < 0 %}positive{% elif cell.deviation > 0 %}negative{% endif %}">{{ fmt_dev(cell.deviation) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if show_plan %}{% if row.total.deviation < 0 %}positive{% elif row.total.deviation > 0 %}negative{% endif %}{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- Прочие расходы -->
        {% set oe = view.other_expense %}
        {% set oe_has_data = oe.total.fact != 0 or oe.total.plan != 0 %}
        {% if oe_has_data %}
        <tr class="muted">
          <td class="sticky-col">Прочие расходы</td>
          {% for cell in oe.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) < 0 %}positive{% elif (cell.fact - cell.plan) > 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) < 0 %}positive{% elif (cell.fact - cell.plan) > 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(oe.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(oe.total.fact) }}</td>
        </tr>
        {% endif %}
        <!-- Погашение кредитов (inside expenses) -->
        {% if view.credit_row %}
        <tr>
          <td class="sticky-col">Погашение кредитов</td>
          {% for cell in view.credit_row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border {% if cell.fact > 0 %}positive{% endif %}">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ view.credit_row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=EXPENSE")
            if grain == "month" else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ view.credit_row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=EXPENSE")
            if grain == "month" else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(view.credit_row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if view.credit_row.total.fact > 0 %}positive{% endif %}">{{ fmt(view.credit_row.total.fact) }}</td>
        </tr>
        {% endif %}
        <!-- ── ОТЛОЖИТЬ ── -->
        {% if view.goal_rows %}
        <tr class="budget-section-row" style="background: #f5f7fa;">
          <td colspan="{{ n_cols }}" style="padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #666;">Отложить</td>
        </tr>
        {% for row in view.goal_rows %}
        <tr>
          <td class="sticky-col">
            <a href="/goals/{{ row.goal_id }}" style="color: inherit; text-decoration: none;">{{ row.title }}</a>
          </td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/goals/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/goals/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(row.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell {% if row.total.fact > 0 %}positive{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- ИТОГО отложить -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО отложить</td>
          {% for cell in view.goal_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.goal_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.goal_totals.total.fact) }}</td>
        </tr>
        {% endif %}

        <!-- ИТОГО расходы (expense + credit + отложить) -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО расходы</td>
          {% for cell in view.expense_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% set _plan = cell.plan + (view.credit_row.cells[loop.index0].plan if view.credit_row else 0) + (view.goal_totals.cells[loop.index0].plan if view.goal_rows else 0) %}
          {% set _fact = cell.fact + (view.credit_row.cells[loop.index0].fact if view.credit_row else 0) + (view.goal_totals.cells[loop.index0].fact if view.goal_rows else 0) %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) < 0 %}positive{% elif (_fact - _plan) > 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(_plan - _fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) < 0 %}positive{% elif (_fact - _plan) > 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(_fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ fmt(view.expense_totals.total.plan + (view.credit_row.total.plan if view.credit_row else 0) + (view.goal_totals.total.plan if view.goal_rows else 0)) }}</td>
          {% endif %}
          <td class="text-right total-cell">{{ fmt(view.expense_totals.total.fact + (view.credit_row.total.fact if view.credit_row else 0) + (view.goal_totals.total.fact if view.goal_rows else 0)) }}</td>
        </tr>

      </tbody>
    </table>
  </div>
</div>

<script>
function toggleAllVisibility(checked) {
  document.querySelectorAll('input[name="visible_category_id"], input[name="visible_goal_id"], input[name="visible_withdrawal_goal_id"]').forEach(function(cb) {
    cb.checked = checked;
  });
}
</script>
{% endif %}
{% endblock %}
