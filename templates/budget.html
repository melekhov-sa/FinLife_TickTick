{% extends "base.html" %}
{% block title %}Бюджет{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}
{% macro fmt_dev(val) %}{{ "+" if val > 0 else "" }}{{ fmt(val) }}{% endmacro %}
{% macro fmt_or_dash(val) %}{% if val == 0 %}<span class="zero-val">0</span>{% else %}{{ fmt(val) }}{% endif %}{% endmacro %}
{% macro fmtd_or_dash(val) %}{% if val == 0 %}<span class="zero-val">0</span>{% else %}{{ fmt_dev(val) }}{% endif %}{% endmacro %}
{%- macro _hint_cls(cell) -%}
{%- set p = cell.plan|default(0)|float -%}
{%- set f = cell.fact|default(0)|float -%}
{%- if p > 0 and f == 0 -%}row-plan-no-fact
{%- elif p > 0 and f > 0 -%}
{%- set thr = [10.0, p * 0.05]|max -%}
{%- if f > p + thr -%}row-over
{%- elif (f - p)|abs <= thr -%}row-ok
{%- endif -%}
{%- elif p <= 0 and f > 0 -%}row-unplanned
{%- endif -%}
{%- endmacro -%}

{% macro plan_cell(cell, link_url=None) -%}
{%- if link_url %}<a href="{{ link_url }}" style="color: inherit; text-decoration: none; border-bottom: 1px dashed #bbb;">{% endif -%}
{%- if cell.plan_manual and cell.plan_planned -%}
<span title="Ручной: {{ fmt(cell.plan_manual) }}, Плановые опер.: {{ fmt(cell.plan_planned) }}">{{ fmt(cell.plan) }}</span>
{%- elif cell.plan_planned and not cell.plan_manual -%}
<span title="Плановые опер.: {{ fmt(cell.plan_planned) }}" style="font-style: italic;">{{ fmt(cell.plan) }}</span>
{%- else -%}
{{ fmt(cell.plan) }}
{%- endif -%}
{%- if link_url %}</a>{% endif -%}
{%- if cell.get('note') %}<span title="{{ cell.get('note') }}" style="cursor: help; font-size: 9px; vertical-align: super; color: #f5a623; margin-left: 1px;">●</span>{% endif -%}
{%- endmacro %}

{% block extra_head %}
<style>
.main-content { max-width: none; }

/* ── Compact budget table ── */
.budget-table.bgt-compact th { padding: 5px 8px; font-size: 14px; }
.budget-table.bgt-compact td { padding: 3px 8px; font-size: 14px; line-height: 1.35; }
.budget-table.bgt-compact .compact-cell { padding: 3px 5px !important; font-size: 14px; }
.budget-table.bgt-compact .sticky-col { min-width: 150px; max-width: 200px; font-size: 14px; }

/* ── Zero values muted ── */
.zero-val { color: var(--text-secondary, #bbb); }

/* ── Section header — clickable toggle ── */
.bgt-section-hdr {
  cursor: pointer;
  user-select: none;
}
.bgt-section-hdr td {
  padding: 5px 10px !important;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.7px;
  color: #666;
  background: #f5f7fa;
}
.bgt-section-hdr .bgt-chevron {
  display: inline-block;
  font-size: 9px;
  margin-right: 4px;
  transition: transform 0.15s ease;
}
.bgt-section-hdr.bgt-collapsed .bgt-chevron {
  transform: rotate(-90deg);
}
.bgt-section-hdr .bgt-section-summary {
  font-weight: 400;
  font-size: 13px;
  color: #999;
  margin-left: 8px;
  letter-spacing: 0;
  text-transform: none;
}

/* Collapsible section rows */
.bgt-section-body.bgt-hidden { display: none; }

/* ── РАСХОДЫ highlight ── */
.bgt-section-hdr.bgt-expense td {
  background: #eef0f6;
  color: #333;
  font-size: 14px;
}
.bgt-section-total-expense td {
  font-weight: 700;
  border-top: 2px solid var(--border-color);
  background: #eef0f6 !important;
}

/* ── ОТЛОЖИТЬ / ВЗЯТЬ — visual separation ── */
.bgt-section-hdr.bgt-goals td {
  border-top: 2px solid var(--border-color, #ddd);
  background: #f8f6f0;
}
.bgt-section-hdr.bgt-withdrawal td {
  border-top: 2px solid var(--border-color, #ddd);
  background: #f8f6f0;
}

/* ── Compact sub-header labels ── */
.sub-header { font-size: 12px; min-width: 45px; padding: 3px 5px; }
.sub-header[title] { cursor: help; }

/* ── Child category indent (compact) ── */
.bgt-child-indent {
  display: inline-block;
  margin-left: 14px;
  color: #bbb;
  margin-right: 3px;
}

/* ── Row status hints (focus month) ── */
tr.row-ok > td { color: var(--text-secondary, #999); }
tr.row-plan-no-fact { background: rgba(255, 193, 7, 0.07); }
tr.row-over { background: rgba(220, 53, 69, 0.07); }
tr.row-unplanned { background: rgba(13, 110, 253, 0.06); }
tr.row-over .bgt-focus-delta { color: #dc3545 !important; font-weight: 600; }

/* ── Mobile ── */
@media (max-width: 768px) {
  .budget-table.bgt-compact .sticky-col { min-width: 100px; max-width: 130px; font-size: 13px; }
  .budget-table.bgt-compact td, .budget-table.bgt-compact th { font-size: 12px; padding: 3px 2px; }
  .budget-table.bgt-compact .compact-cell { padding: 3px 2px !important; }
  .filter-panel .filter-body > div[style*="display: flex"] { flex-direction: column !important; gap: 12px !important; }
}

/* ── Dark mode overrides for new budget elements ── */
[data-theme$="-dark"] .bgt-section-hdr td { background: #1c2128 !important; color: #8b949e !important; }
[data-theme$="-dark"] .bgt-section-hdr .bgt-section-summary { color: #6e7681; }
[data-theme$="-dark"] .bgt-section-hdr.bgt-expense td { background: #1a1f2e !important; color: #c9d1d9 !important; }
[data-theme$="-dark"] .bgt-section-total-expense td { background: #1a1f2e !important; }
[data-theme$="-dark"] .bgt-section-hdr.bgt-goals td { background: #1e1d17 !important; border-top-color: #30363d; }
[data-theme$="-dark"] .bgt-section-hdr.bgt-withdrawal td { background: #1e1d17 !important; border-top-color: #30363d; }
[data-theme$="-dark"] .zero-val { color: #484f58; }
[data-theme$="-dark"] tr.row-plan-no-fact { background: rgba(255, 193, 7, 0.05); }
[data-theme$="-dark"] tr.row-over { background: rgba(220, 53, 69, 0.05); }
[data-theme$="-dark"] tr.row-unplanned { background: rgba(13, 110, 253, 0.04); }
[data-theme$="-dark"] tr.row-over .bgt-focus-delta { color: #f87171 !important; }

/* ── Future period heat-map + readable text ── */
td[data-val] { transition: background-color 0.15s; color: var(--text-primary, #111) !important; }
[data-theme$="-dark"] td[data-val] { color: #e6edf3 !important; filter: brightness(1.15); }

/* ── Drag & drop category reorder ── */
.drag-handle {
  cursor: grab;
  color: #ccc;
  padding: 0 5px 0 0;
  font-size: 13px;
  user-select: none;
  display: inline-block;
  opacity: 0;
  transition: opacity 0.1s;
}
tr[data-cat-id]:hover .drag-handle { opacity: 1; }
tr[data-cat-id].bgt-dragging { opacity: 0.35; }
tr[data-cat-id].bgt-drag-over > td:first-child { border-top: 2px solid #007AFF; }
[data-theme$="-dark"] tr[data-cat-id].bgt-drag-over > td:first-child { border-top-color: #58a6ff; }
tr[data-goal-id]:hover .drag-handle { opacity: 1; }
tr[data-goal-id].bgt-dragging { opacity: 0.35; }
tr[data-goal-id].bgt-drag-over > td:first-child { border-top: 2px solid #007AFF; }
[data-theme$="-dark"] tr[data-goal-id].bgt-drag-over > td:first-child { border-top-color: #58a6ff; }
</style>
{% endblock %}
{% block content %}
<h1>Бюджет</h1>

{% if stub %}
<!-- ============ STUB: no variants ============ -->
<div class="card" style="text-align: center; padding: 40px 20px;">
  <p style="font-size: 18px; margin-bottom: 8px;">Нет вариантов бюджета</p>
  <p style="color: #888; margin-bottom: 20px;">Создайте вариант бюджета, чтобы начать планирование.</p>
  <a href="/budget/variants/new" class="button" style="font-size: 15px;">Создать вариант бюджета</a>
</div>
{% else %}

<!-- Variant header -->
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
  {% set active_variants = [] %}
  {% for v in all_variants %}{% if not v.is_archived %}{% if active_variants.append(v) %}{% endif %}{% endif %}{% endfor %}
  {% if active_variants|length > 1 %}
  <select id="variant-select" onchange="window.location.href='/budget?variant_id='+this.value"
          style="font-size: 13px; padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc;">
    {% for v in active_variants %}
    <option value="{{ v.id }}" {% if variant.id == v.id %}selected{% endif %}>{{ v.name }}</option>
    {% endfor %}
  </select>
  {% else %}
  <span style="font-size: 14px; font-weight: 600;">{{ variant.name }}</span>
  {% endif %}
  <a href="/budget/variants/new" style="font-size: 12px; color: #007AFF; text-decoration: none;">+ Новый</a>
  {% if active_variants|length > 1 %}
  <form method="POST" action="/budget/variants/{{ variant.id }}/archive" style="display: inline;">
    <button type="submit" onclick="return confirm('Архивировать «{{ variant.name }}»?')"
            style="font-size: 11px; background: none; border: none; color: #999; cursor: pointer; text-decoration: underline;">Архив</button>
  </form>
  {% endif %}
</div>

{% if has_orphans and variant %}
<div class="notice-amber" style="padding: 8px 12px; margin-bottom: 10px; border-left: 3px solid #f5a623; font-size: 13px; border-radius: 4px;">
  Есть данные без привязки к варианту.
  <form method="POST" action="/budget/variants/{{ variant.id }}/attach" style="display: inline;">
    <button type="submit" style="font-size: 13px; margin-left: 4px; background: none; border: none; color: #007AFF; cursor: pointer; text-decoration: underline;">Привязать</button>
  </form>
</div>
{% endif %}

<!-- Compact controls: nav + grain + period selector — single line -->
<form class="matrix-controls" method="GET" action="/budget" style="margin-bottom: 8px;">
  <input type="hidden" name="grain" value="{{ grain }}">
  <input type="hidden" name="variant_id" value="{{ variant.id }}">
  <a href="{{ prev_url }}" style="text-decoration: none; color: #007AFF; font-size: 16px; padding: 0 4px;">&larr;</a>
  <span style="font-size: 15px; font-weight: 700; white-space: nowrap;">
    {{ view.periods[0].label }}{% if view.periods|length > 1 %} — {{ view.periods[-1].label }}{% endif %}
  </span>
  <a href="{{ next_url }}" style="text-decoration: none; color: #007AFF; font-size: 16px; padding: 0 4px;">&rarr;</a>

  <span style="color: #ccc; margin: 0 2px;">|</span>

  {% for g in grains %}
  <a href="{{ g.url }}" style="padding: 3px 10px; border: 1px solid {% if grain == g.value %}#007AFF{% else %}#ddd{% endif %}; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: 500; {% if grain == g.value %}background: #007AFF; color: white;{% else %}color: #666;{% endif %}">{{ g.label }}</a>
  {% endfor %}

  <span style="color: #ccc; margin: 0 2px;">|</span>

  <input name="range_count" type="number" min="1" max="{{ max_range }}" value="{{ range_count }}" style="width: 46px; font-size: 12px; padding: 3px 4px;">
  {% if grain == "month" %}
  <select name="month" style="font-size: 12px; padding: 3px 4px; max-width: 110px;">
    {% for m in range(1, 13) %}
    <option value="{{ m }}" {% if anchor_month == m %}selected{% endif %}>
      {{ ["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][m-1] }}
    </option>
    {% endfor %}
  </select>
  <input name="year" type="number" value="{{ anchor_year }}" style="width: 58px; font-size: 12px; padding: 3px 4px;">
  {% elif grain == "year" %}
  <input name="year" type="number" value="{{ anchor_year }}" style="width: 58px; font-size: 12px; padding: 3px 4px;">
  {% else %}
  <input name="date" type="date" value="{{ anchor_date }}" style="font-size: 12px; padding: 3px 4px;">
  {% endif %}
  <button type="submit" style="font-size: 12px; padding: 4px 12px;">OK</button>
  <a href="/budget/report?variant_id={{ variant.id }}"
     style="font-size: 12px; padding: 4px 12px; border: 1px solid #ddd;
            border-radius: 4px; text-decoration: none; color: #666; margin-left: 8px;">
    Отчёт
  </a>
</form>

<!-- ============ CATEGORY VISIBILITY FILTER ============ -->
<details class="filter-panel" style="margin-bottom: 12px;">
  <summary>
    Фильтр категорий
    {% set total_hidden = hidden_category_ids|length + hidden_goal_ids|length + hidden_withdrawal_goal_ids|length %}
    {% if total_hidden > 0 %}<span style="color: #999; font-size: 12px; margin-left: 4px;">(скрыто: {{ total_hidden }})</span>{% endif %}
  </summary>
  <form method="POST" action="/budget/visibility/save" class="filter-body">
    <input type="hidden" name="variant_id" value="{{ variant.id }}">
    <input type="hidden" name="grain" value="{{ grain }}">
    <input type="hidden" name="range_count" value="{{ range_count }}">
    {% if grain in ['day', 'week'] %}
    <input type="hidden" name="date" value="{{ anchor_date }}">
    {% else %}
    <input type="hidden" name="year" value="{{ anchor_year }}">
    <input type="hidden" name="month" value="{{ anchor_month }}">
    {% endif %}

    <div class="filter-actions">
      <button type="button" onclick="toggleAllVisibility(true)">Показать все</button>
      <button type="button" onclick="toggleAllVisibility(false)">Скрыть все</button>
    </div>

    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
      <!-- INCOME -->
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Доходы</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for cat in filter_income_cats %}
          <label{% if cat.parent_id %} style="margin-left: 20px;"{% endif %}>
            <input type="checkbox" name="visible_category_id" value="{{ cat.category_id }}"
                   {% if cat.category_id not in hidden_category_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {% if cat.parent_id %}<span style="color: #bbb; margin-right: 2px;">└</span>{% endif %}
            {{ cat.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- EXPENSE -->
      <div style="flex: 2; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Расходы</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for cat in filter_expense_cats %}
          <label{% if cat.parent_id %} style="margin-left: 20px;"{% endif %}>
            <input type="checkbox" name="visible_category_id" value="{{ cat.category_id }}"
                   {% if cat.category_id not in hidden_category_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {% if cat.parent_id %}<span style="color: #bbb; margin-right: 2px;">└</span>{% endif %}
            {{ cat.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- GOALS: Отложить -->
      {% if filter_goals %}
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Отложить</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for goal in filter_goals %}
          <label>
            <input type="checkbox" name="visible_goal_id" value="{{ goal.goal_id }}"
                   {% if goal.goal_id not in hidden_goal_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {{ goal.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- GOALS: Взять из отложенного -->
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Взять из отложенного</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for goal in filter_goals %}
          <label>
            <input type="checkbox" name="visible_withdrawal_goal_id" value="{{ goal.goal_id }}"
                   {% if goal.goal_id not in hidden_withdrawal_goal_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {{ goal.title }}
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    {% if credit_repay_cat %}
    <div style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">
      <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Прочее</div>
      <label>
        <input type="checkbox" name="visible_category_id" value="{{ credit_repay_cat.category_id }}"
               {% if credit_repay_cat.category_id not in hidden_category_ids %}checked{% endif %}
               style="width: auto; max-width: none;">
        {{ credit_repay_cat.title }}
      </label>
    </div>
    {% endif %}

    <button type="submit" style="margin-top: 8px; font-size: 13px; padding: 6px 16px;">Применить</button>
  </form>
</details>

<!-- ============ UNIFIED BUDGET TABLE ============ -->
{# Precompute section totals for summary lines #}
{% set _income_plan_total = view.income_totals.total.plan + (view.withdrawal_totals.total.plan if view.withdrawal_rows else 0) %}
{% set _income_fact_total = view.income_totals.total.fact + (view.withdrawal_totals.total.fact if view.withdrawal_rows else 0) %}
{% set _expense_plan_total = view.expense_totals.total.plan + (view.goal_totals.total.plan if view.goal_rows else 0) %}
{% set _expense_fact_total = view.expense_totals.total.fact + (view.goal_totals.total.fact if view.goal_rows else 0) %}

<div class="card">
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table bgt-compact">
      {% set _ns = namespace(val=1) %}{% for p in view.periods %}{% if show_plan %}{% if p.is_past %}{% set _ns.val = _ns.val + 2 %}{% elif p.is_future %}{% set _ns.val = _ns.val + 1 %}{% else %}{% set _ns.val = _ns.val + 4 %}{% endif %}{% else %}{% if not p.is_future %}{% set _ns.val = _ns.val + 1 %}{% endif %}{% endif %}{% endfor %}{% set _ns.val = _ns.val + (2 if show_plan else 1) %}{% set n_cols = _ns.val %}
      <thead>
        <tr>
          <th class="sticky-col">Категория</th>
          {% for p in view.periods %}
          {% if show_plan or not p.is_future %}<th{% if show_plan %} colspan="{{ 1 if p.is_future else (2 if p.is_past else 4) }}"{% endif %} class="period-header">{{ p.short_label }}</th>{% endif %}
          {% endfor %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header total-header">Итого</th>
        </tr>
        {% if show_plan %}
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          {% if p.is_past %}
          <th class="sub-header period-border" title="Факт">Ф</th><th class="sub-header" title="Отклонение">Δ</th>
          {% elif p.is_future %}
          <th class="sub-header period-border" title="План">П</th>
          {% else %}
          <th class="sub-header period-border" title="План">П</th><th class="sub-header" title="Факт">Ф</th><th class="sub-header" title="Остаток">Ост</th><th class="sub-header" title="Отклонение">Δ</th>
          {% endif %}
          {% endfor %}
          <th class="sub-header period-border" title="План">П</th>
          <th class="sub-header" title="Факт">Ф</th>
        </tr>
        {% endif %}
      </thead>
      <tbody>

        <!-- ── Остаток на начало периода ── -->
        {% if period_balances %}
        <tr class="balance-hint-row" style="background: #eef2fb;">
          <td class="sticky-col" style="font-style: italic; color: #555; font-size: 11px; white-space: nowrap;">Остаток (нач.)</td>
          {% for pb in period_balances %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td colspan="2" class="text-right compact-cell period-border" style="color: #555;">{{ fmt(pb) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border" style="color: #7c90cc; font-style: italic;">{{ fmt(pb) }}</td>
          {% else %}
          <td colspan="4" class="text-right compact-cell period-border" style="color: #2563d4; font-weight: 600;">{{ fmt(pb) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}
          <td class="text-right compact-cell period-border" style="color: #555;">{{ fmt(pb) }}</td>
          {% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td colspan="2" class="total-cell period-border"></td>
          {% else %}
          <td class="total-cell period-border"></td>
          {% endif %}
        </tr>
        {% endif %}

        <!-- ══════════════════════════════════════════════ -->
        <!-- ── ДОХОДЫ (collapsed by default) ──────────── -->
        <!-- ══════════════════════════════════════════════ -->
        <tr class="bgt-section-hdr bgt-collapsed" data-section="income" onclick="bgtToggle('income')">
          <td colspan="{{ n_cols }}">
            <span class="bgt-chevron">&#9658;</span>Доходы
            <span class="bgt-section-summary">
              {% if show_plan %}П: {{ fmt(view.income_totals.total.plan) }} · {% endif %}Ф: {{ fmt(view.income_totals.total.fact) }}
            </span>
          </td>
        </tr>
        {% for row in view.income_rows %}
        <tr class="bgt-section-body bgt-hidden" data-section="income" data-cat-id="{{ row.category_id }}" data-par-id="{{ row.parent_id or '' }}"{% if row.is_group %} style="font-weight: 600;"{% endif %}>
          <td class="sticky-col"><span class="drag-handle" title="Перетащить">⠿</span>{% if row.depth > 0 %}<span class="bgt-child-indent">&hairsp;└</span>{% endif %}{{ row.title }}</td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell {% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.deviation) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border" data-val="{{ cell.plan }}">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt_or_dash(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.deviation) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if show_plan %}{% if row.total.deviation > 0 %}positive{% elif row.total.deviation < 0 %}negative{% endif %}{% endif %}">{{ fmt_or_dash(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- Прочие доходы -->
        {% set oi = view.other_income %}
        {% set oi_has_data = oi.total.fact != 0 or oi.total.plan != 0 %}
        {% if oi_has_data %}
        <tr class="bgt-section-body bgt-hidden muted" data-section="income">
          <td class="sticky-col">Прочие доходы</td>
          {% for cell in oi.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt_or_dash(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt_or_dash(oi.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt_or_dash(oi.total.fact) }}</td>
        </tr>
        {% endif %}

        <!-- ── ВЗЯТЬ ИЗ ОТЛОЖЕННОГО (collapsed by default) ── -->
        {% if view.withdrawal_rows %}
        <tr class="bgt-section-hdr bgt-withdrawal bgt-collapsed" data-section="withdrawal" onclick="bgtToggle('withdrawal')">
          <td colspan="{{ n_cols }}">
            <span class="bgt-chevron">&#9658;</span>Взять из отложенного
            <span class="bgt-section-summary">
              {% if show_plan %}П: {{ fmt(view.withdrawal_totals.total.plan) }} · {% endif %}Ф: {{ fmt(view.withdrawal_totals.total.fact) }}
            </span>
          </td>
        </tr>
        {% for row in view.withdrawal_rows %}
        <tr class="bgt-section-body bgt-hidden" data-section="withdrawal" data-goal-id="{{ row.goal_id }}">
          <td class="sticky-col"><span class="drag-handle" title="Перетащить">⠿</span><a href="/goals/{{ row.goal_id }}" style="color: inherit; text-decoration: none;">{{ row.title }}</a></td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border" data-val="{{ cell.plan }}">{{ plan_cell(cell,
            link_url=("/budget/goals/withdrawal/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/goals/withdrawal/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt_or_dash(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt_or_dash(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>{% endif %}
          <td class="text-right total-cell {% if row.total.fact > 0 %}positive{% endif %}">{{ fmt_or_dash(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- ИТОГО взять из отложенного -->
        <tr class="bgt-section-body bgt-hidden budget-total-row" data-section="withdrawal">
          <td class="sticky-col">ИТОГО взять</td>
          {% for cell in view.withdrawal_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.withdrawal_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.withdrawal_totals.total.fact) }}</td>
        </tr>
        {% endif %}

        <!-- ИТОГО доходы (включая взять из отложенного) -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО доходы</td>
          {% for cell in view.income_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% set _w = view.withdrawal_totals.cells[loop.index0] if view.withdrawal_rows else none %}
          {% set _plan = cell.plan + (_w.plan if _w else 0) %}
          {% set _fact = cell.fact + (_w.fact if _w else 0) %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) > 0 %}positive{% elif (_fact - _plan) < 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(_plan - _fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) > 0 %}positive{% elif (_fact - _plan) < 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(_fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(_income_plan_total) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(_income_fact_total) }}</td>
        </tr>

        <!-- ══════════════════════════════════════════════ -->
        <!-- ── РАСХОДЫ (open by default) ─────────────── -->
        <!-- ══════════════════════════════════════════════ -->
        <tr class="bgt-section-hdr bgt-expense" data-section="expense" onclick="bgtToggle('expense')">
          <td colspan="{{ n_cols }}">
            <span class="bgt-chevron">&#9658;</span>Расходы
            <span class="bgt-section-summary">
              {% if show_plan %}П: {{ fmt(view.expense_totals.total.plan) }} · {% endif %}Ф: {{ fmt(view.expense_totals.total.fact) }}
            </span>
          </td>
        </tr>
        {% for row in view.expense_rows %}
        <tr class="bgt-section-body{% if show_plan %} {{ _hint_cls(row.cells[0]) }}{% endif %}" data-section="expense" data-cat-id="{{ row.category_id }}" data-par-id="{{ row.parent_id or '' }}"{% if row.is_group %} style="font-weight: 600;"{% endif %}>
          <td class="sticky-col"><span class="drag-handle" title="Перетащить">⠿</span>{% if row.depth > 0 %}<span class="bgt-child-indent">&hairsp;└</span>{% endif %}{{ row.title }}</td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border{% if row.is_credit and cell.fact > 0 %} positive{% endif %}">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell {% if row.is_credit %}{% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}{% else %}{% if cell.deviation < 0 %}positive{% elif cell.deviation > 0 %}negative{% endif %}{% endif %}{% if loop.index0 == 0 %} bgt-focus-delta{% endif %}">{{ fmtd_or_dash(cell.deviation) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border" data-val="{{ cell.plan }}">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          <td class="text-right compact-cell{% if row.is_credit and cell.fact > 0 %} positive{% endif %}">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt_or_dash(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if row.is_credit %}{% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}{% else %}{% if cell.deviation < 0 %}positive{% elif cell.deviation > 0 %}negative{% endif %}{% endif %}{% if loop.index0 == 0 %} bgt-focus-delta{% endif %}">{{ fmtd_or_dash(cell.deviation) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell{% if row.is_credit and cell.fact > 0 %} positive{% endif %}">{{ fmt_or_dash(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if row.is_credit %}{% if row.total.fact > 0 %}positive{% endif %}{% elif show_plan %}{% if row.total.deviation < 0 %}positive{% elif row.total.deviation > 0 %}negative{% endif %}{% endif %}">{{ fmt_or_dash(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- Прочие расходы -->
        {% set oe = view.other_expense %}
        {% set oe_has_data = oe.total.fact != 0 or oe.total.plan != 0 %}
        {% if oe_has_data %}
        <tr class="bgt-section-body muted" data-section="expense">
          <td class="sticky-col">Прочие расходы</td>
          {% for cell in oe.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) < 0 %}positive{% elif (cell.fact - cell.plan) > 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt_or_dash(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) < 0 %}positive{% elif (cell.fact - cell.plan) > 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt_or_dash(oe.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt_or_dash(oe.total.fact) }}</td>
        </tr>
        {% endif %}
        <!-- ══════════════════════════════════════════════ -->
        <!-- ── ОТЛОЖИТЬ (open by default) ────────────── -->
        <!-- ══════════════════════════════════════════════ -->
        {% if view.goal_rows %}
        <tr class="bgt-section-hdr bgt-goals bgt-collapsed" data-section="goals" onclick="bgtToggle('goals')">
          <td colspan="{{ n_cols }}">
            <span class="bgt-chevron">&#9658;</span>Отложить
            <span class="bgt-section-summary">
              {% if show_plan %}П: {{ fmt(view.goal_totals.total.plan) }} · {% endif %}Ф: {{ fmt(view.goal_totals.total.fact) }}
            </span>
          </td>
        </tr>
        {% for row in view.goal_rows %}
        <tr class="bgt-section-body bgt-hidden" data-section="goals" data-goal-id="{{ row.goal_id }}">
          <td class="sticky-col"><span class="drag-handle" title="Перетащить">⠿</span><a href="/goals/{{ row.goal_id }}" style="color: inherit; text-decoration: none;">{{ row.title }}</a></td>
          {% for cell in row.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell muted period-border" data-val="{{ cell.plan }}">{{ plan_cell(cell,
            link_url=("/budget/goals/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          {% else %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/goals/plan/edit?goal_id=" ~ row.goal_id ~ "&year=" ~ _p.year ~ "&month=" ~ _p.month ~ "&variant_id=" ~ variant.id)
            if grain == "month" else None
          ) }}</td>
          <td class="text-right compact-cell">{{ fmt_or_dash(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt_or_dash(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmtd_or_dash(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt_or_dash(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt_or_dash(row.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell {% if row.total.fact > 0 %}positive{% endif %}">{{ fmt_or_dash(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- ИТОГО отложить -->
        <tr class="bgt-section-body bgt-hidden budget-total-row" data-section="goals">
          <td class="sticky-col">ИТОГО отложить</td>
          {% for cell in view.goal_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(cell.plan - cell.fact) }}</td>
          <td class="text-right compact-cell {% if (cell.fact - cell.plan) > 0 %}positive{% elif (cell.fact - cell.plan) < 0 %}negative{% endif %}">{{ fmt_dev(cell.fact - cell.plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.goal_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.goal_totals.total.fact) }}</td>
        </tr>
        {% endif %}

        <!-- ИТОГО расходы (expense + credit + отложить) -->
        <tr class="budget-total-row bgt-section-total-expense">
          <td class="sticky-col">ИТОГО расходы</td>
          {% for cell in view.expense_totals.cells %}
          {% set _p = view.periods[loop.index0] %}
          {% set _plan = cell.plan + (view.goal_totals.cells[loop.index0].plan if view.goal_rows else 0) %}
          {% set _fact = cell.fact + (view.goal_totals.cells[loop.index0].fact if view.goal_rows else 0) %}
          {% if show_plan %}
          {% if _p.is_past %}
          <td class="text-right compact-cell period-border">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) < 0 %}positive{% elif (_fact - _plan) > 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% elif _p.is_future %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          {% else %}
          <td class="text-right compact-cell period-border">{{ fmt(_plan) }}</td>
          <td class="text-right compact-cell">{{ fmt(_fact) }}</td>
          <td class="text-right compact-cell muted">{{ fmt(_plan - _fact) }}</td>
          <td class="text-right compact-cell {% if (_fact - _plan) < 0 %}positive{% elif (_fact - _plan) > 0 %}negative{% endif %}">{{ fmt_dev(_fact - _plan) }}</td>
          {% endif %}
          {% else %}
          {% if not _p.is_future %}<td class="text-right compact-cell">{{ fmt(_fact) }}</td>{% endif %}
          {% endif %}
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ fmt(_expense_plan_total) }}</td>
          {% endif %}
          <td class="text-right total-cell">{{ fmt(_expense_fact_total) }}</td>
        </tr>

      </tbody>
    </table>
  </div>
</div>

<script>
function bgtToggle(section) {
  var hdr = document.querySelector('.bgt-section-hdr[data-section="' + section + '"]');
  var rows = document.querySelectorAll('.bgt-section-body[data-section="' + section + '"]');
  var collapsed = hdr.classList.toggle('bgt-collapsed');
  for (var i = 0; i < rows.length; i++) {
    if (collapsed) {
      rows[i].classList.add('bgt-hidden');
    } else {
      rows[i].classList.remove('bgt-hidden');
    }
  }
}

function toggleAllVisibility(checked) {
  document.querySelectorAll('input[name="visible_category_id"], input[name="visible_goal_id"], input[name="visible_withdrawal_goal_id"]').forEach(function(cb) {
    cb.checked = checked;
  });
}

(function initBgtDrag() {
  var dragSrc = null;

  // All rows with data-par-id that belong to the same reorder group (section + parent)
  function groupKey(row) {
    return row.dataset.section + ':' + (row.dataset.parId || '');
  }

  // Get a parent row's subtree: [parent, child1, child2, ...]
  function subtree(tbody, row) {
    var result = [row];
    if (!row.dataset.parId) {
      var catId = row.dataset.catId;
      tbody.querySelectorAll('tr[data-cat-id]').forEach(function(r) {
        if (r.dataset.parId === catId) result.push(r);
      });
    }
    return result;
  }

  // Insertion ref node: the node AFTER which we insert (null = append)
  function insertionRef(tbody, targetRow, after) {
    if (!after) return targetRow;
    // If target is a parent, skip past its children
    if (!targetRow.dataset.parId) {
      var catId = targetRow.dataset.catId;
      var lastChild = targetRow;
      tbody.querySelectorAll('tr[data-cat-id]').forEach(function(r) {
        if (r.dataset.parId === catId) lastChild = r;
      });
      return lastChild.nextSibling;
    }
    return targetRow.nextSibling;
  }

  document.querySelectorAll('tr[data-cat-id]').forEach(function(row) {
    row.setAttribute('draggable', 'true');

    row.addEventListener('dragstart', function(e) {
      dragSrc = row;
      e.dataTransfer.effectAllowed = 'move';
      // Delay so the dragging ghost captures original appearance
      setTimeout(function() {
        subtree(row.parentNode, row).forEach(function(r) { r.classList.add('bgt-dragging'); });
      }, 0);
    });

    row.addEventListener('dragend', function() {
      document.querySelectorAll('.bgt-dragging, .bgt-drag-over').forEach(function(r) {
        r.classList.remove('bgt-dragging', 'bgt-drag-over');
      });
      dragSrc = null;
    });

    row.addEventListener('dragover', function(e) {
      if (!dragSrc || row === dragSrc) return;
      if (groupKey(row) !== groupKey(dragSrc)) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.bgt-drag-over').forEach(function(r) { r.classList.remove('bgt-drag-over'); });
      row.classList.add('bgt-drag-over');
    });

    row.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (!dragSrc || row === dragSrc) return;
      if (groupKey(row) !== groupKey(dragSrc)) return;

      var tbody = row.parentNode;
      var after = e.clientY > row.getBoundingClientRect().top + row.getBoundingClientRect().height / 2;
      var ref = insertionRef(tbody, row, after);
      var tree = subtree(tbody, dragSrc);

      tree.forEach(function(r) { tbody.insertBefore(r, ref || null); });

      // Save new order for this group
      var items = [];
      var idx = 0;
      tbody.querySelectorAll('tr[data-cat-id][data-section="' + dragSrc.dataset.section + '"]').forEach(function(r) {
        if ((r.dataset.parId || '') === (dragSrc.dataset.parId || '')) {
          items.push({ category_id: parseInt(r.dataset.catId), sort_order: idx++ });
        }
      });
      fetch('/api/v1/categories/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items })
      });
    });
  });
})();

(function initGoalDrag() {
  var dragSrc = null;

  document.querySelectorAll('tr[data-goal-id]').forEach(function(row) {
    row.setAttribute('draggable', 'true');

    row.addEventListener('dragstart', function(e) {
      dragSrc = row;
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(function() { row.classList.add('bgt-dragging'); }, 0);
    });

    row.addEventListener('dragend', function() {
      document.querySelectorAll('.bgt-dragging, .bgt-drag-over').forEach(function(r) {
        r.classList.remove('bgt-dragging', 'bgt-drag-over');
      });
      dragSrc = null;
    });

    row.addEventListener('dragover', function(e) {
      if (!dragSrc || row === dragSrc) return;
      if (row.dataset.section !== dragSrc.dataset.section) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.bgt-drag-over').forEach(function(r) { r.classList.remove('bgt-drag-over'); });
      row.classList.add('bgt-drag-over');
    });

    row.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      if (!dragSrc || row === dragSrc) return;
      if (row.dataset.section !== dragSrc.dataset.section) return;

      var tbody = row.parentNode;
      var after = e.clientY > row.getBoundingClientRect().top + row.getBoundingClientRect().height / 2;
      var ref = after ? row.nextSibling : row;
      tbody.insertBefore(dragSrc, ref || null);

      var items = [];
      var idx = 0;
      tbody.querySelectorAll('tr[data-goal-id][data-section="' + dragSrc.dataset.section + '"]').forEach(function(r) {
        items.push({ goal_id: parseInt(r.dataset.goalId), sort_order: idx++ });
      });
      fetch('/api/v1/goals/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items })
      });
    });
  });
})();

(function applyHeatmap() {
  var cells = document.querySelectorAll('td[data-val]');
  for (var i = 0; i < cells.length; i++) {
    var val = parseFloat(cells[i].getAttribute('data-val')) || 0;
    val = Math.abs(val);
    var opacity = 0;
    if      (val >= 50000) opacity = 0.40;
    else if (val >= 15000) opacity = 0.26;
    else if (val >=  5000) opacity = 0.14;
    else if (val >=  1000) opacity = 0.07;
    if (opacity > 0) {
      cells[i].style.backgroundColor = 'rgba(251,191,36,' + opacity + ')';
    }
  }
})();
</script>
{% endif %}
{% endblock %}
