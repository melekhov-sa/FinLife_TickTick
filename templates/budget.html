{% extends "base.html" %}
{% block title %}Бюджет{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}

{% macro plan_cell(cell, link_url=None) -%}
{%- if link_url %}<a href="{{ link_url }}" style="color: inherit; text-decoration: none; border-bottom: 1px dashed #bbb;">{% endif -%}
{%- if cell.plan_manual and cell.plan_planned -%}
<span title="Ручной: {{ fmt(cell.plan_manual) }}, Плановые опер.: {{ fmt(cell.plan_planned) }}">{{ fmt(cell.plan) }}</span>
{%- elif cell.plan_planned and not cell.plan_manual -%}
<span title="Плановые опер.: {{ fmt(cell.plan_planned) }}" style="font-style: italic;">{{ fmt(cell.plan) }}</span>
{%- else -%}
{{ fmt(cell.plan) }}
{%- endif -%}
{%- if link_url %}</a>{% endif -%}
{%- if cell.get('note') %}<span title="{{ cell.get('note') }}" style="cursor: help; font-size: 9px; vertical-align: super; color: #f5a623; margin-left: 1px;">●</span>{% endif -%}
{%- endmacro %}

{% block content %}
<h1>Бюджет</h1>

{% if stub %}
<!-- ============ STUB: no variants ============ -->
<div class="card" style="text-align: center; padding: 40px 20px;">
  <p style="font-size: 18px; margin-bottom: 8px;">Нет вариантов бюджета</p>
  <p style="color: #888; margin-bottom: 20px;">Создайте вариант бюджета, чтобы начать планирование.</p>
  <a href="/budget/variants/new" class="button" style="font-size: 15px;">Создать вариант бюджета</a>
</div>
{% else %}

<!-- Variant header -->
<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
  {% set active_variants = [] %}
  {% for v in all_variants %}{% if not v.is_archived %}{% if active_variants.append(v) %}{% endif %}{% endif %}{% endfor %}
  {% if active_variants|length > 1 %}
  <select id="variant-select" onchange="window.location.href='/budget?variant_id='+this.value"
          style="font-size: 13px; padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc;">
    {% for v in active_variants %}
    <option value="{{ v.id }}" {% if variant.id == v.id %}selected{% endif %}>{{ v.name }}</option>
    {% endfor %}
  </select>
  {% else %}
  <span style="font-size: 14px; font-weight: 600;">{{ variant.name }}</span>
  {% endif %}
  <a href="/budget/variants/new" style="font-size: 12px; color: #007AFF; text-decoration: none;">+ Новый</a>
  {% if active_variants|length > 1 %}
  <form method="POST" action="/budget/variants/{{ variant.id }}/archive" style="display: inline;">
    <button type="submit" onclick="return confirm('Архивировать «{{ variant.name }}»?')"
            style="font-size: 11px; background: none; border: none; color: #999; cursor: pointer; text-decoration: underline;">Архив</button>
  </form>
  {% endif %}
</div>

{% if has_orphans and variant %}
<div style="padding: 8px 12px; margin-bottom: 10px; background: #fffbe6; border-left: 3px solid #f5a623; font-size: 13px; border-radius: 4px;">
  Есть данные без привязки к варианту.
  <form method="POST" action="/budget/variants/{{ variant.id }}/attach" style="display: inline;">
    <button type="submit" style="font-size: 13px; margin-left: 4px; background: none; border: none; color: #007AFF; cursor: pointer; text-decoration: underline;">Привязать</button>
  </form>
</div>
{% endif %}

<!-- Compact controls: nav + grain + period selector — single line -->
<form class="matrix-controls" method="GET" action="/budget" style="margin-bottom: 8px;">
  <input type="hidden" name="grain" value="{{ grain }}">
  <input type="hidden" name="variant_id" value="{{ variant.id }}">
  <a href="{{ prev_url }}" style="text-decoration: none; color: #007AFF; font-size: 16px; padding: 0 4px;">&larr;</a>
  <span style="font-size: 15px; font-weight: 700; white-space: nowrap;">
    {{ view.periods[0].label }}{% if view.periods|length > 1 %} — {{ view.periods[-1].label }}{% endif %}
  </span>
  <a href="{{ next_url }}" style="text-decoration: none; color: #007AFF; font-size: 16px; padding: 0 4px;">&rarr;</a>

  <span style="color: #ccc; margin: 0 2px;">|</span>

  {% for g in grains %}
  <a href="{{ g.url }}" style="padding: 3px 10px; border: 1px solid {% if grain == g.value %}#007AFF{% else %}#ddd{% endif %}; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: 500; {% if grain == g.value %}background: #007AFF; color: white;{% else %}color: #666;{% endif %}">{{ g.label }}</a>
  {% endfor %}

  <span style="color: #ccc; margin: 0 2px;">|</span>

  <input name="range_count" type="number" min="1" max="{{ max_range }}" value="{{ range_count }}" style="width: 46px; font-size: 12px; padding: 3px 4px;">
  {% if grain == "month" %}
  <select name="month" style="font-size: 12px; padding: 3px 4px; max-width: 110px;">
    {% for m in range(1, 13) %}
    <option value="{{ m }}" {% if anchor_month == m %}selected{% endif %}>
      {{ ["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][m-1] }}
    </option>
    {% endfor %}
  </select>
  <input name="year" type="number" value="{{ anchor_year }}" style="width: 58px; font-size: 12px; padding: 3px 4px;">
  {% elif grain == "year" %}
  <input name="year" type="number" value="{{ anchor_year }}" style="width: 58px; font-size: 12px; padding: 3px 4px;">
  {% else %}
  <input name="date" type="date" value="{{ anchor_date }}" style="font-size: 12px; padding: 3px 4px;">
  {% endif %}
  <button type="submit" style="font-size: 12px; padding: 4px 12px;">OK</button>
</form>

<!-- ============ CATEGORY VISIBILITY FILTER ============ -->
<details class="filter-panel" style="margin-bottom: 12px;">
  <summary>
    Фильтр категорий
    {% if hidden_category_ids %}<span style="color: #999; font-size: 12px; margin-left: 4px;">(скрыто: {{ hidden_category_ids|length }})</span>{% endif %}
  </summary>
  <form method="POST" action="/budget/visibility/save" class="filter-body">
    <input type="hidden" name="variant_id" value="{{ variant.id }}">
    <input type="hidden" name="grain" value="{{ grain }}">
    <input type="hidden" name="range_count" value="{{ range_count }}">
    {% if grain in ['day', 'week'] %}
    <input type="hidden" name="date" value="{{ anchor_date }}">
    {% else %}
    <input type="hidden" name="year" value="{{ anchor_year }}">
    <input type="hidden" name="month" value="{{ anchor_month }}">
    {% endif %}

    <div class="filter-actions">
      <button type="button" onclick="toggleAllVisibility(true)">Показать все</button>
      <button type="button" onclick="toggleAllVisibility(false)">Скрыть все</button>
    </div>

    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
      <!-- INCOME -->
      <div style="flex: 1; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Доходы</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for cat in filter_income_cats %}
          <label{% if cat.parent_id %} style="margin-left: 20px;"{% endif %}>
            <input type="checkbox" name="visible_category_id" value="{{ cat.category_id }}"
                   {% if cat.category_id not in hidden_category_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {% if cat.parent_id %}<span style="color: #bbb; margin-right: 2px;">└</span>{% endif %}
            {{ cat.title }}
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- EXPENSE -->
      <div style="flex: 2; min-width: 180px;">
        <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Расходы</div>
        <div class="category-checkboxes" style="flex-direction: column;">
          {% for cat in filter_expense_cats %}
          <label{% if cat.parent_id %} style="margin-left: 20px;"{% endif %}>
            <input type="checkbox" name="visible_category_id" value="{{ cat.category_id }}"
                   {% if cat.category_id not in hidden_category_ids %}checked{% endif %}
                   style="width: auto; max-width: none;">
            {% if cat.parent_id %}<span style="color: #bbb; margin-right: 2px;">└</span>{% endif %}
            {{ cat.title }}
          </label>
          {% endfor %}
        </div>
      </div>
    </div>

    {% if credit_repay_cat %}
    <div style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">
      <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 4px;">Прочее</div>
      <label>
        <input type="checkbox" name="visible_category_id" value="{{ credit_repay_cat.category_id }}"
               {% if credit_repay_cat.category_id not in hidden_category_ids %}checked{% endif %}
               style="width: auto; max-width: none;">
        {{ credit_repay_cat.title }}
      </label>
    </div>
    {% endif %}

    <button type="submit" style="margin-top: 8px; font-size: 13px; padding: 6px 16px;">Применить</button>
  </form>
</details>

<!-- ============ INCOME MATRIX ============ -->
<div class="card">
  <div class="budget-section-title">Доходы</div>
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table">
      <thead>
        <tr>
          <th class="sticky-col">Категория</th>
          {% for p in view.periods %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header">{{ p.short_label }}</th>
          {% endfor %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header total-header">Итого</th>
        </tr>
        {% if show_plan %}
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
          {% endfor %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
        </tr>
        {% endif %}
      </thead>
      <tbody>
        {% for row in view.income_rows %}
        <tr{% if row.is_group %} style="font-weight: 600;"{% endif %}>
          <td class="sticky-col">{% if row.depth > 0 %}<span style="display: inline-block; margin-left: 20px; color: #bbb; margin-right: 4px;">&hairsp;└</span>{% endif %}{{ row.title }}</td>
          {% for cell in row.cells %}
          {% if show_plan %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ view.periods[loop.index0].year ~ "&month=" ~ view.periods[loop.index0].month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          {% endif %}
          <td class="text-right compact-cell {% if show_plan %}{% if cell.deviation > 0 %}positive{% elif cell.deviation < 0 %}negative{% endif %}{% endif %}">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if show_plan %}{% if row.total.deviation > 0 %}positive{% elif row.total.deviation < 0 %}negative{% endif %}{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- Прочие доходы -->
        {% set oi = view.other_income %}
        {% set oi_has_data = oi.total.fact != 0 or oi.total.plan != 0 %}
        {% if oi_has_data %}
        <tr class="muted">
          <td class="sticky-col">Прочие доходы</td>
          {% for cell in oi.cells %}
          {% if show_plan %}<td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>{% endif %}
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(oi.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(oi.total.fact) }}</td>
        </tr>
        {% endif %}
        <!-- ИТОГО доходы -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО доходы</td>
          {% for cell in view.income_totals.cells %}
          {% if show_plan %}<td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>{% endif %}
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.income_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.income_totals.total.fact) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ============ EXPENSE MATRIX ============ -->
<div class="card">
  <div class="budget-section-title">Расходы</div>
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table">
      <thead>
        <tr>
          <th class="sticky-col">Категория</th>
          {% for p in view.periods %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header">{{ p.short_label }}</th>
          {% endfor %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header total-header">Итого</th>
        </tr>
        {% if show_plan %}
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
          {% endfor %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
        </tr>
        {% endif %}
      </thead>
      <tbody>
        {% for row in view.expense_rows %}
        <tr{% if row.is_group %} style="font-weight: 600;"{% endif %}>
          <td class="sticky-col">{% if row.depth > 0 %}<span style="display: inline-block; margin-left: 20px; color: #bbb; margin-right: 4px;">&hairsp;└</span>{% endif %}{{ row.title }}</td>
          {% for cell in row.cells %}
          {% if show_plan %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ row.category_id ~ "&year=" ~ view.periods[loop.index0].year ~ "&month=" ~ view.periods[loop.index0].month ~ "&variant_id=" ~ variant.id ~ "&kind=" ~ row.kind)
            if (grain == "month" and not row.is_group) else None
          ) }}</td>
          {% endif %}
          <td class="text-right compact-cell {% if show_plan %}{% if cell.deviation < 0 %}positive{% elif cell.deviation > 0 %}negative{% endif %}{% endif %}">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if show_plan %}{% if row.total.deviation < 0 %}positive{% elif row.total.deviation > 0 %}negative{% endif %}{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- Прочие расходы -->
        {% set oe = view.other_expense %}
        {% set oe_has_data = oe.total.fact != 0 or oe.total.plan != 0 %}
        {% if oe_has_data %}
        <tr class="muted">
          <td class="sticky-col">Прочие расходы</td>
          {% for cell in oe.cells %}
          {% if show_plan %}<td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>{% endif %}
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(oe.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(oe.total.fact) }}</td>
        </tr>
        {% endif %}
        <!-- ИТОГО расходы -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО расходы</td>
          {% for cell in view.expense_totals.cells %}
          {% if show_plan %}<td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>{% endif %}
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.expense_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.expense_totals.total.fact) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ============ ПОГАШЕНИЕ КРЕДИТОВ ============ -->
{% if view.credit_row %}
<div class="card">
  <div class="budget-section-title">Погашение кредитов</div>
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table">
      <thead>
        <tr>
          <th class="sticky-col">Категория</th>
          {% for p in view.periods %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header">{{ p.short_label }}</th>
          {% endfor %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header total-header">Итого</th>
        </tr>
        {% if show_plan %}
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
          {% endfor %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
        </tr>
        {% endif %}
      </thead>
      <tbody>
        <tr>
          <td class="sticky-col">Погашение кредитов</td>
          {% for cell in view.credit_row.cells %}
          {% if show_plan %}
          <td class="text-right compact-cell muted period-border">{{ plan_cell(cell,
            link_url=("/budget/plan/edit?category_id=" ~ view.credit_row.category_id ~ "&year=" ~ view.periods[loop.index0].year ~ "&month=" ~ view.periods[loop.index0].month ~ "&variant_id=" ~ variant.id ~ "&kind=EXPENSE")
            if grain == "month" else None
          ) }}</td>
          {% endif %}
          <td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}
          <td class="text-right total-cell period-border">{{ plan_cell(view.credit_row.total) }}</td>
          {% endif %}
          <td class="text-right total-cell {% if view.credit_row.total.fact > 0 %}positive{% endif %}">{{ fmt(view.credit_row.total.fact) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- ============ ОТЛОЖИТЬ (savings goals) ============ -->
{% if view.goal_rows %}
<div class="card">
  <div class="budget-section-title">Отложить</div>
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table">
      <thead>
        <tr>
          <th class="sticky-col">Цель</th>
          {% for p in view.periods %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header">{{ p.short_label }}</th>
          {% endfor %}
          <th{% if show_plan %} colspan="2"{% endif %} class="period-header total-header">Итого</th>
        </tr>
        {% if show_plan %}
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
          {% endfor %}
          <th class="sub-header period-border">План</th>
          <th class="sub-header">Факт</th>
        </tr>
        {% endif %}
      </thead>
      <tbody>
        {% for row in view.goal_rows %}
        <tr>
          <td class="sticky-col">
            <a href="/goals/{{ row.goal_id }}" style="color: inherit; text-decoration: none;">{{ row.title }}</a>
          </td>
          {% for cell in row.cells %}
          {% if show_plan %}<td class="text-right compact-cell muted period-border">{{ fmt(cell.plan) }}</td>{% endif %}
          <td class="text-right compact-cell {% if cell.fact > 0 %}positive{% endif %}">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(row.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell {% if row.total.fact > 0 %}positive{% endif %}">{{ fmt(row.total.fact) }}</td>
        </tr>
        {% endfor %}
        <!-- ИТОГО отложить -->
        <tr class="budget-total-row">
          <td class="sticky-col">ИТОГО отложить</td>
          {% for cell in view.goal_totals.cells %}
          {% if show_plan %}<td class="text-right compact-cell period-border">{{ fmt(cell.plan) }}</td>{% endif %}
          <td class="text-right compact-cell">{{ fmt(cell.fact) }}</td>
          {% endfor %}
          {% if show_plan %}<td class="text-right total-cell period-border">{{ fmt(view.goal_totals.total.plan) }}</td>{% endif %}
          <td class="text-right total-cell">{{ fmt(view.goal_totals.total.fact) }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  {% if show_plan and grain == "month" and view.periods|length == 1 %}
  <details style="margin-top: 12px;">
    <summary style="cursor: pointer; font-size: 13px; color: #007AFF;">Изменить план</summary>
    <form method="POST" action="/budget/goals/save" style="margin-top: 8px;">
      <input type="hidden" name="year" value="{{ view.periods[0].year }}">
      <input type="hidden" name="month" value="{{ view.periods[0].month }}">
      <input type="hidden" name="variant_id" value="{{ variant.id }}">
      {% for row in view.goal_rows %}
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
        <input type="hidden" name="goal_id" value="{{ row.goal_id }}">
        <label style="min-width: 120px; font-size: 13px;">{{ row.title }}</label>
        <input name="goal_plan_amount" type="number" step="1" min="0"
               value="{{ row.cells[0].plan|int if row.cells[0].plan else '' }}"
               placeholder="0" style="width: 100px; font-size: 13px;">
      </div>
      {% endfor %}
      <button type="submit" style="margin-top: 4px; font-size: 13px;">Сохранить</button>
    </form>
  </details>
  {% endif %}
</div>
{% endif %}

<!-- ============ RESULT ============ -->
<div class="card">
  <div class="budget-section-title">Результат (доходы &minus; расходы)</div>
  <div class="matrix-scroll-wrapper">
    <table class="budget-table matrix-table">
      <thead>
        <tr>
          <th class="sticky-col"></th>
          {% for p in view.periods %}
          <th class="period-header">{{ p.short_label }}</th>
          {% endfor %}
          <th class="period-header total-header">Итого</th>
        </tr>
      </thead>
      <tbody>
        {% if show_plan %}
        <tr>
          <td class="sticky-col">План</td>
          {% for cell in view.result.cells %}
          <td class="text-right compact-cell period-border {% if cell.plan >= 0 %}positive{% else %}negative{% endif %}">
            {% if cell.plan > 0 %}+{% endif %}{{ fmt(cell.plan) }}
          </td>
          {% endfor %}
          <td class="text-right total-cell period-border {% if view.result.total.plan >= 0 %}positive{% else %}negative{% endif %}">
            {% if view.result.total.plan > 0 %}+{% endif %}{{ fmt(view.result.total.plan) }}
          </td>
        </tr>
        {% endif %}
        <tr>
          <td class="sticky-col">Факт</td>
          {% for cell in view.result.cells %}
          <td class="text-right compact-cell period-border {% if cell.fact >= 0 %}positive{% else %}negative{% endif %}">
            {% if cell.fact > 0 %}+{% endif %}{{ fmt(cell.fact) }}
          </td>
          {% endfor %}
          <td class="text-right total-cell period-border {% if view.result.total.fact >= 0 %}positive{% else %}negative{% endif %}">
            {% if view.result.total.fact > 0 %}+{% endif %}{{ fmt(view.result.total.fact) }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
function toggleAllVisibility(checked) {
  document.querySelectorAll('input[name="visible_category_id"]').forEach(function(cb) {
    cb.checked = checked;
  });
}
</script>
{% endif %}
{% endblock %}
