{% extends "base.html" %}
{% block title %}Статьи (категории) — FinLife{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
  <h1 style="margin: 0;">Статьи (категории)</h1>
</div>

{% if request.query_params.get('error') %}
<div class="error-card">{{ request.query_params.get('error') }}</div>
{% endif %}

<!-- Toolbar: Tabs + Filters + Actions -->
<div class="filter-toolbar" style="padding: 12px; border-radius: 8px; margin-bottom: 16px;">
  <!-- Tabs: Расходы / Доходы -->
  <div style="display: flex; gap: 8px; margin-bottom: 12px;">
    <a href="/categories?kind=expense&status={{ status }}&q={{ q }}"
       style="padding: 6px 16px; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;
              {% if kind == 'expense' %}background: #007AFF; color: white;{% else %}background: white; color: #495057;{% endif %}"
       {% if kind != 'expense' %}class="tab-link-inactive"{% endif %}>
      Расходы
      {% if kind == 'expense' or kind == 'income' %}
        ({{ counts.expense_active }})
      {% endif %}
    </a>
    <a href="/categories?kind=income&status={{ status }}&q={{ q }}"
       style="padding: 6px 16px; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: 500;
              {% if kind == 'income' %}background: #007AFF; color: white;{% else %}background: white; color: #495057;{% endif %}"
       {% if kind != 'income' %}class="tab-link-inactive"{% endif %}>
      Доходы
      {% if kind == 'expense' or kind == 'income' %}
        ({{ counts.income_active }})
      {% endif %}
    </a>
  </div>

  <!-- Filters + Search + Actions -->
  <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
    <!-- Status Filter -->
    <form method="GET" action="/categories" style="display: flex; gap: 8px; align-items: center;">
      <input type="hidden" name="kind" value="{{ kind }}">
      <input type="hidden" name="q" value="{{ q }}">
      <select name="status" onchange="this.form.submit()" style="max-width: 150px; font-size: 13px; padding: 6px;">
        <option value="active" {% if status == 'active' %}selected{% endif %}>Активные</option>
        <option value="archived" {% if status == 'archived' %}selected{% endif %}>Архив</option>
        <option value="all" {% if status == 'all' %}selected{% endif %}>Все</option>
      </select>
    </form>

    <!-- Search -->
    <form method="GET" action="/categories" style="display: flex; gap: 8px; flex: 1;">
      <input type="hidden" name="kind" value="{{ kind }}">
      <input type="hidden" name="status" value="{{ status }}">
      <input type="text" name="q" value="{{ q }}" placeholder="Поиск..." style="max-width: 200px; font-size: 13px;">
      <button type="submit" style="font-size: 13px; padding: 6px 14px;">Найти</button>
      {% if q %}
      <a href="/categories?kind={{ kind }}&status={{ status }}" class="btn secondary" style="font-size: 13px; padding: 6px 14px; text-decoration: none;">Сбросить</a>
      {% endif %}
    </form>

    <!-- Create Button -->
    <a href="/categories/new?kind={{ kind }}" class="btn" style="font-size: 13px; padding: 6px 14px; text-decoration: none; white-space: nowrap;">+ Создать</a>
  </div>
</div>

<!-- Categories Table -->
<div class="card">
  {% if categories %}
  <div class="matrix-scroll-wrapper">
  <table>
    <thead>
      <tr>
        <th>Название</th>
        <th style="width: 200px;">Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for category in categories %}
      <tr>
        <td>
          {% if category.parent_id %}
          <span style="display: inline-block; margin-left: 24px; color: #999; margin-right: 8px;">└─</span>
          {% endif %}
          {{ category.title }}
          {% if category.is_system %}
          <span class="badge" style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 6px;">Системная</span>
          {% endif %}
          {% if status == 'all' and category.is_archived %}
          <span class="badge badge-archive" style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 6px;">Архив</span>
          {% endif %}
        </td>
        <td style="white-space: nowrap;">
          {% if category.is_system %}
            <span class="muted" style="font-size: 12px;" title="Системная категория">—</span>
          {% elif category.is_archived %}
            <a href="/categories/{{ category.category_id }}/confirm-unarchive" class="btn secondary" style="font-size: 12px; padding: 4px 10px; text-decoration: none;">Восстановить</a>
          {% else %}
            <a href="/categories/{{ category.category_id }}/edit" style="font-size: 18px; text-decoration: none; color: #6c757d;" title="Настройки">⚙️</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
  <div style="text-align: center; padding: 32px 16px;">
    <p class="muted" style="margin-bottom: 16px;">
      {% if q %}
        Ничего не найдено по запросу «{{ q }}»
      {% elif status == 'archived' %}
        Нет архивных категорий
      {% else %}
        Нет категорий
      {% endif %}
    </p>
    {% if not q %}
    <a href="/categories/new?kind={{ kind }}" class="btn" style="text-decoration: none;">+ Создать первую категорию</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
