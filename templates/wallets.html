{% extends "base.html" %}
{% block title %}–ö–æ—à–µ–ª—å–∫–∏ - FinLife{% endblock %}

{% block extra_head %}
<style>
@media (max-width: 768px) {
  .col-wtype, .col-wcur, .col-wdelta, .col-wops, .col-wlast { display: none; }
}
/* ‚îÄ‚îÄ Actualize modal ‚îÄ‚îÄ */
.act-backdrop {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.35); align-items: center; justify-content: center;
}
.act-backdrop.act-open { display: flex; }
.act-dialog {
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,.18);
  width: min(360px, calc(100vw - 32px)); padding: 20px 22px;
}
.act-title {
  font-size: 15px; font-weight: 600; margin: 0 0 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.act-close {
  background: none; border: none; cursor: pointer; font-size: 18px;
  color: var(--text-secondary); line-height: 1; padding: 0 2px; min-height: unset;
}
.act-close:hover { color: var(--text-primary); }
.act-field { margin-bottom: 12px; }
.act-field label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.act-field input {
  width: 100%; padding: 8px 10px; font-size: 14px;
  background: var(--bg-page); border: 1px solid var(--border-color);
  border-radius: 8px; color: var(--text-primary); box-sizing: border-box;
}
.act-field input:focus { outline: none; border-color: var(--accent, #4a90d9); }
.act-actions { display: flex; gap: 8px; margin-top: 16px; }
.act-submit {
  flex: 1; padding: 9px 0; font-size: 14px; font-weight: 600;
  background: var(--accent, #4a90d9); color: #fff;
  border: none; border-radius: 10px; cursor: pointer; transition: opacity .15s;
}
.act-submit:hover { opacity: .88; }
.act-cancel {
  padding: 9px 16px; font-size: 14px;
  background: transparent; border: 1px solid var(--border-color);
  border-radius: 10px; cursor: pointer; color: var(--text-secondary); min-height: unset;
}
.act-cancel:hover { background: var(--bg-hover, rgba(128,128,128,.1)); }
.act-current {
  font-size: 13px; color: var(--text-secondary); margin-bottom: 14px;
}
.act-current strong {
  font-size: 16px; color: var(--text-primary);
}
</style>
{% endblock %}
{% block content %}
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
  <h1 style="margin: 0;">–ö–æ—à–µ–ª—å–∫–∏</h1>
  <a href="/wallets/new" class="btn" style="font-size: 13px;">+ –°–æ–∑–¥–∞—Ç—å –∫–æ—à–µ–ª—ë–∫</a>
  <button onclick="toggleNewFolderForm()" class="btn secondary" style="font-size: 13px;">üìÅ + –ü–∞–ø–∫–∞</button>
  <form id="newFolderForm" method="POST" action="/wallets/folders/create"
        style="display:none; gap:8px; align-items:center; flex-wrap:wrap;">
    <input name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏" required style="max-width:160px; font-size:13px;">
    <select name="wallet_type" style="font-size:13px;">
      <option value="REGULAR">–û–±—ã—á–Ω—ã–µ</option>
      <option value="CREDIT">–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ</option>
      <option value="SAVINGS">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</option>
    </select>
    <button type="submit" style="font-size:13px; padding:6px 14px;">–°–æ–∑–¥–∞—Ç—å</button>
    <button type="button" onclick="toggleNewFolderForm()" class="secondary" style="font-size:13px; padding:6px 14px;">–û—Ç–º–µ–Ω–∞</button>
  </form>
</div>

{% set success = request.query_params.get('success') %}
{% if success %}
<div class="card" style="border-color: #2e7d32; background: #e8f5e9; margin-bottom: 16px;">
  <p style="color: #1b5e20; margin: 0;">{{ success }}</p>
</div>
{% endif %}

{% if error %}
  <div class="error-card">{{ error }}</div>
{% endif %}

<!-- Summary cards by wallet type + currency -->
{% set type_labels = {"REGULAR": "–û–±—ã—á–Ω—ã–µ", "CREDIT": "–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ", "SAVINGS": "–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è"} %}
{% if summary %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
  {% for s in summary %}
  {% if s.wallet_type == 'SAVINGS' %}
  <a href="/goals" class="card clarity-mask" style="padding: 16px; text-decoration: none; color: inherit; display: block;">
    <div class="muted" style="font-size: 13px; margin-bottom: 4px;">{{ type_labels.get(s.wallet_type, s.wallet_type) }}{% if s.currency != 'RUB' %} ({{ s.currency }}){% endif %} &rarr;</div>
    <div style="font-size: 20px; font-weight: 600;">{{ format_money2(s.total, s.currency) }}</div>
    <div class="muted" style="font-size: 12px; margin-top: 4px;">{{ s.count }} —à—Ç.</div>
  </a>
  {% else %}
  <div class="card clarity-mask" style="padding: 16px;">
    <div class="muted" style="font-size: 13px; margin-bottom: 4px;">{{ type_labels.get(s.wallet_type, s.wallet_type) }}{% if s.currency != 'RUB' %} ({{ s.currency }}){% endif %}</div>
    <div style="font-size: 20px; font-weight: 600;">{{ format_money2(s.total, s.currency) }}</div>
    <div class="muted" style="font-size: 12px; margin-top: 4px;">{{ s.count }} —à—Ç.</div>
  </div>
  {% endif %}
  {% endfor %}
</div>
{% endif %}

{% set archived_wallet_data = wallet_data | selectattr('wallet.is_archived') | list %}

<div class="card">
  <h2>–ú–æ–∏ –∫–æ—à–µ–ª—å–∫–∏</h2>
  {% if grouped_wallets or ungrouped_wallets %}
    <div class="matrix-scroll-wrapper">
    <table>
      <thead>
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th class="col-wtype">–¢–∏–ø</th>
          <th class="col-wcur">–í–∞–ª—é—Ç–∞</th>
          <th>–ë–∞–ª–∞–Ω—Å</th>
          <th class="col-wdelta">Œî30 –¥–Ω–µ–π</th>
          <th class="col-wops">–û–ø–µ—Ä–∞—Ü–∏–π –∑–∞ 30–¥</th>
          <th class="col-wlast">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è</th>
          <th style="width: 40px;"></th>
        </tr>
      </thead>
      <tbody>

        {# ‚îÄ‚îÄ Grouped wallets ‚îÄ‚îÄ #}
        {% for group in grouped_wallets %}
        {# Folder header row #}
        <tr class="wallet-folder-row">
          <td style="padding: 8px 12px; font-weight: 600; font-size: 13px;">
            üìÅ {{ group.folder.title }}
            <span class="muted" style="font-weight: 400; font-size: 12px; margin-left: 4px;">({{ group.wallets|length }})</span>
          </td>
          <td class="col-wtype muted" style="font-size: 12px;"></td>
          <td class="col-wcur muted" style="font-size: 12px;">{{ group.currency if group.currency else '‚Äî' }}</td>
          <td style="font-weight: 600;" class="{% if group.total_balance is not none %}{% if group.total_balance|float >= 0 %}positive{% else %}negative{% endif %}{% endif %}">
            {% if group.total_balance is not none %}{{ format_money2(group.total_balance, group.currency) }}{% else %}‚Äî{% endif %}
          </td>
          <td class="col-wdelta {% if group.total_delta_30d is not none %}{% if group.total_delta_30d|float > 0 %}positive{% elif group.total_delta_30d|float < 0 %}negative{% endif %}{% endif %}">
            {% if group.total_delta_30d is not none %}{% if group.total_delta_30d|float > 0 %}+{% endif %}{{ format_money2(group.total_delta_30d, group.currency) }}{% else %}‚Äî{% endif %}
          </td>
          <td class="col-wops muted" style="font-size: 12px;">{{ group.total_ops_30d }}</td>
          <td class="col-wlast muted" style="font-size: 12px;">
            {% if group.last_op_at %}{{ group.last_op_at.strftime('%d.%m.%Y %H:%M') }}{% else %}‚Äî{% endif %}
          </td>
          <td>
            <button type="button" class="btn-gear" onclick="toggleRow('folder-settings-{{ group.folder.id }}')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–ø–∫–∏">&#9881;</button>
          </td>
        </tr>
        {# Folder settings row (hidden) #}
        <tr id="folder-settings-{{ group.folder.id }}" style="display: none;">
          <td colspan="8" style="padding: 0;">
            <div class="wallet-settings">
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/folders/{{ group.folder.id }}/rename"
                      style="display: flex; gap: 8px; align-items: center; flex: 1;">
                  <input name="title" value="{{ group.folder.title }}" style="max-width: 250px;" required>
                  <button type="submit" style="font-size: 12px; padding: 4px 12px;">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                </form>
              </div>
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/folders/{{ group.folder.id }}/delete"
                      onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É ¬´{{ group.folder.title }}¬ª?\n–ö–æ—à–µ–ª—å–∫–∏ –ø–µ—Ä–µ–º–µ—Å—Ç—è—Ç—Å—è –≤ ¬´–ë–µ–∑ –ø–∞–ø–∫–∏¬ª.')">
                  <button type="submit" class="danger" style="font-size: 12px; padding: 4px 12px;">–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {# Wallet rows inside folder #}
        {% for wd in group.wallets %}
        {% set wallet = wd.wallet %}
        <tr>
          <td>{{ wallet.title }}</td>
          <td class="col-wtype">
            {% if wallet.wallet_type == 'REGULAR' %}–û–±—ã—á–Ω—ã–π
            {% elif wallet.wallet_type == 'CREDIT' %}–ö—Ä–µ–¥–∏—Ç
            {% elif wallet.wallet_type == 'SAVINGS' %}–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è
            {% else %}{{ wallet.wallet_type }}{% endif %}
          </td>
          <td class="col-wcur">{{ currency_label(wallet.currency) }}</td>
          <td class="{% if wallet.balance|float >= 0 %}positive{% else %}negative{% endif %}">
            {{ format_money2(wallet.balance, wallet.currency) }}
          </td>
          <td class="col-wdelta {% if wd.delta_30d|float > 0 %}positive{% elif wd.delta_30d|float < 0 %}negative{% endif %}">
            {% if wd.delta_30d|float > 0 %}+{% endif %}{{ format_money2(wd.delta_30d, wallet.currency) }}
          </td>
          <td class="col-wops">{{ wd.operations_count_30d }}</td>
          <td class="col-wlast muted" style="font-size: 12px;">
            {% if wallet.last_operation_at %}
              {{ wallet.last_operation_at.strftime('%d.%m.%Y %H:%M') }}
            {% else %}‚Äî{% endif %}
          </td>
          <td>
            <button type="button" class="btn-gear" onclick="toggleSettings({{ wallet.wallet_id }})" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">&#9881;</button>
          </td>
        </tr>
        <tr class="wf{{ group.folder.id }}" id="wallet-settings-{{ wallet.wallet_id }}" style="display: none;">
          <td colspan="8" style="padding: 0;">
            <div class="wallet-settings">
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/rename" style="display: flex; gap: 8px; align-items: center; flex: 1;">
                  <input name="title" value="{{ wallet.title }}" style="max-width: 250px;" required>
                  <button type="submit" style="font-size: 12px; padding: 4px 12px;">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                </form>
              </div>
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/set-folder"
                      style="display: flex; gap: 8px; align-items: center;">
                  <label style="font-size: 13px; font-weight: 500; margin: 0; white-space: nowrap;">–ü–∞–ø–∫–∞:</label>
                  <select name="folder_id" style="max-width: 200px; font-size: 12px;">
                    <option value="0" {% if not wallet.folder_id %}selected{% endif %}>‚Äî –±–µ–∑ –ø–∞–ø–∫–∏ ‚Äî</option>
                    {% for f in folders %}{% if f.wallet_type == wallet.wallet_type %}
                    <option value="{{ f.id }}" {% if wallet.folder_id == f.id %}selected{% endif %}>{{ f.title }}</option>
                    {% endif %}{% endfor %}
                  </select>
                  <button type="submit" style="font-size: 12px; padding: 4px 12px;">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
                </form>
              </div>
              {% if wallet.wallet_type == 'REGULAR' %}
              <div class="wallet-settings-row">
                <button type="button" onclick="openActualize({{ wallet.wallet_id }}, '{{ wallet.balance }}', '{{ wallet.currency }}')"
                        style="font-size: 12px; padding: 4px 12px;">–ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞</button>
              </div>
              {% endif %}
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/archive" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ—à–µ–ª—ë–∫ ¬´{{ wallet.title }}¬ª?')">
                  <button type="submit" class="danger" style="font-size: 12px; padding: 4px 12px;">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% endfor %}

        {# ‚îÄ‚îÄ Ungrouped wallets ‚îÄ‚îÄ #}
        {% if ungrouped_wallets %}
        {% if grouped_wallets %}
        <tr class="wallet-folder-row">
          <td colspan="8" style="padding: 6px 12px; font-size: 12px; color: #999;">–ë–µ–∑ –ø–∞–ø–∫–∏</td>
        </tr>
        {% endif %}
        {% for wd in ungrouped_wallets %}
        {% set wallet = wd.wallet %}
        <tr>
          <td>{{ wallet.title }}</td>
          <td class="col-wtype">
            {% if wallet.wallet_type == 'REGULAR' %}–û–±—ã—á–Ω—ã–π
            {% elif wallet.wallet_type == 'CREDIT' %}–ö—Ä–µ–¥–∏—Ç
            {% elif wallet.wallet_type == 'SAVINGS' %}–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è
            {% else %}{{ wallet.wallet_type }}{% endif %}
          </td>
          <td class="col-wcur">{{ currency_label(wallet.currency) }}</td>
          <td class="{% if wallet.balance|float >= 0 %}positive{% else %}negative{% endif %}">
            {{ format_money2(wallet.balance, wallet.currency) }}
          </td>
          <td class="col-wdelta {% if wd.delta_30d|float > 0 %}positive{% elif wd.delta_30d|float < 0 %}negative{% endif %}">
            {% if wd.delta_30d|float > 0 %}+{% endif %}{{ format_money2(wd.delta_30d, wallet.currency) }}
          </td>
          <td class="col-wops">{{ wd.operations_count_30d }}</td>
          <td class="col-wlast muted" style="font-size: 12px;">
            {% if wallet.last_operation_at %}
              {{ wallet.last_operation_at.strftime('%d.%m.%Y %H:%M') }}
            {% else %}‚Äî{% endif %}
          </td>
          <td>
            <button type="button" class="btn-gear" onclick="toggleSettings({{ wallet.wallet_id }})" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">&#9881;</button>
          </td>
        </tr>
        <tr id="wallet-settings-{{ wallet.wallet_id }}" style="display: none;">
          <td colspan="8" style="padding: 0;">
            <div class="wallet-settings">
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/rename" style="display: flex; gap: 8px; align-items: center; flex: 1;">
                  <input name="title" value="{{ wallet.title }}" style="max-width: 250px;" required>
                  <button type="submit" style="font-size: 12px; padding: 4px 12px;">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                </form>
              </div>
              {% if folders %}
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/set-folder"
                      style="display: flex; gap: 8px; align-items: center;">
                  <label style="font-size: 13px; font-weight: 500; margin: 0; white-space: nowrap;">–ü–∞–ø–∫–∞:</label>
                  <select name="folder_id" style="max-width: 200px; font-size: 12px;">
                    <option value="0" selected>‚Äî –±–µ–∑ –ø–∞–ø–∫–∏ ‚Äî</option>
                    {% for f in folders %}{% if f.wallet_type == wallet.wallet_type %}
                    <option value="{{ f.id }}">{{ f.title }}</option>
                    {% endif %}{% endfor %}
                  </select>
                  <button type="submit" style="font-size: 12px; padding: 4px 12px;">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
                </form>
              </div>
              {% endif %}
              {% if wallet.wallet_type == 'REGULAR' %}
              <div class="wallet-settings-row">
                <button type="button" onclick="openActualize({{ wallet.wallet_id }}, '{{ wallet.balance }}', '{{ wallet.currency }}')"
                        style="font-size: 12px; padding: 4px 12px;">–ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞</button>
              </div>
              {% endif %}
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/archive" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ—à–µ–ª—ë–∫ ¬´{{ wallet.title }}¬ª?')">
                  <button type="submit" class="danger" style="font-size: 12px; padding: 4px 12px;">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% endif %}

      </tbody>
    </table>
    </div>
  {% else %}
    <p class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</p>
  {% endif %}
</div>

{% if archived_wallet_data %}
<div class="card">
  <h2>–ê—Ä—Ö–∏–≤</h2>
  <div class="matrix-scroll-wrapper">
  <table>
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th class="col-wtype">–¢–∏–ø</th>
        <th class="col-wcur">–í–∞–ª—é—Ç–∞</th>
        <th>–ë–∞–ª–∞–Ω—Å</th>
        <th class="col-wdelta">Œî30 –¥–Ω–µ–π</th>
        <th class="col-wops">–û–ø–µ—Ä–∞—Ü–∏–π –∑–∞ 30–¥</th>
        <th class="col-wlast">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è</th>
        <th style="width: 120px;"></th>
      </tr>
    </thead>
    <tbody>
      {% for wd in archived_wallet_data %}
      {% set wallet = wd.wallet %}
      <tr style="opacity: 0.6;">
        <td>{{ wallet.title }}</td>
        <td class="col-wtype">
          {% if wallet.wallet_type == 'REGULAR' %}–û–±—ã—á–Ω—ã–π
          {% elif wallet.wallet_type == 'CREDIT' %}–ö—Ä–µ–¥–∏—Ç
          {% elif wallet.wallet_type == 'SAVINGS' %}–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è
          {% else %}{{ wallet.wallet_type }}{% endif %}
        </td>
        <td class="col-wcur">{{ currency_label(wallet.currency) }}</td>
        <td class="{% if wallet.balance|float >= 0 %}positive{% else %}negative{% endif %}">
          {{ format_money2(wallet.balance, wallet.currency) }}
        </td>
        <td class="col-wdelta {% if wd.delta_30d|float > 0 %}positive{% elif wd.delta_30d|float < 0 %}negative{% endif %}">
          {% if wd.delta_30d|float > 0 %}+{% endif %}{{ format_money2(wd.delta_30d, wallet.currency) }}
        </td>
        <td class="col-wops">{{ wd.operations_count_30d }}</td>
        <td class="col-wlast muted" style="font-size: 12px;">
          {% if wallet.last_operation_at %}
            {{ wallet.last_operation_at.strftime('%d.%m.%Y %H:%M') }}
          {% else %}‚Äî{% endif %}
        </td>
        <td>
          <form method="POST" action="/wallets/{{ wallet.wallet_id }}/unarchive" style="display:inline;">
            <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
{% endif %}

{# ‚îÄ‚îÄ Actualize Balance Modal ‚îÄ‚îÄ #}
<div class="act-backdrop" id="actBackdrop" role="dialog" aria-modal="true">
  <div class="act-dialog">
    <div class="act-title">
      <span>–ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞</span>
      <button class="act-close" type="button" onclick="closeActualize()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&#x2715;</button>
    </div>
    <form method="POST" id="actForm">
      <div class="act-current">
        –¢–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å: <strong id="actCurrentBalance"></strong>
      </div>
      <div class="act-field">
        <label for="actTarget">–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</label>
        <input type="number" name="target_balance" id="actTarget" step="0.01" required autofocus>
      </div>
      <div id="actDeltaHint" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display: none;"></div>
      <div class="act-actions">
        <button type="button" class="act-cancel" onclick="closeActualize()">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="act-submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
function toggleSettings(walletId) {
  var el = document.getElementById('wallet-settings-' + walletId);
  if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
}

function toggleRow(elementId) {
  var el = document.getElementById(elementId);
  if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
}

function toggleNewFolderForm() {
  var form = document.getElementById('newFolderForm');
  var isVisible = form.style.display === 'flex' || form.style.display === '';
  form.style.display = isVisible ? 'none' : 'flex';
  if (!isVisible) form.querySelector('input[name="title"]').focus();
}

/* ‚îÄ‚îÄ Actualize Balance ‚îÄ‚îÄ */
var _actCurrentBalance = 0;
var _actCurrency = 'RUB';

function fmtMoney(amount, currency) {
  var n = Math.abs(Math.round(amount * 100) / 100);
  var parts = n.toFixed(2).split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '\u00a0');
  var sym = currency === 'RUB' ? '\u00a0\u20bd' : '\u00a0' + currency;
  return (amount < 0 ? '\u2212' : '') + parts[0] + ',' + parts[1] + sym;
}

function openActualize(walletId, balance, currency) {
  _actCurrentBalance = parseFloat(balance);
  _actCurrency = currency;
  document.getElementById('actForm').action = '/wallets/' + walletId + '/actualize-balance';
  document.getElementById('actCurrentBalance').textContent = fmtMoney(_actCurrentBalance, currency);
  document.getElementById('actTarget').value = _actCurrentBalance;
  updateDeltaHint();
  document.getElementById('actBackdrop').classList.add('act-open');
  setTimeout(function() { document.getElementById('actTarget').select(); }, 50);
}

function closeActualize() {
  document.getElementById('actBackdrop').classList.remove('act-open');
}

function updateDeltaHint() {
  var target = parseFloat(document.getElementById('actTarget').value);
  var hint = document.getElementById('actDeltaHint');
  if (isNaN(target)) { hint.style.display = 'none'; return; }
  var delta = target - _actCurrentBalance;
  if (Math.abs(delta) < 0.005) {
    hint.textContent = '–ë–∞–ª–∞–Ω—Å —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω';
    hint.style.color = 'var(--text-secondary)';
  } else if (delta > 0) {
    hint.textContent = '–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–æ—Ö–æ–¥ –Ω–∞ ' + fmtMoney(delta, _actCurrency);
    hint.style.color = '#2e7d32';
  } else {
    hint.textContent = '–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ä–∞—Å—Ö–æ–¥ –Ω–∞ ' + fmtMoney(Math.abs(delta), _actCurrency);
    hint.style.color = '#c62828';
  }
  hint.style.display = 'block';
}

document.getElementById('actTarget').addEventListener('input', updateDeltaHint);

document.getElementById('actBackdrop').addEventListener('click', function(e) {
  if (e.target === this) closeActualize();
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('actBackdrop').classList.contains('act-open')) {
    closeActualize();
  }
});
</script>
{% endblock %}
