{% extends "base.html" %}
{% block title %}Кошельки - FinLife{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
  <h1 style="margin: 0;">Кошельки</h1>
  <a href="/wallets/new" class="btn" style="font-size: 13px;">+ Создать кошелёк</a>
</div>

{% if error %}
  <div class="error-card">{{ error }}</div>
{% endif %}

<!-- Summary cards by wallet type + currency -->
{% set type_labels = {"REGULAR": "Обычные", "CREDIT": "Кредитные", "SAVINGS": "Накопления"} %}
{% if summary %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
  {% for s in summary %}
  {% if s.wallet_type == 'SAVINGS' %}
  <a href="/goals" class="card" style="padding: 16px; text-decoration: none; color: inherit; display: block;">
    <div class="muted" style="font-size: 13px; margin-bottom: 4px;">{{ type_labels.get(s.wallet_type, s.wallet_type) }}{% if s.currency != 'RUB' %} ({{ s.currency }}){% endif %} &rarr;</div>
    <div style="font-size: 20px; font-weight: 600;">{{ format_money2(s.total, s.currency) }}</div>
    <div class="muted" style="font-size: 12px; margin-top: 4px;">{{ s.count }} шт.</div>
  </a>
  {% else %}
  <div class="card" style="padding: 16px;">
    <div class="muted" style="font-size: 13px; margin-bottom: 4px;">{{ type_labels.get(s.wallet_type, s.wallet_type) }}{% if s.currency != 'RUB' %} ({{ s.currency }}){% endif %}</div>
    <div style="font-size: 20px; font-weight: 600;">{{ format_money2(s.total, s.currency) }}</div>
    <div class="muted" style="font-size: 12px; margin-top: 4px;">{{ s.count }} шт.</div>
  </div>
  {% endif %}
  {% endfor %}
</div>
{% endif %}

{% set active_wallet_data = wallet_data | rejectattr('wallet.is_archived') | list %}
{% set archived_wallet_data = wallet_data | selectattr('wallet.is_archived') | list %}

<div class="card">
  <h2>Мои кошельки</h2>
  {% if active_wallet_data %}
    <div class="matrix-scroll-wrapper">
    <table>
      <thead>
        <tr>
          <th>Название</th>
          <th>Тип</th>
          <th>Валюта</th>
          <th>Баланс</th>
          <th>Δ30 дней</th>
          <th>Операций за 30д</th>
          <th>Последняя операция</th>
          <th style="width: 40px;"></th>
        </tr>
      </thead>
      <tbody>
        {% for wd in active_wallet_data %}
        {% set wallet = wd.wallet %}
        <tr>
          <td>{{ wallet.title }}</td>
          <td>
            {% if wallet.wallet_type == 'REGULAR' %}Обычный
            {% elif wallet.wallet_type == 'CREDIT' %}Кредит
            {% elif wallet.wallet_type == 'SAVINGS' %}Накопления
            {% else %}{{ wallet.wallet_type }}{% endif %}
          </td>
          <td>{{ currency_label(wallet.currency) }}</td>
          <td class="{% if wallet.balance|float >= 0 %}positive{% else %}negative{% endif %}">
            {{ format_money2(wallet.balance, wallet.currency) }}
          </td>
          <td class="{% if wd.delta_30d|float > 0 %}positive{% elif wd.delta_30d|float < 0 %}negative{% endif %}">
            {% if wd.delta_30d|float > 0 %}+{% endif %}{{ format_money2(wd.delta_30d, wallet.currency) }}
          </td>
          <td>{{ wd.operations_count_30d }}</td>
          <td class="muted" style="font-size: 12px;">
            {% if wallet.last_operation_at %}
              {{ wallet.last_operation_at.strftime('%d.%m.%Y %H:%M') }}
            {% else %}—{% endif %}
          </td>
          <td>
            <button type="button" class="btn-gear" onclick="toggleSettings({{ wallet.wallet_id }})" title="Настройки">&#9881;</button>
          </td>
        </tr>
        <tr id="wallet-settings-{{ wallet.wallet_id }}" style="display: none;">
          <td colspan="8" style="padding: 0;">
            <div class="wallet-settings">
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/rename" style="display: flex; gap: 8px; align-items: center; flex: 1;">
                  <input name="title" value="{{ wallet.title }}" style="max-width: 250px;" required>
                  <button type="submit" style="font-size: 12px; padding: 4px 12px;">Переименовать</button>
                </form>
              </div>
              <div class="wallet-settings-row">
                <form method="POST" action="/wallets/{{ wallet.wallet_id }}/archive" onsubmit="return confirm('Вы уверены, что хотите архивировать кошелёк «{{ wallet.title }}»?')">
                  <button type="submit" class="danger" style="font-size: 12px; padding: 4px 12px;">Архивировать</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  {% else %}
    <p class="muted">Нет активных кошельков</p>
  {% endif %}
</div>

{% if archived_wallet_data %}
<div class="card">
  <h2>Архив</h2>
  <div class="matrix-scroll-wrapper">
  <table>
    <thead>
      <tr>
        <th>Название</th>
        <th>Тип</th>
        <th>Валюта</th>
        <th>Баланс</th>
        <th>Δ30 дней</th>
        <th>Операций за 30д</th>
        <th>Последняя операция</th>
        <th style="width: 120px;"></th>
      </tr>
    </thead>
    <tbody>
      {% for wd in archived_wallet_data %}
      {% set wallet = wd.wallet %}
      <tr style="opacity: 0.6;">
        <td>{{ wallet.title }}</td>
        <td>
          {% if wallet.wallet_type == 'REGULAR' %}Обычный
          {% elif wallet.wallet_type == 'CREDIT' %}Кредит
          {% elif wallet.wallet_type == 'SAVINGS' %}Накопления
          {% else %}{{ wallet.wallet_type }}{% endif %}
        </td>
        <td>{{ currency_label(wallet.currency) }}</td>
        <td class="{% if wallet.balance|float >= 0 %}positive{% else %}negative{% endif %}">
          {{ format_money2(wallet.balance, wallet.currency) }}
        </td>
        <td class="{% if wd.delta_30d|float > 0 %}positive{% elif wd.delta_30d|float < 0 %}negative{% endif %}">
          {% if wd.delta_30d|float > 0 %}+{% endif %}{{ format_money2(wd.delta_30d, wallet.currency) }}
        </td>
        <td>{{ wd.operations_count_30d }}</td>
        <td class="muted" style="font-size: 12px;">
          {% if wallet.last_operation_at %}
            {{ wallet.last_operation_at.strftime('%d.%m.%Y %H:%M') }}
          {% else %}—{% endif %}
        </td>
        <td>
          <form method="POST" action="/wallets/{{ wallet.wallet_id }}/unarchive" style="display:inline;">
            <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">Восстановить</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
{% endif %}

<script>
function toggleSettings(walletId) {
  var el = document.getElementById('wallet-settings-' + walletId);
  el.style.display = el.style.display === 'none' ? '' : 'none';
}
</script>
{% endblock %}
