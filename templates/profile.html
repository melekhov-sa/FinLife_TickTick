{% extends "base.html" %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî FinLife{% endblock %}

{% block content %}
<style>
  .profile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    max-width: 860px;
    margin-bottom: 24px;
  }
  @media (max-width: 640px) {
    .profile-grid { grid-template-columns: 1fr; }
    .profile-grid > .card { grid-column: 1 !important; }
    .xp-event-date { min-width: 80px; font-size: 11px; }
    .activity-label { min-width: 100px; }
    .profile-meta-row { flex-direction: column; gap: 2px; }
  }

  /* ‚îÄ‚îÄ XP bar ‚îÄ‚îÄ */
  .xp-bar-track {
    background: var(--border-color, #e9ecef);
    border-radius: 6px; height: 8px; overflow: hidden; margin: 8px 0 6px;
  }
  .xp-bar-fill { background: var(--accent, #007AFF); height: 100%; border-radius: 6px; }

  /* ‚îÄ‚îÄ XP stats ‚îÄ‚îÄ */
  .xp-stat-row {
    display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px;
    margin-top: 12px; padding-top: 12px;
    border-top: 1px solid var(--border-color, #f0f0f0);
  }
  .xp-stat-item { display: flex; flex-direction: column; gap: 2px; }
  .xp-stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; color: var(--text-secondary, #888); font-weight: 600; }
  .xp-stat-val { font-size: 15px; font-weight: 700; }

  /* ‚îÄ‚îÄ Meta rows ‚îÄ‚îÄ */
  .profile-meta-row {
    display: flex; justify-content: space-between; align-items: baseline;
    padding: 7px 0; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 14px;
  }
  .profile-meta-row:last-child { border-bottom: none; }
  .profile-meta-label { color: var(--text-secondary, #888); font-size: 13px; }
  .profile-meta-val { font-weight: 600; }

  /* ‚îÄ‚îÄ XP event rows ‚îÄ‚îÄ */
  .xp-event-row {
    display: flex; align-items: baseline; gap: 12px;
    padding: 7px 0; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 13px;
  }
  .xp-event-row:last-child { border-bottom: none; }
  .xp-event-date { color: var(--text-secondary, #888); white-space: nowrap; min-width: 118px; font-size: 12px; font-variant-numeric: tabular-nums; }
  .xp-event-desc { flex: 1; }
  .xp-event-amount { font-weight: 700; color: var(--accent, #007AFF); white-space: nowrap; }

  /* ‚îÄ‚îÄ Activity ‚îÄ‚îÄ */
  .activity-row {
    display: flex; align-items: baseline; gap: 8px;
    padding: 5px 0; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 13px;
  }
  .activity-row:last-child { border-bottom: none; }
  .activity-label { color: var(--text-secondary, #888); font-size: 12px; min-width: 140px; }
  .activity-val { font-weight: 600; }
  .activity-index-bar-track { background: var(--border-color, #e9ecef); border-radius: 6px; height: 8px; overflow: hidden; margin: 6px 0 4px; flex: 1; min-width: 80px; }
  .activity-index-bar-fill { background: #34c759; height: 100%; border-radius: 6px; transition: width 0.3s; }
  .trend-up { color: #34c759; font-weight: 700; }
  .trend-down { color: #ff3b30; font-weight: 700; }
  .trend-flat { color: var(--text-secondary, #888); }

  /* ‚îÄ‚îÄ XP analytics table ‚îÄ‚îÄ */
  .xp-analytics-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .xp-analytics-table th { padding: 4px 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary, #888); font-weight: 600; border-bottom: 1px solid var(--border-color, #eee); text-align: left; }
  .xp-analytics-table td { padding: 3px 8px; border-bottom: 1px solid var(--border-color, #f4f4f4); }
  .xp-analytics-table .xp-zero td { color: var(--text-secondary, #bbb); opacity: 0.5; }
  .xp-analytics-table .xp-pos { font-weight: 700; color: var(--accent, #007AFF); }
  .xp-analytics-table .xp-total-row td { font-weight: 700; border-top: 2px solid var(--border-color, #ddd); border-bottom: none; padding-top: 6px; }

  /* ‚îÄ‚îÄ XP earn list ‚îÄ‚îÄ */
  .xp-earn-list { list-style: none; margin: 0; padding: 0; }
  .xp-earn-list li { display: flex; align-items: baseline; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 13px; }
  .xp-earn-list li:last-child { border-bottom: none; }
  .xp-earn-amount { font-weight: 700; color: var(--accent, #007AFF); min-width: 64px; white-space: nowrap; }

  /* ‚îÄ‚îÄ Settings section ‚îÄ‚îÄ */
  .profile-settings { max-width: 860px; display: flex; flex-direction: column; gap: 12px; }
  .profile-section-title {
    font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-secondary, #888); margin: 8px 0 4px;
  }
  .setting-row {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 12px 0; border-bottom: 1px solid var(--border-color, #f0f0f0);
  }
  .setting-row:last-child { border-bottom: none; padding-bottom: 0; }
  .setting-row input[type="checkbox"] { margin-top: 2px; flex-shrink: 0; }
  .setting-body { flex: 1; }
  .setting-label { font-size: 13px; font-weight: 500; }
  .setting-desc { font-size: 12px; color: var(--text-secondary, #888); margin-top: 3px; }

  /* ‚îÄ‚îÄ Theme picker ‚îÄ‚îÄ */
  .theme-card {
    border: 2px solid var(--border-color);
    border-radius: 10px; padding: 12px; width: 160px;
    cursor: pointer; transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s; user-select: none;
  }
  .theme-card:hover { transform: translateY(-2px); }
  .theme-card-active { border-color: var(--accent) !important; box-shadow: 0 0 0 1px var(--accent); }
  @media (max-width: 640px) {
    .theme-card { width: calc(50% - 6px); }
    .profile-settings { gap: 8px; }
  }
</style>

<h1 style="margin-bottom: 20px;">–ü—Ä–æ—Ñ–∏–ª—å</h1>

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS GRID ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
<div class="profile-grid">

  {# ‚îÄ‚îÄ –ê–∫–∫–∞—É–Ω—Ç ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 12px;">–ê–∫–∫–∞—É–Ω—Ç</div>
    <div class="profile-meta-row">
      <span class="profile-meta-label">E-mail</span>
      <span class="profile-meta-val">{{ email }}</span>
    </div>
    <div class="profile-meta-row">
      <span class="profile-meta-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
      <span class="profile-meta-val">{{ registration_date }}</span>
    </div>
    <div class="profile-meta-row">
      <span class="profile-meta-label">–î–Ω–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</span>
      <span class="profile-meta-val">{{ days_in_system }}</span>
    </div>
  </div>

  {# ‚îÄ‚îÄ –£—Ä–æ–≤–µ–Ω—å XP ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 12px;">–£—Ä–æ–≤–µ–Ω—å</div>
    <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 2px;">
      <span style="font-size: 26px; font-weight: 800; line-height: 1;">{{ xp.level }}</span>
      <span style="font-size: 14px; color: var(--text-secondary);">{{ level_title }}</span>
    </div>
    <div style="font-size: 12px; color: var(--text-secondary);">XP: {{ xp.current_level_xp }} / {{ xp.current_level_xp + xp.xp_to_next_level }}</div>
    <div class="xp-bar-track">
      <div class="xp-bar-fill" style="width: {{ xp.percent_progress }}%;"></div>
    </div>
    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: {{ xp.xp_to_next_level }} XP</div>
    <div class="xp-stat-row">
      <div class="xp-stat-item">
        <span class="xp-stat-label">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</span>
        <span class="xp-stat-val">{{ xp.xp_this_month }} XP</span>
      </div>
      <div class="xp-stat-item">
        <span class="xp-stat-label">–í—Å–µ–≥–æ</span>
        <span class="xp-stat-val">{{ xp.total_xp }} XP</span>
      </div>
      <div class="xp-stat-item">
        <span class="xp-stat-label">–†–µ–∫–æ—Ä–¥</span>
        <span class="xp-stat-val">{{ xp.xp_record_month }} XP</span>
      </div>
    </div>
  </div>

  {# ‚îÄ‚îÄ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / -1;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 12px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
      <span style="font-size: 28px; font-weight: 800; line-height: 1;">{{ activity.activity_index }}</span>
      <span style="font-size: 15px; color: var(--text-secondary);">/ 100</span>
      <div class="activity-index-bar-track">
        <div class="activity-index-bar-fill" style="width: {{ activity.activity_index }}%;"></div>
      </div>
    </div>
    <div style="font-size: 13px; margin-bottom: 12px;">
      {% if activity.trend_delta > 0 %}
      <span class="trend-up">‚ñ≤ +{{ activity.trend_delta }}</span> –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
      {% elif activity.trend_delta < 0 %}
      <span class="trend-down">‚ñº {{ activity.trend_delta }}</span> –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
      {% else %}
      <span class="trend-flat">‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span> –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
      {% endif %}
    </div>
    <div class="activity-row">
      <span class="activity-label">7 –¥–Ω–µ–π / –ø—Ä–µ–¥. 7 –¥–Ω–µ–π</span>
      <span class="activity-val">{{ activity.points_7d }} –æ—á–∫–æ–≤</span>
      <span class="muted" style="font-size: 12px;">/ {{ activity.points_prev_7d }} –æ—á–∫–æ–≤</span>
    </div>
    <div class="activity-row">
      <span class="activity-label">30 –¥–Ω–µ–π / –≤ —Å—Ä–µ–¥–Ω–µ–º</span>
      <span class="activity-val">{{ activity.points_30d_total }} –æ—á–∫–æ–≤</span>
      <span class="muted" style="font-size: 12px;">/ {{ activity.points_30d_avg }} –≤ –¥–µ–Ω—å</span>
    </div>
    {% if activity.best_day_date_30d %}
    <div class="activity-row">
      <span class="activity-label">–õ—É—á—à–∏–π –¥–µ–Ω—å (30 –¥–Ω–µ–π)</span>
      <span class="activity-val">{{ activity.best_day_date_30d }} ‚Äî {{ activity.best_day_points_30d }} –æ—á–∫–æ–≤</span>
    </div>
    {% endif %}
  </div>

  {# ‚îÄ‚îÄ –ü–æ—Å–ª–µ–¥–Ω–∏–µ XP-—Å–æ–±—ã—Ç–∏—è ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / -1;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
      <span style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary);">–ü–æ—Å–ª–µ–¥–Ω–∏–µ XP-—Å–æ–±—ã—Ç–∏—è</span>
      <a href="/profile/xp-history" style="font-size: 12px; color: var(--accent, #007AFF); text-decoration: none;">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é ‚Üí</a>
    </div>
    {% if recent_xp_events %}
      {% for ev in recent_xp_events %}
      <div class="xp-event-row">
        <span class="xp-event-date">{{ ev.created_at }}</span>
        <span class="xp-event-desc">{{ ev.description }}</span>
        <span class="xp-event-amount">+{{ ev.xp_amount }} XP</span>
      </div>
      {% endfor %}
    {% else %}
      <div class="muted" style="font-size: 13px; padding: 8px 0;">XP-—Å–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ó–∞–∫—Ä–æ–π—Ç–µ –∑–∞–¥–∞—á—É –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É!</div>
    {% endif %}
  </div>

  {# ‚îÄ‚îÄ XP –ø–æ –¥–Ω—è–º ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 12px;">XP –ø–æ –¥–Ω—è–º ‚Äî {{ current_month_label }}</div>
    <div style="overflow-y: auto; max-height: 300px;">
      <table class="xp-analytics-table">
        <thead><tr><th>–î–∞—Ç–∞</th><th style="text-align: right;">XP</th></tr></thead>
        <tbody>
          {% for d in daily_xp %}
          <tr class="{% if d.xp == 0 %}xp-zero{% endif %}">
            <td>{{ d.date_str }}</td>
            <td style="text-align: right;" class="{% if d.xp > 0 %}xp-pos{% endif %}">
              {% if d.xp > 0 %}+{{ d.xp }}{% else %}‚Äî{% endif %}
            </td>
          </tr>
          {% endfor %}
          <tr class="xp-total-row">
            <td>–ò—Ç–æ–≥–æ</td>
            <td style="text-align: right;" class="xp-pos">+{{ daily_xp_total }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  {# ‚îÄ‚îÄ –î–∏–Ω–∞–º–∏–∫–∞ XP –ø–æ –º–µ—Å—è—Ü–∞–º ‚îÄ‚îÄ #}
  <div class="card" style="align-self: start;">
    <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞ XP –ø–æ –º–µ—Å—è—Ü–∞–º</div>
    <table class="xp-analytics-table">
      <thead><tr><th>–ú–µ—Å—è—Ü</th><th style="text-align: right;">XP</th></tr></thead>
      <tbody>
        {% for mo in monthly_xp %}
        <tr class="{% if mo.xp == 0 %}xp-zero{% endif %}">
          <td>{{ mo.month_name }} {{ mo.year }}</td>
          <td style="text-align: right;" class="{% if mo.xp > 0 %}xp-pos{% endif %}">
            {% if mo.xp > 0 %}+{{ mo.xp }}{% else %}‚Äî{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>{# ‚îÄ‚îÄ end profile-grid ‚îÄ‚îÄ #}


{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
<div class="profile-settings">

  <div class="profile-section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

  {# ‚îÄ‚îÄ –ü—Ä–µ—Å–µ—Ç—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 14px; font-weight: 600; margin-bottom: 14px;">–ü—Ä–µ—Å–µ—Ç—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</div>
    {% if reminder_presets %}
    <table style="margin-bottom: 14px; width: 100%;">
      <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°–º–µ—â–µ–Ω–∏–µ</th><th style="width: 40px;"></th></tr></thead>
      <tbody>
        {% for p in reminder_presets %}
        <tr>
          <td>{{ p.label }}</td>
          <td class="muted" style="font-size: 13px;">{{ p.offset_minutes }} –º–∏–Ω</td>
          <td>
            <form method="POST" action="/profile/reminder-presets/{{ p.id }}/delete" style="display:inline;">
              <button type="submit" class="danger" style="font-size: 11px; padding: 2px 8px; min-height: unset;">√ó</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="muted" style="margin-bottom: 12px; font-size: 13px;">–ù–µ—Ç –ø—Ä–µ—Å–µ—Ç–æ–≤</p>
    {% endif %}
    <details>
      <summary class="muted" style="cursor: pointer; font-size: 13px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ—Å–µ—Ç</summary>
      <form method="POST" action="/profile/reminder-presets/create" style="margin-top: 10px;">
        <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 140px;">
            <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input name="label" placeholder="–ù–∞–ø—Ä.: –ó–∞ 2 —á–∞—Å–∞" required style="font-size: 13px;">
          </div>
          <div style="width: 130px;">
            <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">–ú–∏–Ω—É—Ç –¥–æ</label>
            <input name="offset_minutes" type="number" max="0" step="1" placeholder="-120" required style="font-size: 13px;">
          </div>
          <button type="submit" style="font-size: 12px; padding: 6px 14px; min-height: unset;">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </details>
  </div>

  {# ‚îÄ‚îÄ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚îÄ‚îÄ #}
  {% if vapid_public_key %}
  <div class="card">
    <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <p class="muted" style="font-size: 13px; margin-bottom: 12px;">
      –ü–æ–ª—É—á–∞–π—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–¥–∞—á–∞—Ö –∏ —Å–æ–±—ã—Ç–∏—è—Ö –ø—Ä—è–º–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –ù–∞ iOS: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Safari ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª.
    </p>
    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
      <button id="pushToggleBtn" type="button" onclick="finlifePush.toggle()" style="font-size: 13px; padding: 7px 16px; min-height: unset;">
        –í–∫–ª—é—á–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      </button>
      <button type="button" onclick="finlifePush.sendTest()" class="secondary" style="font-size: 12px; padding: 5px 12px; min-height: unset;">–¢–µ—Å—Ç</button>
      <span id="pushStatus" class="muted" style="font-size: 12px;"></span>
    </div>
    <div style="margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--border-color);">
      <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞</div>
      <form method="post" action="/profile/digest" id="digestForm">
        <div class="setting-row" style="padding: 6px 0;">
          <input type="checkbox" name="digest_morning" value="true"
                 {% if digest_morning %}checked{% endif %}
                 onchange="document.getElementById('digestForm').submit()">
          <div class="setting-body">
            <div class="setting-label">–£—Ç—Ä–µ–Ω–Ω—è—è —Å–≤–æ–¥–∫–∞ (08:00) ‚Äî –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å</div>
          </div>
        </div>
        <div class="setting-row" style="padding: 6px 0; border-bottom: none;">
          <input type="checkbox" name="digest_evening" value="true"
                 {% if digest_evening %}checked{% endif %}
                 onchange="document.getElementById('digestForm').submit()">
          <div class="setting-body">
            <div class="setting-label">–í–µ—á–µ—Ä–Ω—è—è —Å–≤–æ–¥–∫–∞ (21:00) ‚Äî –∏—Ç–æ–≥–∏ –¥–Ω—è</div>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  {# ‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—á (consolidated) ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 14px; font-weight: 600; margin-bottom: 14px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—á</div>

    <form method="post" action="/profile/task-expense-setting" id="taskExpenseForm">
      <div class="setting-row">
        <input type="checkbox" name="enable_task_expense_link" value="true"
               {% if enable_task_expense_link %}checked{% endif %}
               onchange="document.getElementById('taskExpenseForm').submit()">
        <div class="setting-body">
          <div class="setting-label">–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é</div>
          <div class="setting-desc">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –≤ –∑–∞–¥–∞—á–∞—Ö –ø–æ—è–≤–∏—Ç—Å—è –æ–ø—Ü–∏—è –ø—Ä–∏–≤—è–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–∞. –ó–∞–¥–∞—á—É —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –Ω–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.</div>
        </div>
      </div>
    </form>

    <form method="post" action="/profile/task-templates-setting" id="taskTemplatesForm">
      <div class="setting-row">
        <input type="checkbox" name="enable_task_templates" value="true"
               {% if enable_task_templates %}checked{% endif %}
               onchange="document.getElementById('taskTemplatesForm').submit()">
        <div class="setting-body">
          <div class="setting-label">–í–∫–ª—é—á–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –∑–∞–¥–∞—á</div>
          <div class="setting-desc">–í —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á –ø–æ—è–≤–∏—Ç—Å—è –≤—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π.</div>
          {% if enable_task_templates %}
          <a href="/task-presets" style="font-size: 12px; margin-top: 4px; display: inline-block;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ ‚Üí</a>
          {% endif %}
        </div>
      </div>
    </form>

    <form method="post" action="/profile/reschedule-reasons-setting" id="rescheduleReasonsForm">
      <div class="setting-row">
        <input type="checkbox" name="enable_task_reschedule_reasons" value="true"
               {% if enable_task_reschedule_reasons %}checked{% endif %}
               onchange="document.getElementById('rescheduleReasonsForm').submit()">
        <div class="setting-body">
          <div class="setting-label">–¢—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–¥–∞—á</div>
          <div class="setting-desc">–ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.</div>
          {% if enable_task_reschedule_reasons %}
          <a href="/task-reschedule-reasons" style="font-size: 12px; margin-top: 4px; display: inline-block;">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–∏—á–∏–Ω ‚Üí</a>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

  {# ‚îÄ‚îÄ –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å XP ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å XP</div>
    <ul class="xp-earn-list">
      <li><span class="xp-earn-amount">+10 XP</span><span>–∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏</span></li>
      <li><span class="xp-earn-amount">+2 XP</span><span>–±–æ–Ω—É—Å –∑–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–¥–æ —Å—Ä–æ–∫–∞)</span></li>
      <li><span class="xp-earn-amount">+3 XP</span><span>–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏</span></li>
      <li><span class="xp-earn-amount">+200 XP</span><span>–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –¥–µ–Ω–µ–∂–Ω–æ–π —Ü–µ–ª–∏</span></li>
      <li><span class="xp-earn-amount">+5 XP</span><span>–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span></li>
    </ul>
  </div>

  {# ‚îÄ‚îÄ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-size: 14px; font-weight: 600; margin-bottom: 16px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
    <form method="POST" action="/profile/save-theme">
      <input type="hidden" name="theme" id="selectedTheme" value="{{ current_theme }}">

      <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); margin-bottom: 10px;">–¢–µ–º–∞</div>
      <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px;">

        <div class="theme-card{% if theme_base == 'graphite-emerald' %} theme-card-active{% endif %}"
             data-base="graphite-emerald" onclick="pickThemeBase('graphite-emerald')">
          <div style="display: flex; height: 56px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);">
            <div style="width: 38%; background: #1E3A3F;"></div>
            <div style="flex: 1; background: #F6F8FB; padding: 5px 4px;">
              <div style="height: 5px; background: #1E7F4F; border-radius: 2px; margin-bottom: 4px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.12); border-radius: 2px; margin-bottom: 3px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.07); border-radius: 2px;"></div>
            </div>
          </div>
          <div style="font-size: 13px; font-weight: 600;">–°—Ç—Ä–æ–≥–∏–π Fintech</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">graphite-emerald</div>
        </div>

        <div class="theme-card{% if theme_base == 'deep-blue' %} theme-card-active{% endif %}"
             data-base="deep-blue" onclick="pickThemeBase('deep-blue')">
          <div style="display: flex; height: 56px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);">
            <div style="width: 38%; background: #1E3A5F;"></div>
            <div style="flex: 1; background: #EEF2FF; padding: 5px 4px;">
              <div style="height: 5px; background: #1D4ED8; border-radius: 2px; margin-bottom: 4px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.12); border-radius: 2px; margin-bottom: 3px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.07); border-radius: 2px;"></div>
            </div>
          </div>
          <div style="font-size: 13px; font-weight: 600;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–∏–Ω–∏–π</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">deep-blue</div>
        </div>

        <div class="theme-card{% if theme_base == 'architect-neutral' %} theme-card-active{% endif %}"
             data-base="architect-neutral" onclick="pickThemeBase('architect-neutral')">
          <div style="display: flex; height: 56px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);">
            <div style="width: 38%; background: #292524;"></div>
            <div style="flex: 1; background: #FAF9F7; padding: 5px 4px;">
              <div style="height: 5px; background: #92400E; border-radius: 2px; margin-bottom: 4px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.12); border-radius: 2px; margin-bottom: 3px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.07); border-radius: 2px;"></div>
            </div>
          </div>
          <div style="font-size: 13px; font-weight: 600;">–¢—ë–ø–ª—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">architect-neutral</div>
        </div>

      </div>

      <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); margin-bottom: 10px;">–†–µ–∂–∏–º</div>
      <div style="display: flex; gap: 8px; margin-bottom: 20px;">
        <button type="button" id="modeBtnLight" onclick="pickThemeMode('light')"
                style="font-size: 13px; padding: 6px 16px; min-height: unset;{% if theme_mode != 'light' %} background: var(--bg-table-header); color: var(--text-primary);{% endif %}">
          ‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è
        </button>
        <button type="button" id="modeBtnDark" onclick="pickThemeMode('dark')"
                style="font-size: 13px; padding: 6px 16px; min-height: unset;{% if theme_mode != 'dark' %} background: var(--bg-table-header); color: var(--text-primary);{% endif %}">
          üåô –¢—ë–º–Ω–∞—è
        </button>
      </div>

      <button type="submit" style="font-size: 14px; padding: 8px 24px; min-height: unset;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</button>
    </form>
  </div>

</div>{# ‚îÄ‚îÄ end profile-settings ‚îÄ‚îÄ #}

<script>
(function() {
  var _cb = '{{ theme_base }}';
  var _cm = '{{ theme_mode }}';

  function _updateHidden() {
    var inp = document.getElementById('selectedTheme');
    if (inp) inp.value = _cb + '-' + _cm;
  }

  function _syncModeButtons() {
    var lBtn = document.getElementById('modeBtnLight');
    var dBtn = document.getElementById('modeBtnDark');
    if (!lBtn || !dBtn) return;
    var isDark = _cm === 'dark';
    lBtn.style.background = !isDark ? '' : 'var(--bg-table-header)';
    lBtn.style.color = !isDark ? '' : 'var(--text-primary)';
    dBtn.style.background = isDark ? '' : 'var(--bg-table-header)';
    dBtn.style.color = isDark ? '' : 'var(--text-primary)';
  }

  window.pickThemeBase = function(base) {
    _cb = base;
    document.documentElement.setAttribute('data-theme', base + '-' + _cm);
    if (typeof _updateThemeBtn === 'function') _updateThemeBtn();
    _updateHidden();
    document.querySelectorAll('.theme-card').forEach(function(el) {
      el.classList.toggle('theme-card-active', el.dataset.base === base);
    });
  };

  window.pickThemeMode = function(mode) {
    _cm = mode;
    document.documentElement.setAttribute('data-theme', _cb + '-' + mode);
    if (typeof _updateThemeBtn === 'function') _updateThemeBtn();
    _updateHidden();
    _syncModeButtons();
  };
})();
</script>
{% if vapid_public_key %}
<script src="/static/js/push-register.js"></script>
{% endif %}
{% endblock %}
