{% extends "base.html" %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî FinLife{% endblock %}

{% block content %}
<style>
  .profile-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    max-width: 860px;
  }
  @media (max-width: 640px) {
    .profile-grid { grid-template-columns: 1fr; }
  }
  .xp-bar-track {
    background: #e9ecef;
    border-radius: 6px;
    height: 10px;
    overflow: hidden;
    margin: 10px 0 6px;
  }
  .xp-bar-fill {
    background: #007AFF;
    height: 100%;
    border-radius: 6px;
  }
  .xp-stat-row {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    font-size: 13px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color, #f0f0f0);
  }
  .xp-stat-item { display: flex; flex-direction: column; gap: 2px; }
  .xp-stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; color: #888; font-weight: 600; }
  .xp-stat-val { font-size: 15px; font-weight: 700; }
  .xp-earn-list { list-style: none; margin: 0; padding: 0; }
  .xp-earn-list li {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid var(--border-color, #f0f0f0);
    font-size: 13px;
  }
  .xp-earn-list li:last-child { border-bottom: none; }
  .xp-earn-amount {
    font-weight: 700;
    color: #007AFF;
    min-width: 64px;
    white-space: nowrap;
  }
  .profile-meta-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 7px 0;
    border-bottom: 1px solid var(--border-color, #f0f0f0);
    font-size: 14px;
  }
  .profile-meta-row:last-child { border-bottom: none; }
  .profile-meta-label { color: #888; font-size: 13px; }
  .profile-meta-val { font-weight: 600; }

  .xp-event-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
    padding: 7px 0;
    border-bottom: 1px solid var(--border-color, #f0f0f0);
    font-size: 13px;
  }
  .xp-event-row:last-child { border-bottom: none; }
  .xp-event-date { color: #888; white-space: nowrap; min-width: 118px; font-size: 12px; font-variant-numeric: tabular-nums; }
  .xp-event-desc { flex: 1; }
  .xp-event-amount { font-weight: 700; color: #007AFF; white-space: nowrap; }

  .activity-row { display: flex; align-items: baseline; gap: 8px; padding: 5px 0; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 13px; }
  .activity-row:last-child { border-bottom: none; }
  .activity-label { color: #888; font-size: 12px; min-width: 140px; }
  .activity-val { font-weight: 600; }
  .activity-index-bar-track { background: #e9ecef; border-radius: 6px; height: 8px; overflow: hidden; margin: 6px 0 4px; flex: 1; min-width: 80px; }
  .activity-index-bar-fill { background: #34c759; height: 100%; border-radius: 6px; transition: width 0.3s; }
  .trend-up { color: #34c759; font-weight: 700; }
  .trend-down { color: #ff3b30; font-weight: 700; }
  .trend-flat { color: #888; }
  [data-theme$="-dark"] .activity-row { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .activity-label { color: #8b949e; }
  [data-theme$="-dark"] .activity-index-bar-track { background: #21262d; }

  .xp-analytics-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .xp-analytics-table th { padding: 4px 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: #888; font-weight: 600; border-bottom: 1px solid #eee; text-align: left; }
  .xp-analytics-table td { padding: 3px 8px; border-bottom: 1px solid #f4f4f4; }
  .xp-analytics-table .xp-zero td { color: #bbb; }
  .xp-analytics-table .xp-pos { font-weight: 700; color: #007AFF; }
  .xp-analytics-table .xp-total-row td { font-weight: 700; border-top: 2px solid #ddd; border-bottom: none; padding-top: 6px; }

  /* Dark theme */
  [data-theme$="-dark"] .xp-bar-track { background: #21262d; }
  [data-theme$="-dark"] .xp-stat-label { color: #8b949e; }
  [data-theme$="-dark"] .xp-earn-list li { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .profile-meta-row { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .profile-meta-label { color: #8b949e; }
  [data-theme$="-dark"] .xp-stat-row { border-top-color: #21262d; }
  [data-theme$="-dark"] .xp-event-row { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .xp-event-date { color: #8b949e; }
  [data-theme$="-dark"] .xp-analytics-table th { color: #8b949e; border-bottom-color: #30363d; }
  [data-theme$="-dark"] .xp-analytics-table td { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .xp-analytics-table .xp-zero td { color: #484f58; }
  [data-theme$="-dark"] .xp-analytics-table .xp-total-row td { border-top-color: #30363d; }

  /* Theme picker cards */
  .theme-card {
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 12px;
    width: 170px;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.1s, box-shadow 0.2s;
    user-select: none;
  }
  .theme-card:hover { transform: translateY(-2px); }
  .theme-card-active {
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 1px var(--accent);
  }
  @media (max-width: 640px) {
    .theme-card { width: calc(50% - 6px); }
  }
</style>

<h1 style="margin-bottom: 20px;">–ü—Ä–æ—Ñ–∏–ª—å</h1>

<div class="profile-grid">

  {# ‚îÄ‚îÄ Left column: account info ‚îÄ‚îÄ #}
  <div class="card">
    <div style="font-weight: 600; font-size: 15px; margin-bottom: 14px;">–ê–∫–∫–∞—É–Ω—Ç</div>
    <div class="profile-meta-row">
      <span class="profile-meta-label">E-mail</span>
      <span class="profile-meta-val">{{ email }}</span>
    </div>
    <div class="profile-meta-row">
      <span class="profile-meta-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</span>
      <span class="profile-meta-val">{{ registration_date }}</span>
    </div>
    <div class="profile-meta-row">
      <span class="profile-meta-label">–î–Ω–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</span>
      <span class="profile-meta-val">{{ days_in_system }}</span>
    </div>
  </div>

  {# ‚îÄ‚îÄ Right column: XP card ‚îÄ‚îÄ #}
  <div class="card">
    <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px;">
      <span style="font-size: 18px; font-weight: 700;">–£—Ä–æ–≤–µ–Ω—å {{ xp.level }}</span>
      <span class="muted" style="font-size: 14px;">{{ level_title }}</span>
    </div>

    <div style="font-size: 13px; color: #555; margin-bottom: 2px;">
      XP: {{ xp.current_level_xp }} / {{ xp.current_level_xp + xp.xp_to_next_level }}
    </div>

    <div class="xp-bar-track">
      <div class="xp-bar-fill" style="width: {{ xp.percent_progress }}%;"></div>
    </div>

    <div style="font-size: 12px;" class="muted">
      –î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: {{ xp.xp_to_next_level }} XP
    </div>

    <div class="xp-stat-row">
      <div class="xp-stat-item">
        <span class="xp-stat-label">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</span>
        <span class="xp-stat-val">{{ xp.xp_this_month }} XP</span>
      </div>
      <div class="xp-stat-item">
        <span class="xp-stat-label">–í—Å–µ–≥–æ</span>
        <span class="xp-stat-val">{{ xp.total_xp }} XP</span>
      </div>
      <div class="xp-stat-item">
        <span class="xp-stat-label">–†–µ–∫–æ—Ä–¥ –º–µ—Å—è—Ü–∞</span>
        <span class="xp-stat-val">{{ xp.xp_record_month }} XP</span>
      </div>
    </div>
  </div>

  {# ‚îÄ‚îÄ Activity Index ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / -1; max-width: 860px;">
    <div style="font-weight: 600; font-size: 14px; margin-bottom: 10px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>

    {# Index bar #}
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 2px;">
      <span style="font-size: 22px; font-weight: 700;">{{ activity.activity_index }}</span>
      <span class="muted" style="font-size: 13px;">/ 100</span>
      <div class="activity-index-bar-track">
        <div class="activity-index-bar-fill" style="width: {{ activity.activity_index }}%;"></div>
      </div>
    </div>

    {# Trend #}
    <div style="font-size: 13px; margin-bottom: 10px;">
      {% if activity.trend_delta > 0 %}
      <span class="trend-up">‚ñ≤ +{{ activity.trend_delta }}</span> –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
      {% elif activity.trend_delta < 0 %}
      <span class="trend-down">‚ñº {{ activity.trend_delta }}</span> –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
      {% else %}
      <span class="trend-flat">‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</span> –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ–π
      {% endif %}
    </div>

    {# Stats rows #}
    <div class="activity-row">
      <span class="activity-label">7 –¥–Ω–µ–π / –ø—Ä–µ–¥. 7 –¥–Ω–µ–π</span>
      <span class="activity-val">{{ activity.points_7d }} –æ—á–∫–æ–≤</span>
      <span class="muted" style="font-size: 12px;">/ {{ activity.points_prev_7d }} –æ—á–∫–æ–≤</span>
    </div>
    <div class="activity-row">
      <span class="activity-label">30 –¥–Ω–µ–π / –≤ —Å—Ä–µ–¥–Ω–µ–º</span>
      <span class="activity-val">{{ activity.points_30d_total }} –æ—á–∫–æ–≤</span>
      <span class="muted" style="font-size: 12px;">/ {{ activity.points_30d_avg }} –≤ –¥–µ–Ω—å</span>
    </div>
    {% if activity.best_day_date_30d %}
    <div class="activity-row">
      <span class="activity-label">–õ—É—á—à–∏–π –¥–µ–Ω—å (30 –¥–Ω–µ–π)</span>
      <span class="activity-val">{{ activity.best_day_date_30d }} ‚Äî {{ activity.best_day_points_30d }} –æ—á–∫–æ–≤</span>
    </div>
    {% endif %}
  </div>

  {# ‚îÄ‚îÄ Recent XP events ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / -1; max-width: 860px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
      <span style="font-weight: 600; font-size: 14px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ XP-—Å–æ–±—ã—Ç–∏—è</span>
      <a href="/profile/xp-history" style="font-size: 12px; color: #007AFF; text-decoration: none;">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é ‚Üí</a>
    </div>
    {% if recent_xp_events %}
      {% for ev in recent_xp_events %}
      <div class="xp-event-row">
        <span class="xp-event-date">{{ ev.created_at }}</span>
        <span class="xp-event-desc">{{ ev.description }}</span>
        <span class="xp-event-amount">+{{ ev.xp_amount }} XP</span>
      </div>
      {% endfor %}
    {% else %}
      <div class="muted" style="font-size: 13px; padding: 8px 0;">XP-—Å–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ó–∞–∫—Ä–æ–π—Ç–µ –∑–∞–¥–∞—á—É –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É!</div>
    {% endif %}
  </div>

  {# ‚îÄ‚îÄ Daily XP breakdown ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / 2;">
    <div style="font-weight: 600; font-size: 14px; margin-bottom: 12px;">
      XP –ø–æ –¥–Ω—è–º ‚Äî {{ current_month_label }}
    </div>
    <div style="overflow-y: auto; max-height: 340px;">
      <table class="xp-analytics-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th style="text-align: right;">XP</th>
          </tr>
        </thead>
        <tbody>
          {% for d in daily_xp %}
          <tr class="{% if d.xp == 0 %}xp-zero{% endif %}">
            <td>{{ d.date_str }}</td>
            <td style="text-align: right;" class="{% if d.xp > 0 %}xp-pos{% endif %}">
              {% if d.xp > 0 %}+{{ d.xp }}{% else %}‚Äî{% endif %}
            </td>
          </tr>
          {% endfor %}
          <tr class="xp-total-row">
            <td>–ò—Ç–æ–≥–æ</td>
            <td style="text-align: right;" class="xp-pos">+{{ daily_xp_total }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  {# ‚îÄ‚îÄ Monthly XP summary ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 2 / 3; align-self: start;">
    <div style="font-weight: 600; font-size: 14px; margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞ XP –ø–æ –º–µ—Å—è—Ü–∞–º</div>
    <table class="xp-analytics-table">
      <thead>
        <tr>
          <th>–ú–µ—Å—è—Ü</th>
          <th style="text-align: right;">XP</th>
        </tr>
      </thead>
      <tbody>
        {% for mo in monthly_xp %}
        <tr class="{% if mo.xp == 0 %}xp-zero{% endif %}">
          <td>{{ mo.month_name }} {{ mo.year }}</td>
          <td style="text-align: right;" class="{% if mo.xp > 0 %}xp-pos{% endif %}">
            {% if mo.xp > 0 %}+{{ mo.xp }}{% else %}‚Äî{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# ‚îÄ‚îÄ How to earn XP ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / -1; max-width: 420px;">
    <div style="font-weight: 600; font-size: 14px; margin-bottom: 12px;">–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å XP</div>
    <ul class="xp-earn-list">
      <li>
        <span class="xp-earn-amount">+10 XP</span>
        <span>–∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏</span>
      </li>
      <li>
        <span class="xp-earn-amount">+2 XP</span>
        <span>–±–æ–Ω—É—Å –∑–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–¥–æ —Å—Ä–æ–∫–∞)</span>
      </li>
      <li>
        <span class="xp-earn-amount">+3 XP</span>
        <span>–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏</span>
      </li>
      <li>
        <span class="xp-earn-amount">+200 XP</span>
        <span>–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –¥–µ–Ω–µ–∂–Ω–æ–π —Ü–µ–ª–∏</span>
      </li>
      <li>
        <span class="xp-earn-amount">+5 XP</span>
        <span>–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</span>
      </li>
    </ul>
  </div>

  {# ‚îÄ‚îÄ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ (theme picker) ‚îÄ‚îÄ #}
  <div class="card" style="grid-column: 1 / -1; max-width: 860px;">
    <div style="font-weight: 600; font-size: 15px; margin-bottom: 16px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>

    <form method="POST" action="/profile/save-theme">
      <input type="hidden" name="theme" id="selectedTheme" value="{{ current_theme }}">

      <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); margin-bottom: 10px;">–¢–µ–º–∞</div>
      <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px;">

        {# graphite-emerald #}
        <div class="theme-card{% if theme_base == 'graphite-emerald' %} theme-card-active{% endif %}"
             data-base="graphite-emerald"
             onclick="pickThemeBase('graphite-emerald')">
          <div style="display: flex; height: 64px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);">
            <div style="width: 38%; background: #1E3A3F;"></div>
            <div style="flex: 1; background: #F6F8FB; padding: 5px 4px;">
              <div style="height: 5px; background: #1E7F4F; border-radius: 2px; margin-bottom: 4px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.12); border-radius: 2px; margin-bottom: 3px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.07); border-radius: 2px;"></div>
            </div>
          </div>
          <div style="font-size: 13px; font-weight: 600;">–°—Ç—Ä–æ–≥–∏–π Fintech</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">graphite-emerald</div>
        </div>

        {# deep-blue #}
        <div class="theme-card{% if theme_base == 'deep-blue' %} theme-card-active{% endif %}"
             data-base="deep-blue"
             onclick="pickThemeBase('deep-blue')">
          <div style="display: flex; height: 64px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);">
            <div style="width: 38%; background: #1E3A5F;"></div>
            <div style="flex: 1; background: #EEF2FF; padding: 5px 4px;">
              <div style="height: 5px; background: #1D4ED8; border-radius: 2px; margin-bottom: 4px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.12); border-radius: 2px; margin-bottom: 3px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.07); border-radius: 2px;"></div>
            </div>
          </div>
          <div style="font-size: 13px; font-weight: 600;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–∏–Ω–∏–π</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">deep-blue</div>
        </div>

        {# architect-neutral #}
        <div class="theme-card{% if theme_base == 'architect-neutral' %} theme-card-active{% endif %}"
             data-base="architect-neutral"
             onclick="pickThemeBase('architect-neutral')">
          <div style="display: flex; height: 64px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);">
            <div style="width: 38%; background: #292524;"></div>
            <div style="flex: 1; background: #FAF9F7; padding: 5px 4px;">
              <div style="height: 5px; background: #92400E; border-radius: 2px; margin-bottom: 4px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.12); border-radius: 2px; margin-bottom: 3px;"></div>
              <div style="height: 3px; background: rgba(0,0,0,0.07); border-radius: 2px;"></div>
            </div>
          </div>
          <div style="font-size: 13px; font-weight: 600;">–¢—ë–ø–ª—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º</div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">architect-neutral</div>
        </div>

      </div>

      <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); margin-bottom: 10px;">–†–µ–∂–∏–º</div>
      <div style="display: flex; gap: 8px; margin-bottom: 20px;">
        <button type="button" id="modeBtnLight" onclick="pickThemeMode('light')"
                style="font-size: 13px; padding: 6px 16px; min-height: unset;{% if theme_mode != 'light' %} background: var(--bg-table-header); color: var(--text-primary);{% endif %}">
          ‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è
        </button>
        <button type="button" id="modeBtnDark" onclick="pickThemeMode('dark')"
                style="font-size: 13px; padding: 6px 16px; min-height: unset;{% if theme_mode != 'dark' %} background: var(--bg-table-header); color: var(--text-primary);{% endif %}">
          üåô –¢—ë–º–Ω–∞—è
        </button>
      </div>

      <button type="submit" style="font-size: 14px; padding: 8px 24px; min-height: unset;">
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
      </button>
    </form>
  </div>

</div>

<script>
(function() {
  var _cb = '{{ theme_base }}';
  var _cm = '{{ theme_mode }}';

  function _updateHidden() {
    var inp = document.getElementById('selectedTheme');
    if (inp) inp.value = _cb + '-' + _cm;
  }

  function _syncModeButtons() {
    var lBtn = document.getElementById('modeBtnLight');
    var dBtn = document.getElementById('modeBtnDark');
    if (!lBtn || !dBtn) return;
    var isDark = _cm === 'dark';
    lBtn.style.background = !isDark ? '' : 'var(--bg-table-header)';
    lBtn.style.color = !isDark ? '' : 'var(--text-primary)';
    dBtn.style.background = isDark ? '' : 'var(--bg-table-header)';
    dBtn.style.color = isDark ? '' : 'var(--text-primary)';
  }

  window.pickThemeBase = function(base) {
    _cb = base;
    var theme = base + '-' + _cm;
    document.documentElement.setAttribute('data-theme', theme);
    if (typeof _updateThemeBtn === 'function') _updateThemeBtn();
    _updateHidden();
    document.querySelectorAll('.theme-card').forEach(function(el) {
      el.classList.toggle('theme-card-active', el.dataset.base === base);
    });
  };

  window.pickThemeMode = function(mode) {
    _cm = mode;
    var theme = _cb + '-' + mode;
    document.documentElement.setAttribute('data-theme', theme);
    if (typeof _updateThemeBtn === 'function') _updateThemeBtn();
    _updateHidden();
    _syncModeButtons();
  };
})();
</script>
{% endblock %}
