{% extends "base.html" %}
{% block title %}{{ sub.name }} — FinLife{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}
{% macro fmt2(val) %}{{ "{:,.2f}".format(val).replace(",", " ") }}{% endmacro %}
{% macro fmt_date(d) %}{{ d.strftime('%d.%m.%Y') }}{% endmacro %}
{% macro contact_name(member) %}{% if contact_map and contact_map.get(member.contact_id) %}{{ contact_map[member.contact_id].name }}{% else %}?{% endif %}{% endmacro %}

{% block content %}
<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
  <h1 style="margin: 0;">{{ sub.name }}</h1>
  <a href="/subscriptions/{{ sub.id }}/edit" class="btn secondary" style="font-size: 13px;">&#9881; Настройки</a>
  <a href="/subscriptions" style="color: #666; text-decoration: none; font-size: 13px;">&larr; К списку</a>
</div>

{% if error %}
<div class="card" style="border-color: #dc3545; background: #f8d7da;">
  <p style="color: #721c24; margin: 0;">{{ error }}</p>
</div>
{% endif %}

<!-- Month navigator -->
<div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
  <a href="/subscriptions/{{ sub.id }}?month={{ prev_month }}" style="font-size: 20px; text-decoration: none;">&lsaquo;</a>
  <span style="font-size: 18px; font-weight: 600; min-width: 180px; text-align: center;">
    {{ selected_label }}
  </span>
  <a href="/subscriptions/{{ sub.id }}?month={{ next_month }}" style="font-size: 20px; text-decoration: none;">&rsaquo;</a>
</div>

<!-- Monthly summary -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">РАСХОД</div>
    <div class="stat-value negative">{{ fmt2(detail.cost_month) }}</div>
    <div class="stat-sublabel">за месяц (SELF)</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ДОХОД</div>
    <div class="stat-value positive">{{ fmt2(detail.income_month) }}</div>
    <div class="stat-sublabel">компенсации</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">ИТОГО</div>
    <div class="stat-value {% if detail.net >= 0 %}positive{% else %}negative{% endif %}">
      {% if detail.net > 0 %}+{% endif %}{{ fmt2(detail.net) }}
    </div>
    <div class="stat-sublabel">окупаемость</div>
  </div>
</div>

<!-- Paid until -->
<div class="card">
  <h2 style="margin-top: 0; font-size: 16px;">Оплачено до</h2>

  <div class="dash-item" style="padding: 6px 0;">
    <div class="dash-item-left">
      <strong>Ты</strong>
    </div>
    <div>
      {% if detail.paid_until_self %}
        <span style="font-weight: 500;">{{ fmt_date(detail.paid_until_self) }}</span>
      {% else %}
        <span class="muted">нет данных</span>
      {% endif %}
    </div>
  </div>

  {% for mp in detail.members_paid_until %}
  <div class="dash-item" style="padding: 6px 0;">
    <div class="dash-item-left">
      {% if mp.contact %}
        <a href="/contacts/{{ mp.contact.id }}" style="text-decoration: none; color: inherit;">{{ mp.contact.name }}</a>
      {% else %}
        {{ contact_name(mp.member) }}
      {% endif %}
      {% if mp.member.is_archived %}<span class="muted">(архив)</span>{% endif %}
      {% if mp.member.payment_per_year or mp.member.payment_per_month %}
      <span class="muted" style="font-size: 11px;">
        {% if mp.member.payment_per_year %}{{ fmt2(mp.member.payment_per_year) }}/год{% endif %}
        {% if mp.member.payment_per_year and mp.member.payment_per_month %} &middot; {% endif %}
        {% if mp.member.payment_per_month %}{{ fmt2(mp.member.payment_per_month) }}/мес{% endif %}
      </span>
      {% endif %}
    </div>
    <div>
      {% if mp.paid_until %}
        <span style="font-weight: 500;">{{ fmt_date(mp.paid_until) }}</span>
      {% else %}
        <span class="muted">нет данных</span>
      {% endif %}
    </div>
  </div>
  {% endfor %}

  {% if not detail.members_paid_until %}
  <p class="muted" style="margin: 8px 0 0;">Участников нет.
    <a href="/subscriptions/{{ sub.id }}/edit">Добавить</a>
  </p>
  {% endif %}
</div>

<!-- Initial coverage form -->
<details class="card">
  <summary style="cursor: pointer; font-weight: 600; font-size: 16px;">+ Ввести начальное покрытие</summary>
  <form method="POST" action="/subscriptions/{{ sub.id }}/initial-coverage" style="margin-top: 12px;">
    <div class="form-row">
      <label>Плательщик</label>
      <div style="display: flex; gap: 16px;">
        <label style="font-weight: normal;">
          <input type="radio" name="payer_type" value="SELF" checked onchange="toggleInitialMember()"> Я
        </label>
        <label style="font-weight: normal;">
          <input type="radio" name="payer_type" value="MEMBER" onchange="toggleInitialMember()"
                 {% if not members %}disabled{% endif %}> Участник
        </label>
      </div>
    </div>

    <div class="form-row" id="initialMemberField" style="display: none;">
      <label>Участник</label>
      <select name="member_id" id="initialMemberId">
        <option value="">-- Выберите --</option>
        {% for m in members %}
        <option value="{{ m.id }}">{{ contact_name(m) }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-row">
      <label>Оплачено до (включительно)</label>
      <input name="end_date" type="date" required>
    </div>

    <button type="submit">Сохранить</button>
  </form>
</details>

<!-- Coverage log -->
<div class="card">
  <h2 style="margin-top: 0; font-size: 16px;">Журнал покрытий</h2>

  {% if detail.coverage_log %}
  <div class="matrix-scroll-wrapper">
    <table>
      <thead>
        <tr>
          <th>Дата</th>
          <th>Тип</th>
          <th>Источник</th>
          <th>Участник</th>
          <th>Период</th>
          <th style="text-align: right;">Сумма</th>
          <th style="text-align: right;">В месяц</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in detail.coverage_log %}
        {% set cov = entry.coverage %}
        {% set tx = entry.tx %}
        <tr{% if cov.source_type == 'INITIAL' %} style="opacity: 0.7;"{% endif %}>
          <td style="white-space: nowrap;">
            {% if tx %}{{ tx.occurred_at.strftime('%d.%m.%Y') }}{% else %}—{% endif %}
          </td>
          <td>
            {% if cov.payer_type == 'SELF' %}
            <span class="badge badge-expense">Оплата</span>
            {% else %}
            <span class="badge badge-income">Компенсация</span>
            {% endif %}
          </td>
          <td>
            {% if cov.source_type == 'INITIAL' %}
              <span class="muted" style="font-size: 11px;">начальное</span>
            {% else %}
              <span style="font-size: 11px;">операция</span>
            {% endif %}
          </td>
          <td>
            {% if entry.contact %}{{ entry.contact.name }}{% elif cov.payer_type == 'SELF' %}Ты{% else %}—{% endif %}
          </td>
          <td style="white-space: nowrap;">
            {% if cov.source_type == 'INITIAL' %}
              до {{ fmt_date(cov.end_date) }}
            {% else %}
              {{ fmt_date(cov.start_date) }} &rarr; {{ fmt_date(cov.end_date) }}
              <span class="muted">({{ entry.months_count }} мес.)</span>
            {% endif %}
          </td>
          <td style="text-align: right; white-space: nowrap;">
            {% if tx %}
              <span class="{% if cov.payer_type == 'SELF' %}negative{% else %}positive{% endif %}">
                {{ fmt(tx.amount) }}
              </span>
            {% else %}—{% endif %}
          </td>
          <td style="text-align: right; white-space: nowrap;">
            {% if tx %}{{ fmt2(tx.amount / entry.months_count) }}{% else %}—{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="muted" style="text-align: center; padding: 16px 0;">
      Покрытий пока нет. Создайте операцию по категории подписки.
    </p>
  {% endif %}
</div>

<script>
function toggleInitialMember() {
  var isMember = document.querySelector('input[name="payer_type"][value="MEMBER"]').checked;
  document.getElementById('initialMemberField').style.display = isMember ? '' : 'none';
}
</script>
{% endblock %}
