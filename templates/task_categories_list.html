{% extends "base.html" %}
{% block title %}Категории дел — FinLife{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
  <h1 style="margin: 0;">Категории дел</h1>
  <a href="/task-categories/new" class="btn">+ Создать категорию</a>
</div>

<!-- Tabs: Active / Archived -->
<div class="plan-tabs" style="max-width: 300px; margin-bottom: 16px;">
  <a href="/task-categories?view=active{% if q %}&q={{ q }}{% endif %}" {% if view != "archived" %}class="active"{% endif %}>Активные</a>
  <a href="/task-categories?view=archived{% if q %}&q={{ q }}{% endif %}" {% if view == "archived" %}class="active"{% endif %}>Архивные</a>
</div>

<!-- Search -->
<div class="card" style="padding: 12px 24px;">
  <form method="GET" action="/task-categories" style="display: flex; gap: 8px; align-items: center;">
    <input type="hidden" name="view" value="{{ view }}">
    <input name="q" type="text" value="{{ q }}" placeholder="Поиск по названию…" style="flex: 1; max-width: 400px;">
    <button type="submit" style="font-size: 13px; padding: 6px 14px;">Найти</button>
    {% if q %}
    <a href="/task-categories?view={{ view }}" style="color: #666; text-decoration: none; font-size: 13px;">Сбросить</a>
    {% endif %}
  </form>
</div>

<!-- Category list -->
{% if categories %}
<div class="card">
  {% for cat in categories %}
  <div class="dash-item" style="padding: 10px 0;">
    <div class="dash-item-left" style="font-size: 15px;">
      <span style="font-size: 20px; min-width: 28px; text-align: center;">{{ cat.emoji or '' }}</span>
      <span {% if cat.is_archived %}class="muted"{% endif %}>{{ cat.title }}</span>
      {% if cat.is_archived %}
      <span class="badge badge-archive">архив</span>
      {% endif %}
    </div>
    <div class="dash-item-actions">
      <a href="/task-categories/{{ cat.category_id }}/edit" class="btn-gear" title="Настройки">&#9881;</a>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="card">
  {% if view == "archived" %}
  <p class="muted" style="text-align: center; padding: 24px 0;">Архив пуст</p>
  {% else %}
  <p class="muted" style="text-align: center; padding: 24px 0;">
    Активных категорий нет.
    <a href="/task-categories/new">Создать</a>
  </p>
  {% endif %}
</div>
{% endif %}

{% if all_cats and usage_counts %}
<div class="card">
  <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">Частота использования</div>
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Категория</th>
        <th style="text-align: right;">Задач</th>
        <th style="text-align: right;">%</th>
        <th style="width: 40%;"></th>
      </tr>
    </thead>
    <tbody>
      {% for cat in all_cats | sort(attribute='title') %}
      {% set cnt = usage_counts.get(cat.category_id, 0) %}
      {% if cnt > 0 %}
      {% set pct = (cnt / total_with_cat * 100) | round(1) %}
      <tr{% if cat.is_archived %} style="opacity: 0.5;"{% endif %}>
        <td style="font-size: 16px; text-align: center;">{{ cat.emoji or '' }}</td>
        <td>{{ cat.title }}</td>
        <td style="text-align: right; font-weight: 600;">{{ cnt }}</td>
        <td style="text-align: right; color: #888;">{{ pct }}%</td>
        <td>
          <div style="height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">
            <div style="height: 100%; width: {{ pct }}%; background: #007AFF; border-radius: 3px;"></div>
          </div>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  <p style="font-size: 12px; color: #888; margin: 8px 0 0;">Всего задач с категорией: {{ total_with_cat }}</p>
</div>
{% endif %}
{% endblock %}
