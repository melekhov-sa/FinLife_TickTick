{% extends "base.html" %}
{% block title %}Главная — FinLife{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}

{% block content %}
<h1>Главная</h1>

<!-- ============ СЕГОДНЯ ============ -->
<div class="card">
  <div class="dash-section-title">
    Сегодня
    <span class="muted" style="font-weight: 400; font-size: 14px; margin-left: 8px;">{{ today.strftime('%d.%m.%Y') }}</span>
  </div>

  <!-- Progress bar -->
  {% if progress.total > 0 %}
  <div class="dash-progress-row">
    <span>{{ progress.done }} из {{ progress.total }}</span>
    {% set pct = (progress.done / progress.total * 100) | int if progress.total > 0 else 0 %}
    <div class="dash-progress-bar">
      <div class="dash-progress-fill" style="width: {{ pct }}%;"></div>
    </div>
    <span class="muted">{{ pct }}%</span>
  </div>
  {% endif %}

  <!-- Overdue items -->
  {% if overdue_items %}
  <div class="dash-group">
    <div class="dash-group-label negative">Просрочено ({{ overdue_items|length }})</div>
    {% for item in overdue_items %}
    <div class="dash-item dash-item-overdue">
      <div class="dash-item-left">
        {% if item.category_emoji %}{{ item.category_emoji }} {% endif %}
        <span>{{ item.title }}</span>
        {% if item.kind == "planned_op" %}
        <span class="badge">{{ item.meta.op_kind_label }} {{ item.meta.amount_formatted }}</span>
        {% endif %}
        <small class="negative">({{ item.date.strftime('%d.%m') }})</small>
      </div>
      <div class="dash-item-actions">
        {% if item.kind == "task" %}
        <form method="POST" action="/tasks/{{ item.meta.task_id }}/complete" style="margin:0;">
          <button type="submit" style="font-size: 12px; padding: 4px 10px;">&#10003;</button>
        </form>
        {% elif item.kind == "task_occ" %}
        <form method="POST" action="/plan/task-occurrences/{{ item.meta.occurrence_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" style="font-size: 12px; padding: 4px 10px;">&#10003;</button>
        </form>
        {% elif item.kind == "planned_op" %}
        <a href="/plan/operation-occurrences/{{ item.meta.occurrence_id }}/confirm?redirect=%2F"
           class="dash-btn-link">&#10003;</a>
        <form method="POST" action="/plan/operation-occurrences/{{ item.meta.occurrence_id }}/skip" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">&#8212;</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Active items -->
  {% if active_items %}
  <div class="dash-group">
    <div class="dash-group-label">Активные ({{ active_items|length }})</div>
    {% for item in active_items %}
    <div class="dash-item">
      <div class="dash-item-left">
        {% if item.kind == "event" %}&#128198;{% elif item.kind in ("task", "task_occ") %}&#9745;{% elif item.kind == "planned_op" %}&#128197;{% elif item.kind == "habit" %}&#128170;{% endif %}
        {% if item.category_emoji %}{{ item.category_emoji }}{% endif %}
        <span>{{ item.title }}</span>

        {% if item.kind == "planned_op" %}
        <span class="badge">{{ item.meta.op_kind_label }} {{ item.meta.amount_formatted }}</span>
        {% endif %}

        {% if item.kind == "habit" and item.meta.current_streak > 0 %}
        <small class="muted">&#128293; {{ item.meta.current_streak }} дн.</small>
        {% endif %}

        {% if item.time %}
        <small class="muted">{{ item.time.strftime('%H:%M') }}</small>
        {% endif %}
      </div>
      <div class="dash-item-actions">
        {% if item.kind == "task" %}
        <form method="POST" action="/tasks/{{ item.meta.task_id }}/complete" style="margin:0;">
          <button type="submit" style="font-size: 12px; padding: 4px 10px;">&#10003;</button>
        </form>
        {% elif item.kind == "task_occ" %}
        <form method="POST" action="/plan/task-occurrences/{{ item.meta.occurrence_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" style="font-size: 12px; padding: 4px 10px;">&#10003;</button>
        </form>
        {% elif item.kind == "planned_op" %}
        <a href="/plan/operation-occurrences/{{ item.meta.occurrence_id }}/confirm?redirect=%2F"
           class="dash-btn-link">&#10003;</a>
        <form method="POST" action="/plan/operation-occurrences/{{ item.meta.occurrence_id }}/skip" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">&#8212;</button>
        </form>
        {% elif item.kind == "habit" %}
        <form method="POST" action="/plan/habit-occurrences/{{ item.meta.occurrence_id }}/toggle" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" style="font-size: 12px; padding: 4px 10px; background: #28a745;">&#10003;</button>
        </form>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Done items -->
  {% if done_items %}
  <div class="dash-group">
    <div class="dash-group-label positive">Сделано ({{ done_items|length }})</div>
    {% for item in done_items %}
    <div class="dash-item dash-item-done">
      <div class="dash-item-left">
        {% if item.kind == "habit" %}&#128170;{% elif item.kind in ("task", "task_occ") %}&#9745;{% elif item.kind == "planned_op" %}&#128197;{% endif %}
        <s class="muted">{{ item.title }}</s>
      </div>
      <div class="dash-item-actions">
        {% if item.kind == "habit" %}
        <form method="POST" action="/plan/habit-occurrences/{{ item.meta.occurrence_id }}/toggle" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">&#8634;</button>
        </form>
        {% endif %}
        <span class="positive" style="font-size: 18px;">&#10003;</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if not overdue_items and not active_items and not done_items %}
  <p class="muted" style="text-align: center; padding: 16px 0;">Нет дел на сегодня</p>
  {% endif %}

  <p style="margin-top: 8px;"><a href="/plan">Открыть план &rarr;</a></p>
</div>

<!-- ============ БЛИЖАЙШИЕ ПЛАТЕЖИ ============ -->
{% if upcoming_payments %}
<div class="card">
  <div class="dash-section-title">Ближайшие платежи</div>
  {% for pay in upcoming_payments %}
  <div class="dash-item">
    <div class="dash-item-left">
      &#128197;
      <span>{{ pay.title }}</span>
      <span class="badge {% if pay.kind == 'INCOME' %}badge-income{% elif pay.kind == 'EXPENSE' %}badge-expense{% else %}badge-transfer{% endif %}">
        {{ pay.kind_label }} {{ pay.amount_formatted }}
      </span>
      <small class="muted">через {{ pay.days_until }} дн. ({{ pay.scheduled_date.strftime('%d.%m') }})</small>
    </div>
  </div>
  {% endfor %}
  <p style="margin-top: 8px;"><a href="/planned-operations">Все плановые &rarr;</a></p>
</div>
{% endif %}

<!-- ============ АКТИВНОСТЬ ПРИВЫЧЕК ============ -->
{% if habit_heatmap %}
<div class="card">
  <div class="dash-section-title">Активность привычек</div>
  <div class="dash-heatmap">
    {% for cell in habit_heatmap %}
    <div class="dash-heatmap-cell dash-heatmap-level-{{ cell.level }}"
         title="{{ cell.date.strftime('%d.%m') }}: {{ cell.done_count }}/{{ cell.due_count }}">
      <span class="dash-heatmap-day">{{ cell.date.strftime('%d') }}</span>
    </div>
    {% endfor %}
  </div>
  <div class="dash-heatmap-legend">
    <span class="muted" style="font-size: 12px;">0%</span>
    <div class="dash-heatmap-cell dash-heatmap-level-0" style="width:14px;height:14px;"></div>
    <div class="dash-heatmap-cell dash-heatmap-level-1" style="width:14px;height:14px;"></div>
    <div class="dash-heatmap-cell dash-heatmap-level-2" style="width:14px;height:14px;"></div>
    <div class="dash-heatmap-cell dash-heatmap-level-3" style="width:14px;height:14px;"></div>
    <div class="dash-heatmap-cell dash-heatmap-level-4" style="width:14px;height:14px;"></div>
    <span class="muted" style="font-size: 12px;">100%</span>
  </div>
  <p style="margin-top: 8px;"><a href="/habits">Все привычки &rarr;</a></p>
</div>
{% endif %}

<!-- ============ ФИНАНСЫ ============ -->
<div class="card">
  <div class="dash-section-title">{{ current_month }}</div>
  <div class="financial-result">
    <div class="fr-item">
      <span class="fr-label">Доходы</span>
      <span class="fr-value positive">+{{ fmt(income) }}</span>
    </div>
    <div class="fr-item">
      <span class="fr-label">Расходы</span>
      <span class="fr-value negative">-{{ fmt(expense) }}</span>
    </div>
    <div class="fr-item fr-total">
      <span class="fr-label">Разница</span>
      <span class="fr-value {% if difference >= 0 %}positive{% else %}negative{% endif %}">
        {% if difference > 0 %}+{% endif %}{{ fmt(difference) }}
      </span>
    </div>
  </div>
  <p style="margin-top: 8px;"><a href="/budget">Бюджет &rarr;</a></p>
</div>
{% endblock %}
