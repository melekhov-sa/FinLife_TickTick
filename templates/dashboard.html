{% extends "base.html" %}
{% block title %}Главная - FinLife{% endblock %}

{% block content %}
<h1>Главная</h1>

<!-- Верхние карточки статистики -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">СЧЕТА</div>
    <div class="stat-value">{{ "{:,.2f}".format(regular_balance).replace(",", " ") }}</div>
    {% if change_regular != 0 %}
      <div class="stat-change {% if change_regular > 0 %}positive{% else %}negative{% endif %}">
        {% if change_regular > 0 %}+{% endif %}{{ "{:,.2f}".format(change_regular).replace(",", " ") }} за 30д
      </div>
    {% endif %}
  </div>

  <div class="stat-card">
    <div class="stat-label">НАКОПЛЕНИЯ</div>
    <div class="stat-value">{{ "{:,.2f}".format(savings_balance).replace(",", " ") }}</div>
    {% if change_savings != 0 %}
      <div class="stat-change {% if change_savings > 0 %}positive{% else %}negative{% endif %}">
        {% if change_savings > 0 %}+{% endif %}{{ "{:,.2f}".format(change_savings).replace(",", " ") }} за 30д
      </div>
    {% endif %}
  </div>

  <div class="stat-card">
    <div class="stat-label">КРЕДИТЫ</div>
    <div class="stat-value {% if credit_balance < 0 %}negative{% endif %}">{{ "{:,.2f}".format(credit_balance).replace(",", " ") }}</div>
    {% if change_credit != 0 %}
      <div class="stat-change {% if change_credit > 0 %}positive{% else %}negative{% endif %}">
        {% if change_credit > 0 %}+{% endif %}{{ "{:,.2f}".format(change_credit).replace(",", " ") }} за 30д
      </div>
    {% endif %}
  </div>

  <div class="stat-card stat-card-total">
    <div class="stat-label">ФИНАНСОВЫЙ РЕЗУЛЬТАТ</div>
    <div class="stat-value">{{ "{:,.2f}".format(financial_result_total).replace(",", " ") }}</div>
    {% if change_total != 0 %}
      <div class="stat-change {% if change_total > 0 %}stat-change-positive{% else %}stat-change-negative{% endif %}">
        {% if change_total > 0 %}+{% endif %}{{ "{:,.2f}".format(change_total).replace(",", " ") }} за 30д
      </div>
    {% endif %}
  </div>
</div>

<!-- Доходы / Расходы за месяц -->
<div class="card">
  <h2>{{ current_month }}</h2>
  <div class="financial-result">
    <div class="fr-item">
      <span class="fr-label">Доходы</span>
      <span class="fr-value positive">+{{ "{:,.2f}".format(income_this_month).replace(",", " ") }}</span>
    </div>
    <div class="fr-item">
      <span class="fr-label">Расходы</span>
      <span class="fr-value negative">-{{ "{:,.2f}".format(expense_this_month).replace(",", " ") }}</span>
    </div>
    <div class="fr-item fr-total">
      <span class="fr-label">Разница</span>
      <span class="fr-value {% if month_result >= 0 %}positive{% else %}negative{% endif %}">
        {% if month_result > 0 %}+{% endif %}{{ "{:,.2f}".format(month_result).replace(",", " ") }}
      </span>
    </div>
  </div>
</div>

<!-- Задачи на сегодня -->
{% set active_today_tasks = today_tasks | selectattr('due_date') | list %}
{% set overdue_tasks = [] %}
{% set due_today_tasks = [] %}
{% for t in active_today_tasks %}
  {% if t.due_date < today %}
    {% set _ = overdue_tasks.append(t) %}
  {% elif t.due_date == today %}
    {% set _ = due_today_tasks.append(t) %}
  {% endif %}
{% endfor %}
{% set active_task_occs = today_task_occs | selectattr('status', 'equalto', 'ACTIVE') | list %}
{% if overdue_tasks or due_today_tasks or active_task_occs %}
<div class="card">
  <h2>&#9745; Задачи</h2>
  {% for task in overdue_tasks %}
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
    <div>
      <span>{{ task.title }}</span>
      <small class="negative">(просрочено {{ task.due_date.strftime('%d.%m') }})</small>
    </div>
    <form method="POST" action="/tasks/{{ task.task_id }}/complete" style="margin: 0;">
      <button type="submit" style="font-size: 12px; padding: 4px 10px;">Выполнить</button>
    </form>
  </div>
  {% endfor %}
  {% for task in due_today_tasks %}
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
    <div>
      <span>{{ task.title }}</span>
      <small class="muted">(сегодня)</small>
    </div>
    <form method="POST" action="/tasks/{{ task.task_id }}/complete" style="margin: 0;">
      <button type="submit" style="font-size: 12px; padding: 4px 10px;">Выполнить</button>
    </form>
  </div>
  {% endfor %}
  {% for occ in active_task_occs %}
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
    <div>
      <span>{{ task_tmpl_map.get(occ.template_id, {}).title if task_tmpl_map.get(occ.template_id) else 'Задача #' ~ occ.template_id }}</span>
      <small class="muted">(повторяющаяся)</small>
    </div>
    <form method="POST" action="/tasks/occurrences/{{ occ.id }}/complete" style="margin: 0;">
      <button type="submit" style="font-size: 12px; padding: 4px 10px;">Выполнить</button>
    </form>
  </div>
  {% endfor %}
  <p style="margin-top: 8px;"><a href="/tasks">Все задачи &rarr;</a></p>
</div>
{% endif %}

<!-- Привычки на сегодня -->
{% if today_habit_occs %}
<div class="card">
  <h2>&#128170; Привычки</h2>
  {% for occ in today_habit_occs %}
    {% set habit = habit_map.get(occ.habit_id) %}
    {% if habit %}
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
      <div>
        <span>{{ habit.title }}</span>
        <small class="muted">(стрик: {{ habit.current_streak }})</small>
      </div>
      <div>
        {% if occ.status == 'DONE' %}
          <span class="positive" style="font-size: 18px;">&#10003;</span>
        {% elif occ.status == 'SKIPPED' %}
          <span class="muted">пропущено</span>
        {% else %}
          <form method="POST" action="/habits/occurrences/{{ occ.id }}/complete" style="display:inline; margin: 0;">
            <button type="submit" style="font-size: 12px; padding: 4px 10px;">&#10003;</button>
          </form>
          <form method="POST" action="/habits/occurrences/{{ occ.id }}/skip" style="display:inline; margin: 0;">
            <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">&#8212;</button>
          </form>
        {% endif %}
      </div>
    </div>
    {% endif %}
  {% endfor %}
  <p style="margin-top: 8px;"><a href="/habits">Все привычки &rarr;</a></p>
</div>
{% endif %}

<!-- Плановые операции -->
{% if today_op_occs %}
<div class="card">
  <h2>&#128197; Плановые операции</h2>
  {% for occ in today_op_occs %}
    {% set tmpl = op_tmpl_map.get(occ.template_id) %}
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
      <div>
        <span>{{ tmpl.title if tmpl else 'Операция #' ~ occ.template_id }}</span>
        {% if tmpl %}
          <small class="muted">
            {% if tmpl.kind == 'INCOME' %}Доход{% elif tmpl.kind == 'EXPENSE' %}Расход{% else %}Перевод{% endif %}
            {{ "{:,.2f}".format(tmpl.amount).replace(",", " ") }}
          </small>
        {% endif %}
        {% if occ.scheduled_date < today %}
          <small class="negative">({{ occ.scheduled_date.strftime('%d.%m') }})</small>
        {% endif %}
      </div>
      <div style="white-space: nowrap;">
        <form method="POST" action="/planned-operations/occurrences/{{ occ.id }}/confirm" style="display:inline; margin: 0;">
          <button type="submit" style="font-size: 12px; padding: 4px 10px;"
                  onclick="return confirm('Подтвердить операцию?')">Подтвердить</button>
        </form>
        <form method="POST" action="/planned-operations/occurrences/{{ occ.id }}/skip" style="display:inline; margin: 0;">
          <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">Пропустить</button>
        </form>
      </div>
    </div>
  {% endfor %}
  <p style="margin-top: 8px;"><a href="/planned-operations">Все плановые &rarr;</a></p>
</div>
{% endif %}

<!-- События (7 дней) -->
{% if events_7d %}
<div class="card">
  <h2>&#128198; События (7 дней)</h2>
  {% for occ in events_7d %}
    {% set ev = event_map.get(occ.event_id) %}
    {% set wc = wc_map.get(ev.category_id) if ev else None %}
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
      <div>
        {% if wc and wc.emoji %}{{ wc.emoji }} {% endif %}
        <span>{{ ev.title if ev else 'Событие #' ~ occ.event_id }}</span>
        {% if ev and ev.importance > 0 %}<span class="badge">&#9733; {{ ev.importance }}</span>{% endif %}
        <small class="muted">
          {{ occ.start_date.strftime('%d.%m') }}{% if occ.start_date == today %} (сегодня){% endif %}
          {% if occ.start_time %} {{ occ.start_time.strftime('%H:%M') }}{% endif %}
        </small>
      </div>
    </div>
  {% endfor %}
  <p style="margin-top: 8px;"><a href="/events">Все события &rarr;</a></p>
</div>
{% endif %}

<!-- Деньги (счета) -->
<div class="card">
  <h2>Счета</h2>
  {% set regular_wallets = wallets | selectattr('wallet_type', 'equalto', 'REGULAR') | list %}
  {% if regular_wallets %}
    <table>
      <tbody>
        {% for wallet in regular_wallets %}
        <tr>
          <td>{{ wallet.title }}</td>
          <td class="text-right {% if wallet.balance >= 0 %}positive{% else %}negative{% endif %}">
            {{ "{:,.2f}".format(wallet.balance).replace(",", " ") }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Нет кошельков. <a href="/wallets">Создать</a></p>
  {% endif %}
</div>

<!-- Накопления -->
{% set savings_wallets = wallets | selectattr('wallet_type', 'equalto', 'SAVINGS') | list %}
{% if savings_wallets %}
<div class="card">
  <h2>Накопления</h2>
  <table>
    <tbody>
      {% for wallet in savings_wallets %}
      <tr>
        <td>{{ wallet.title }}</td>
        <td class="text-right positive">{{ "{:,.2f}".format(wallet.balance).replace(",", " ") }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Кредиты -->
{% set credit_wallets = wallets | selectattr('wallet_type', 'equalto', 'CREDIT') | list %}
{% if credit_wallets %}
<div class="card">
  <h2>Кредиты</h2>
  <table>
    <tbody>
      {% for wallet in credit_wallets %}
      <tr>
        <td>{{ wallet.title }}</td>
        <td class="text-right negative">{{ "{:,.2f}".format(wallet.balance).replace(",", " ") }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Операции -->
<div class="card">
  <h2>Операции</h2>
  {% if transactions %}
    <table>
      <tbody>
        {% for tx in transactions %}
        <tr>
          <td style="width: 60px;">{{ tx.occurred_at.strftime('%d.%m') }}</td>
          <td>
            {% if tx.operation_type == 'INCOME' %}
              <span class="positive">+</span> Доход
            {% elif tx.operation_type == 'EXPENSE' %}
              <span class="negative">-</span> Расход
            {% else %}
              Перевод
            {% endif %}
            {{ "{:,.2f}".format(tx.amount).replace(",", " ") }}
            {% if tx.description %} — {{ tx.description }}{% endif %}
          </td>
          <td class="text-right {% if tx.operation_type == 'INCOME' %}positive{% elif tx.operation_type == 'EXPENSE' %}negative{% endif %}" style="white-space: nowrap;">
            {% if tx.operation_type == 'INCOME' %}+{% elif tx.operation_type == 'EXPENSE' %}-{% endif %}{{ "{:,.2f}".format(tx.amount).replace(",", " ") }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <p style="margin-top: 16px;"><a href="/transactions">Все операции &rarr;</a></p>
  {% else %}
    <p class="muted">Нет операций. <a href="/transactions">Добавить первую операцию</a></p>
  {% endif %}
</div>
{% endblock %}
