{% extends "base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è ‚Äî FinLife{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}

{% block extra_head %}<style>
/* ‚îÄ‚îÄ Dashboard v2 grid ‚îÄ‚îÄ */
.dash-v2-grid {
  display: grid;
  grid-template-columns: 320px 1fr 320px;
  gap: 16px;
  align-items: start;
  margin-top: 16px;
}
.dash-col-left,
.dash-col-center,
.dash-col-right {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ‚îÄ‚îÄ dash-card component ‚îÄ‚îÄ */
.dash-card {
  border-radius: 12px;
  border: 1px solid var(--border-color);
  background: var(--bg-card);
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.dash-card-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 14px;
}

/* ‚îÄ‚îÄ Skeleton placeholders ‚îÄ‚îÄ */
.skel {
  background: var(--border-color);
  border-radius: 6px;
  opacity: 0.45;
  display: block;
}
.skel-lg  { height: 32px; margin-bottom: 10px; }
.skel-md  { height: 14px; margin-bottom: 8px;  }
.skel-sm  { height: 10px; margin-bottom: 6px;  }
.w-30 { width: 30%; }
.w-40 { width: 40%; }
.w-60 { width: 60%; }
.w-70 { width: 70%; }
.w-80 { width: 80%; }

/* ‚îÄ‚îÄ Remove max-width on dashboard ‚îÄ‚îÄ */
.main-content { max-width: none; }

/* ‚îÄ‚îÄ Finance state card (#dash-fin-state) ‚îÄ‚îÄ */
.fs-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border-color);
}
.fs-row:last-of-type { border-bottom: none; }
.fs-label {
  font-size: 13px;
  color: var(--text-secondary);
  text-decoration: none;
}
a.fs-label:hover { color: var(--text-primary); }
.fs-amount {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}
.fs-result {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border-color);
}
.fs-result-val {
  font-size: 18px;
  font-weight: 700;
}
.fs-result--pos { color: #2e7d32; }
.fs-result--neg { color: #c62828; }

/* ‚îÄ‚îÄ Progress bar (shared) ‚îÄ‚îÄ */
.progress {
  height: 7px;
  border-radius: 999px;
  background: var(--border-color);
  overflow: hidden;
}
.progress__fill {
  height: 100%;
  background: var(--accent);
  border-radius: 999px;
}

/* ‚îÄ‚îÄ Level card (#dash-level) ‚îÄ‚îÄ */
a.dash-card-link {
  text-decoration: none;
  display: block;
}
.lv-main {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 10px;
}
.lv-num {
  font-size: 30px;
  font-weight: 700;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}
.lv-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
}
.lv-progress { margin-bottom: 8px; }
.lv-xp-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2px;
}
.lv-xp-main {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
}
.lv-xp-next {
  font-size: 12px;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}
.lv-month {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 8px;
  font-variant-numeric: tabular-nums;
}

/* ‚îÄ‚îÄ Activity card (#dash-activity) ‚îÄ‚îÄ */
.act-index {
  display: flex;
  align-items: baseline;
  gap: 2px;
  margin-bottom: 6px;
}
.act-num {
  font-size: 34px;
  font-weight: 700;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}
.act-denom {
  font-size: 16px;
  color: var(--text-secondary);
  margin-left: 1px;
}
.act-trend {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-variant-numeric: tabular-nums;
}
.act-trend--up   { color: #2e7d32; }
.act-trend--down { color: #c62828; }
.act-trend--zero { color: var(--text-secondary); }
.act-trend-label {
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 400;
}
.act-sub {
  font-size: 12px;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

/* ‚îÄ‚îÄ Tablet: left+center side-by-side, right below ‚îÄ‚îÄ */
@media (max-width: 1199px) {
  .dash-v2-grid {
    grid-template-columns: 1fr 1fr;
  }
  .dash-col-right {
    grid-column: 1 / -1;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .dash-col-right > .dash-card {
    flex: 1 1 240px;
  }
}

/* ‚îÄ‚îÄ Mobile: single column ‚îÄ‚îÄ */
@media (max-width: 767px) {
  .dash-v2-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  .dash-col-left,
  .dash-col-center,
  .dash-col-right {
    min-width: 0;
  }
  .dash-col-right {
    grid-column: 1;
    flex-direction: column;
  }
  .dash-col-right > .dash-card {
    flex: none;
  }
  /* Reduce card padding + prevent overflow */
  .dash-card {
    padding: 14px;
    overflow: hidden;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }
  /* Finance state: smaller amounts */
  .fs-amount {
    font-size: 13px;
    word-break: break-word;
  }
  .fs-result-val {
    font-size: 15px;
  }
  .fs-label {
    font-size: 12px;
    flex-shrink: 1;
    min-width: 0;
  }
  .fs-row {
    gap: 8px;
  }
  /* Level & Activity: slightly smaller */
  .lv-num {
    font-size: 26px;
  }
  .act-num {
    font-size: 28px;
  }
  .act-denom {
    font-size: 14px;
  }
  /* Diary */
  .diary-item-amount {
    font-size: 12px;
    word-break: break-word;
  }
  .diary-item-body {
    min-width: 0;
  }
  .diary-item-subtitle {
    max-width: 100%;
  }
  /* Badges ‚Äî allow wrapping on mobile */
  .badge {
    white-space: normal;
    word-break: break-word;
  }
  /* Dash items ‚Äî prevent overflow */
  .dash-item-left {
    min-width: 0;
    overflow-wrap: break-word;
  }
  /* Focus */
  .focus-header-actions {
    gap: 4px;
  }
  .focus-link-btn, .quick-op-btn {
    font-size: 12px;
    padding: 4px 8px;
  }
}
/* ‚îÄ‚îÄ Small phone ‚îÄ‚îÄ */
@media (max-width: 380px) {
  .dash-card {
    padding: 12px;
  }
  .fs-amount {
    font-size: 12px;
  }
  .fs-result-val {
    font-size: 14px;
  }
  .fs-label {
    font-size: 11px;
  }
  .diary-item-time {
    min-width: 32px;
    font-size: 11px;
  }
}

/* ‚îÄ‚îÄ Focus card (#dash-focus) ‚îÄ‚îÄ */
.focus-progress {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 12px; font-size: 12px; color: var(--text-secondary);
}
.focus-progress-bar {
  flex: 1; height: 3px; background: var(--border-color); border-radius: 2px; overflow: hidden;
}
.focus-progress-fill {
  height: 100%; background: var(--accent); border-radius: 2px; transition: width .3s;
}
.focus-section-label {
  font-size: 11px; font-weight: 600; color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: .04em;
  margin: 10px 0 4px; padding: 0;
}
.focus-section-label:first-child { margin-top: 0; }
.focus-item {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 4px; border-radius: 6px;
  transition: background .12s;
}
.focus-item:hover { background: rgba(128,128,128,.06); }
.focus-check {
  width: 18px; height: 18px; min-width: 18px;
  border-radius: 6px; border: 1.5px solid var(--border-color);
  background: transparent; cursor: pointer; padding: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 0; color: transparent;
  transition: border-color .15s, background .15s;
  flex-shrink: 0;
}
.focus-check:hover {
  border-color: var(--accent);
  background: rgba(0,122,255,.08);
}
.focus-content { flex: 1; min-width: 0; }
.focus-title { font-size: 14px; line-height: 1.3; }
.focus-meta { font-size: 11px; color: var(--text-secondary); margin-top: 1px; }
.focus-meta--overdue { color: #c62828; }
.focus-item--overdue .focus-title { color: #c62828; }
.focus-item--overdue .focus-check { border-color: #c62828; }
.focus-item--overdue .focus-check:hover { background: rgba(198,40,40,.08); }
.focus-all-done { text-align: center; padding: 20px 0; color: var(--text-secondary); font-size: 14px; }
.focus-overflow { font-size: 12px; color: var(--text-secondary); margin-top: 6px; margin-bottom: 0; }
.focus-header-actions { display: flex; gap: 6px; align-items: center; }
.focus-link-btn {
  font-size: 13px; padding: 5px 10px; border-radius: 10px;
  background: transparent; border: 1px solid var(--border-color);
  color: var(--text-secondary); cursor: pointer; white-space: nowrap;
  transition: background .15s, color .15s; text-decoration: none;
  line-height: 1.4; display: inline-block;
}
.focus-link-btn:hover { background: var(--bg-hover, rgba(128,128,128,.1)); color: var(--text-primary); }

/* ‚îÄ‚îÄ Diary card (#dash-feed) ‚îÄ‚îÄ */
.diary-day { margin-bottom: 20px; }
.diary-day:last-child { margin-bottom: 0; }
.diary-day-header {
  font-size: 15px; font-weight: 700; color: var(--text-primary);
  margin-bottom: 10px; padding-bottom: 6px;
  border-bottom: 1px solid var(--border-color);
}
/* Timeline container: vertical line via ::before */
.diary-timeline {
  position: relative;
  padding-left: 24px;
}
.diary-timeline::before {
  content: "";
  position: absolute;
  left: 7px;
  top: 4px;
  bottom: 4px;
  width: 1px;
  background: var(--border-color);
  opacity: 0.6;
}
/* Each event on the timeline */
.diary-item {
  position: relative;
  display: flex; gap: 8px; padding: 6px 0; align-items: flex-start;
}
/* Marker dot */
.diary-item::before {
  content: "";
  position: absolute;
  left: -20px;
  top: 8px;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--text-secondary);
  opacity: 0.4;
}
.diary-item--income::before  { background: #2e7d32; opacity: 0.45; }
.diary-item--expense::before { background: #c62828; opacity: 0.45; }
.diary-item-time {
  font-size: 12px; color: var(--text-secondary);
  font-variant-numeric: tabular-nums; min-width: 38px; flex-shrink: 0;
  padding-top: 1px;
}
.diary-item-icon { font-size: 14px; flex-shrink: 0; padding-top: 1px; }
.diary-item-body { flex: 1; min-width: 0; }
.diary-item-title { font-size: 13px; font-weight: 500; line-height: 1.3; }
.diary-item-subtitle {
  font-size: 11px; color: var(--text-secondary); margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.diary-item-amount { font-size: 13px; font-weight: 600; font-variant-numeric: tabular-nums; flex-shrink: 0; padding-top: 1px; }
.diary-amount--income   { color: #2e7d32; }
.diary-amount--expense  { color: #c62828; }
.diary-amount--transfer { color: var(--text-secondary); }

/* ‚îÄ‚îÄ Quick-op modal ‚îÄ‚îÄ */
.qop-backdrop {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.35); align-items: center; justify-content: center;
}
.qop-backdrop.qop-open { display: flex; }
.qop-dialog {
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,.18);
  width: min(360px, calc(100vw - 32px)); padding: 20px 22px;
}
.qop-title {
  font-size: 15px; font-weight: 600; margin: 0 0 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.qop-close {
  background: none; border: none; cursor: pointer; font-size: 18px;
  color: var(--text-secondary); line-height: 1; padding: 0 2px;
}
.qop-close:hover { color: var(--text-primary); }
.qop-field { margin-bottom: 12px; }
.qop-field label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.qop-field input, .qop-field select {
  width: 100%; padding: 8px 10px; font-size: 14px;
  background: var(--bg-page); border: 1px solid var(--border-color);
  border-radius: 8px; color: var(--text-primary); box-sizing: border-box;
}
.qop-field input:focus, .qop-field select:focus {
  outline: none; border-color: var(--accent, #4a90d9);
}
.qop-actions { display: flex; gap: 8px; margin-top: 16px; }
.qop-submit {
  flex: 1; padding: 9px 0; font-size: 14px; font-weight: 600;
  background: var(--accent, #4a90d9); color: #fff;
  border: none; border-radius: 10px; cursor: pointer;
  transition: opacity .15s;
}
.qop-submit:hover { opacity: .88; }
.qop-cancel-btn {
  padding: 9px 16px; font-size: 14px;
  background: transparent; border: 1px solid var(--border-color);
  border-radius: 10px; cursor: pointer; color: var(--text-secondary);
}
.qop-cancel-btn:hover { background: var(--bg-hover, rgba(128,128,128,.1)); }

/* ‚îÄ‚îÄ Quick operation dropdown ‚îÄ‚îÄ */
.dash-card-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.dash-card-header .dash-card-title { margin-bottom: 0; }
.quick-op-wrapper { position: relative; }
.quick-op-btn {
  font-size: 13px; padding: 5px 10px; border-radius: 10px;
  background: transparent; border: 1px solid var(--border-color);
  color: var(--text-secondary); cursor: pointer; white-space: nowrap;
  transition: background .15s, color .15s;
  line-height: 1.4;
}
.quick-op-btn:hover { background: var(--bg-hover, rgba(128,128,128,.1)); color: var(--text-primary); }
.quick-op-menu {
  position: absolute; right: 0; top: calc(100% + 5px); z-index: 200;
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,.12);
  min-width: 160px; overflow: hidden;
}
.quick-op-menu a {
  display: block; padding: 10px 16px; font-size: 13px;
  color: var(--text-primary); text-decoration: none;
  transition: background .12s;
}
.quick-op-menu a:hover { background: var(--bg-hover, rgba(128,128,128,.08)); }

/* ‚îÄ‚îÄ Quick-task modal ‚îÄ‚îÄ */
.qt-overlay {
  display: none; position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,.45); align-items: flex-start; justify-content: center;
  padding-top: min(10vh, 80px);
}
.qt-overlay.open { display: flex; }
.qt-modal {
  background: var(--bg-card); border-radius: 14px; padding: 24px;
  width: 95vw; max-width: 620px; max-height: 85vh; overflow-y: auto;
  box-shadow: 0 12px 40px rgba(0,0,0,.2);
  animation: qtSlideIn .18s ease-out;
}
@keyframes qtSlideIn { from { opacity: 0; transform: translateY(-16px); } to { opacity: 1; transform: translateY(0); } }
.qt-modal-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.qt-modal-header h2 { margin: 0; font-size: 16px; }
.qt-close-btn {
  background: none; border: none; font-size: 22px; cursor: pointer;
  color: var(--text-secondary); padding: 0 4px; min-height: unset; line-height: 1;
}
.qt-close-btn:hover { color: var(--text-primary); }

/* ‚îÄ‚îÄ Task form (shared with tasks page) ‚îÄ‚îÄ */
.task-form-grid {
  display: grid;
  grid-template-columns: 1.4fr 1fr;
  gap: 10px 16px;
}
.task-form-grid .span-full { grid-column: 1 / -1; }
@media (max-width: 620px) {
  .task-form-grid { grid-template-columns: 1fr; }
  .task-form-grid .span-full { grid-column: 1; }
}
.seg-control {
  display: inline-flex; border-radius: 8px; overflow: hidden;
  border: 1px solid var(--border-color); background: var(--bg-input, #fff);
}
.seg-control button {
  flex: 1; border: none; border-radius: 0; padding: 6px 14px;
  font-size: 12px; font-weight: 500; min-height: unset;
  background: transparent; color: var(--text-secondary);
  cursor: pointer; transition: background .15s, color .15s; white-space: nowrap;
}
.seg-control button:not(:last-child) { border-right: 1px solid var(--border-color); }
.seg-control button:hover { background: var(--bg-table-header, #f0f0f0); color: var(--text-primary); }
.seg-control button.seg-active { background: var(--accent); color: #fff; }
.seg-control button.seg-active:hover { background: var(--accent-hover); }
.task-form-grid label { margin-top: 0; margin-bottom: 2px; font-size: 13px; }
.task-form-grid .form-row { margin-bottom: 0; }
.task-form-grid input,
.task-form-grid select { max-width: 100%; height: 36px; font-size: 13px; }
.task-form-grid textarea { max-width: 100%; font-size: 13px; }
.task-form-grid details { margin-bottom: 0; }
.task-form-submit { display: flex; justify-content: flex-start; padding-top: 4px; }
.task-form-submit button[type="submit"] { min-width: 120px; }
</style>{% endblock %}

{% block content %}
{% set wish_type_labels = {
    'PURCHASE': 'üí∞ –ü–æ–∫—É–ø–∫–∏',
    'EVENT': 'üéâ –°–æ–±—ã—Ç–∏—è',
    'PLACE': 'üåç –ú–µ—Å—Ç–∞',
    'OTHER': 'üìù –î—Ä—É–≥–æ–µ'
} %}
{% set wish_status_labels = {
    'IDEA': 'üí°',
    'CONSIDERING': 'ü§î',
    'PLANNED': 'üìÖ'
} %}
{% set has_wishes = wishes_this_month.PURCHASE or wishes_this_month.EVENT or wishes_this_month.PLACE or wishes_this_month.OTHER %}

<h1 style="margin-bottom: 0;">
  –ì–ª–∞–≤–Ω–∞—è
  <span class="muted" style="font-weight: 400; font-size: 16px; margin-left: 8px;">{{ today.strftime('%d.%m.%Y') }}</span>
</h1>

<div class="dash-v2-grid">

  {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT COLUMN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
  <div class="dash-col-left">

    {# ‚îÄ‚îÄ –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ #}
    <div class="dash-card clarity-mask" id="dash-fin-state">
      <div class="dash-card-title">–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>

      <div class="fs-row">
        <a href="/wallets" class="fs-label">–û–±—ã—á–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏</a>
        <span class="fs-amount">{{ format_money(fin_state.regular_total, "RUB") }}</span>
      </div>

      <div class="fs-row">
        <a href="/wallets" class="fs-label">–ö—Ä–µ–¥–∏—Ç—ã</a>
        <span class="fs-amount">{{ format_money(fin_state.credit_total, "RUB") }}</span>
      </div>

      <div class="fs-row">
        <a href="/goals" class="fs-label">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</a>
        <span class="fs-amount">{{ format_money(fin_state.savings_total, "RUB") }}</span>
      </div>

      <div class="fs-result">
        <div class="fs-row" style="border-bottom:none;">
          <span class="fs-label" style="font-weight:600;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</span>
          <span class="fs-amount fs-result-val {% if fin_state.financial_result >= 0 %}fs-result--pos{% else %}fs-result--neg{% endif %}">
            {{ format_money(fin_state.financial_result, "RUB") }}
          </span>
        </div>
      </div>

      <p style="margin-top:12px;margin-bottom:0;">
        <a href="/wallets" style="font-size:12px;">–ö–æ—à–µ–ª—å–∫–∏ &rarr;</a>
        &nbsp;&nbsp;
        <a href="/budget" style="font-size:12px;">–ë—é–¥–∂–µ—Ç &rarr;</a>
      </p>
    </div>

    {# ‚îÄ‚îÄ –£—Ä–æ–≤–µ–Ω—å ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-level">
      <div class="dash-card-title">–£—Ä–æ–≤–µ–Ω—å</div>
      <a href="/profile" class="dash-card-link">
        <div class="lv-main">
          <span class="lv-num">{{ dash_xp.level }}</span>
          <span class="lv-title">{{ dash_xp.level_title }}</span>
        </div>
        <div class="lv-progress">
          <div class="progress">
            <div class="progress__fill" style="width: {{ dash_xp.percent_progress }}%;"></div>
          </div>
        </div>
        <div class="lv-xp-row">
          <span class="lv-xp-main">{{ dash_xp.current_level_xp }} / {{ dash_xp.total_level_target }} XP</span>
          <span class="lv-xp-next">‚àí{{ dash_xp.xp_to_next_level }} XP</span>
        </div>
        {% if dash_xp.xp_this_month > 0 %}
        <div class="lv-month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü: {{ dash_xp.xp_this_month }} XP</div>
        {% endif %}
      </a>
    </div>

    {# ‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-activity">
      <div class="dash-card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      <a href="/profile" class="dash-card-link">
        <div class="act-index">
          <span class="act-num">{{ dash_activity.activity_index }}</span>
          <span class="act-denom"> / 100</span>
        </div>
        <div class="act-trend act-trend--{{ dash_activity.trend_sign }}">
          {%- if dash_activity.trend_sign == "up" -%}‚ñ≤ +{{ dash_activity.trend_abs }}
          {%- elif dash_activity.trend_sign == "down" -%}‚ñº ‚àí{{ dash_activity.trend_abs }}
          {%- else -%}‚Ä¢ 0{%- endif -%}
          <span class="act-trend-label"> –∑–∞ –Ω–µ–¥–µ–ª—é</span>
        </div>
        <div class="act-sub">7–¥: {{ dash_activity.points_7d }} ‚Ä¢ –ø—Ä–µ–¥: {{ dash_activity.points_prev_7d }}</div>
      </a>
    </div>

  </div>{# ‚îÄ‚îÄ end LEFT ‚îÄ‚îÄ #}


  {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CENTER COLUMN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
  <div class="dash-col-center">

    {# ‚îÄ‚îÄ –§–æ–∫—É—Å –¥–Ω—è ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-focus">
      <div class="dash-card-header">
        <div class="dash-card-title">–§–æ–∫—É—Å –¥–Ω—è</div>
        <div class="focus-header-actions">
          <a href="#" id="openQuickTask" class="focus-link-btn">+ –ó–∞–¥–∞—á–∞</a>
          <div class="quick-op-wrapper" id="quickOpWrapper">
            <button class="quick-op-btn" type="button" aria-haspopup="true" aria-expanded="false">+ –û–ø–µ—Ä–∞—Ü–∏—è</button>
            <div class="quick-op-menu" hidden>
              <a href="#" data-type="INCOME">–î–æ—Ö–æ–¥</a>
              <a href="#" data-type="EXPENSE">–†–∞—Å—Ö–æ–¥</a>
              <a href="#" data-type="TRANSFER">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</a>
            </div>
          </div>
        </div>
      </div>

      {# Progress bar #}
      {% if progress.total > 0 %}
      <div class="focus-progress">
        <span>{{ progress.done }} –∏–∑ {{ progress.total }}</span>
        <div class="focus-progress-bar">
          <div class="focus-progress-fill" style="width: {{ (progress.done / progress.total * 100)|round|int }}%;"></div>
        </div>
      </div>
      {% endif %}

      {% set has_focus = focus_overdue or focus_tasks or focus_habits %}

      {# –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ #}
      {% if focus_overdue %}
      <div class="focus-section-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
      {% for item in focus_overdue %}
      <div class="focus-item focus-item--overdue">
        {% if item.kind == "task" %}
        <form method="POST" action="/plan/tasks/{{ item.meta.task_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="focus-check" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å"></button>
        </form>
        {% elif item.kind == "task_occ" %}
        <form method="POST" action="/plan/task-occurrences/{{ item.meta.occurrence_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="focus-check" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å"></button>
        </form>
        {% endif %}
        <div class="focus-content">
          <div class="focus-title">{% if item.category_emoji %}{{ item.category_emoji }} {% endif %}{{ item.title }}</div>
          <div class="focus-meta focus-meta--overdue">{{ item.date.strftime('%d.%m') }} ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
        </div>
      </div>
      {% endfor %}
      {% endif %}

      {# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è #}
      {% if focus_tasks %}
      <div class="focus-section-label">–ó–∞–¥–∞—á–∏</div>
      {% for item in focus_tasks %}
      <div class="focus-item">
        {% if item.kind == "task" %}
        <form method="POST" action="/plan/tasks/{{ item.meta.task_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="focus-check" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å"></button>
        </form>
        {% elif item.kind == "task_occ" %}
        <form method="POST" action="/plan/task-occurrences/{{ item.meta.occurrence_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="focus-check" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å"></button>
        </form>
        {% endif %}
        <div class="focus-content">
          <div class="focus-title">{% if item.category_emoji %}{{ item.category_emoji }} {% endif %}{{ item.title }}</div>
          {% if item.date == today %}
          <div class="focus-meta">—Å–µ–≥–æ–¥–Ω—è</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
      {% if focus_tasks_overflow %}
      <p class="focus-overflow"><a href="/tasks">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ &rarr;</a></p>
      {% endif %}
      {% endif %}

      {# –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ —Å–µ–≥–æ–¥–Ω—è #}
      {% if focus_habits %}
      <div class="focus-section-label">–ü—Ä–∏–≤—ã—á–∫–∏</div>
      {% for item in focus_habits %}
      <div class="focus-item">
        <form method="POST" action="/plan/habit-occurrences/{{ item.meta.occurrence_id }}/toggle" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="focus-check" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å"></button>
        </form>
        <div class="focus-content">
          <div class="focus-title">{% if item.category_emoji %}{{ item.category_emoji }} {% endif %}{{ item.title }}</div>
          {% if item.meta.current_streak > 0 %}
          <div class="focus-meta">—Å–µ—Ä–∏—è {{ item.meta.current_streak }} –¥–Ω.</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
      {% if focus_habits_overflow %}
      <p class="focus-overflow"><a href="/habits">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ &rarr;</a></p>
      {% endif %}
      {% endif %}

      {% if not has_focus %}
      <div class="focus-all-done">–°–µ–≥–æ–¥–Ω—è –≤—Å—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–æ &#10003;</div>
      {% endif %}

      <p style="margin-top:10px;margin-bottom:0;font-size:12px;">
        <a href="/plan">–û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞–Ω &rarr;</a>
      </p>
    </div>

    {# ‚îÄ‚îÄ –î–Ω–µ–≤–Ω–∏–∫ ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-feed">
      <div class="dash-card-title">–î–Ω–µ–≤–Ω–∏–∫</div>
      {% if feed_groups %}
      {% for group in feed_groups %}
      <div class="diary-day">
        <div class="diary-day-header">{{ group.label }}</div>
        <div class="diary-timeline">
          {% for item in group.events %}
          <div class="diary-item{% if item.amount_css %} diary-item--{{ item.amount_css }}{% endif %}">
            <span class="diary-item-time">{{ item.time_str }}</span>
            <span class="diary-item-icon">{{ item.icon }}</span>
            <div class="diary-item-body">
              <div class="diary-item-title">{{ item.title }}</div>
              {% if item.subtitle %}
              <div class="diary-item-subtitle">{{ item.subtitle }}</div>
              {% endif %}
            </div>
            {% if item.amount_label %}
            <span class="diary-item-amount diary-amount--{{ item.amount_css }} clarity-mask">{{ item.amount_label }}</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
      {% else %}
      <p class="muted" style="text-align:center;padding:16px 0;font-size:13px;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –∑–∞ 7 –¥–Ω–µ–π</p>
      {% endif %}
    </div>

    {# ‚îÄ‚îÄ –•–æ—Ç–µ–ª–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ ‚îÄ‚îÄ #}
    {% if has_wishes %}
    <div class="dash-card">
      <div class="dash-card-title">–•–æ—Ç–µ–ª–∫–∏ ‚Äî {{ current_month }}</div>
      {% for wish_type in ['PURCHASE', 'EVENT', 'PLACE', 'OTHER'] %}
        {% set wishes = wishes_this_month[wish_type] %}
        {% if wishes %}
        <div class="dash-group" style="margin-bottom:12px;">
          <div class="dash-group-label">{{ wish_type_labels[wish_type] }} ({{ wishes|length }})</div>
          {% for wish in wishes %}
          <div class="dash-item" style="padding:8px 0;border-bottom:1px solid var(--border-color);">
            <div class="dash-item-left">
              {{ wish_status_labels.get(wish.status, '') }}
              <span>{{ wish.title }}</span>
              {% if wish.estimated_amount %}
              <span class="badge clarity-mask" style="background:#e8f5e9;color:#2e7d32;">
                {{ "{:,.2f}".format(wish.estimated_amount).replace(',', ' ') }} —Ä—É–±.
              </span>
              {% endif %}
              {% if wish.is_recurring %}
              <span class="badge" style="background:#e3f2fd;color:#1976d2;">‚ôªÔ∏è</span>
              {% endif %}
              {% if wish.target_date %}
              <small class="muted">{{ wish.target_date.strftime('%d.%m.%Y') }}</small>
              {% elif wish.target_month %}
              <small class="muted">–≤–µ—Å—å –º–µ—Å—è—Ü</small>
              {% endif %}
            </div>
            <div class="dash-item-actions">
              <a href="/wishes/{{ wish.wish_id }}/edit"
                 style="font-size:18px;text-decoration:none;color:var(--text-secondary);">‚öôÔ∏è</a>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      {% endfor %}
      <p style="margin-top:8px;margin-bottom:0;">
        <a href="/wishes" style="font-size:12px;">–í—Å–µ —Ö–æ—Ç–µ–ª–∫–∏ &rarr;</a>
      </p>
    </div>
    {% endif %}

  </div>{# ‚îÄ‚îÄ end CENTER ‚îÄ‚îÄ #}


  {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT COLUMN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
  <div class="dash-col-right">

    {# ‚îÄ‚îÄ –ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏ ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-upcoming">
      <div class="dash-card-title">–ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏</div>
      {% if upcoming_payments %}
      {% for pay in upcoming_payments %}
      <div class="dash-item" style="flex-direction:column;align-items:flex-start;gap:2px;">
        <div class="dash-item-left">
          &#128197;
          <span>{{ pay.title }}</span>
          <span class="badge clarity-mask {% if pay.kind == 'INCOME' %}badge-income{% elif pay.kind == 'EXPENSE' %}badge-expense{% else %}badge-transfer{% endif %}">
            {{ pay.kind_label }} {{ pay.amount_formatted }}
          </span>
        </div>
        <small class="muted" style="font-size:11px;padding-left:22px;">
          —á–µ—Ä–µ–∑ {{ pay.days_until }} –¥–Ω. ({{ pay.scheduled_date.strftime('%d.%m') }})
        </small>
      </div>
      {% endfor %}
      <p style="margin-top:8px;margin-bottom:0;">
        <a href="/planned-operations" style="font-size:12px;">–í—Å–µ –ø–ª–∞–Ω–æ–≤—ã–µ &rarr;</a>
      </p>
      {% else %}
      <p class="muted" style="font-size:13px;text-align:center;padding:12px 0;">–ù–µ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>
      {% endif %}
    </div>

    {# ‚îÄ‚îÄ –°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è (–ø–æ–¥–ø–∏—Å–∫–∏) ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-expiring-subs">
      <div class="dash-card-title">–°–∫–æ—Ä–æ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è</div>
      {% if expiring_subs %}
      {% for s in expiring_subs %}
      <div class="dash-item" style="flex-direction:column;align-items:flex-start;gap:2px;">
        <div class="dash-item-left">
          <a href="/subscriptions/{{ s.id }}" style="text-decoration:none;color:inherit;font-weight:500;">{{ s.name }}</a>
          <span class="muted" style="font-size:12px;">–¥–æ {{ s.paid_until.strftime('%d.%m.%Y') }}</span>
        </div>
        <small class="muted" style="font-size:11px;padding-left:0;">
          {% if s.days_left == 0 %}—Å–µ–≥–æ–¥–Ω—è{% else %}–æ—Å—Ç–∞–ª–æ—Å—å {{ s.days_left }} –¥–Ω.{% endif %}
        </small>
      </div>
      {% endfor %}
      <p style="margin-top:8px;margin-bottom:0;">
        <a href="/subscriptions" style="font-size:12px;">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ &rarr;</a>
      </p>
      {% else %}
      <p class="muted" style="font-size:13px;text-align:center;padding:12px 0;">–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫ —Å –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π</p>
      {% endif %}
    </div>

    {# ‚îÄ‚îÄ –ü—Ä–æ–≥–Ω–æ–∑ (–∑–∞–≥–ª—É—à–∫–∞) ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-forecast">
      <div class="dash-card-title">–ü—Ä–æ–≥–Ω–æ–∑</div>
      <span class="skel skel-lg w-70"></span>
      <span class="skel skel-md w-60"></span>
      <span class="skel skel-sm w-40"></span>
      <span class="skel skel-sm w-30"></span>
    </div>

    {# ‚îÄ‚îÄ –¶–µ–ª–∏ (–∑–∞–≥–ª—É—à–∫–∞) ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-goals">
      <div class="dash-card-title">–¶–µ–ª–∏</div>
      <span class="skel skel-lg w-60"></span>
      <span class="skel skel-md w-80"></span>
      <span class="skel skel-sm w-40"></span>
      <p style="margin-top:10px;margin-bottom:0;">
        <a href="/goals" style="font-size:12px;">–í—Å–µ —Ü–µ–ª–∏ &rarr;</a>
      </p>
    </div>

  </div>{# ‚îÄ‚îÄ end RIGHT ‚îÄ‚îÄ #}

</div>{# ‚îÄ‚îÄ end dash-v2-grid ‚îÄ‚îÄ #}

{# ‚îÄ‚îÄ –ë—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ‚îÄ‚îÄ #}
<div class="qop-backdrop" id="qopBackdrop" role="dialog" aria-modal="true" aria-labelledby="qopTitle">
  <div class="qop-dialog">
    <div class="qop-title">
      <span id="qopTitle">–ë—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</span>
      <button class="qop-close" id="qopClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&#x2715;</button>
    </div>
    <form method="POST" action="/transactions/create">
      <input type="hidden" name="redirect" value="/">
      <input type="hidden" name="operation_type" id="qopType" value="EXPENSE">

      <div class="qop-field">
        <label>–°—É–º–º–∞</label>
        <input type="number" name="amount" id="qopAmount" step="0.01" min="0.01" placeholder="0.00" required autofocus>
      </div>

      {# –û–¥–∏–Ω –∫–æ—à–µ–ª—ë–∫ (–¥–æ—Ö–æ–¥ / —Ä–∞—Å—Ö–æ–¥) #}
      <div class="qop-field" id="qopWalletRow">
        <label>–ö–æ—à–µ–ª—ë–∫</label>
        <select name="wallet_id" id="qopWallet" onchange="updateQopWalletHint()">
          {% for w in dash_wallets %}
          <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
        <small id="qopWalletHint" style="display:none; color:var(--text-secondary); margin-top:3px; font-size:12px;"></small>
      </div>

      {# –î–≤–∞ –∫–æ—à–µ–ª—å–∫–∞ (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ) #}
      <div class="qop-field" id="qopFromRow" style="display:none;">
        <label>–ò–∑ –∫–æ—à–µ–ª—å–∫–∞</label>
        <select name="from_wallet_id" id="qopFrom" disabled onchange="updateQopFromHint()">
          {% for w in dash_wallets %}
          <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
        <small id="qopFromHint" style="display:none; color:var(--text-secondary); margin-top:3px; font-size:12px;"></small>
      </div>
      <div class="qop-field" id="qopToRow" style="display:none;">
        <label>–í –∫–æ—à–µ–ª—ë–∫</label>
        <select name="to_wallet_id" id="qopTo" disabled onchange="updateQopToHint()">
          {% for w in dash_wallets %}
          <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
        <small id="qopToHint" style="display:none; color:var(--text-secondary); margin-top:3px; font-size:12px;"></small>
      </div>

      {# –ö–∞—Ç–µ–≥–æ—Ä–∏—è #}
      <div class="qop-field" id="qopCategoryRow">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select name="category_id" id="qopCategory">
          <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          {% for c in dash_categories %}
          <option value="{{ c.category_id }}" data-type="{{ c.category_type }}">{{ c.title }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="qop-field">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ <span style="color:var(--text-secondary);">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <input type="text" name="description" id="qopDesc" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–¥—É–∫—Ç—ã">
      </div>

      <div class="qop-field">
        <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è <span style="color:var(--text-secondary);">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <input type="datetime-local" name="occurred_at" id="qopOccurredAt">
        <small style="color:var(--text-secondary); font-size:11px;">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</small>
      </div>

      <div class="qop-actions">
        <button type="button" class="qop-cancel-btn" id="qopCancelBtn">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="qop-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

{# ‚îÄ‚îÄ Quick-task modal ‚îÄ‚îÄ #}
<div class="qt-overlay" id="quickTaskOverlay">
  <div class="qt-modal">
    <div class="qt-modal-header">
      <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
      <button type="button" class="qt-close-btn" id="qtCloseBtn">&times;</button>
    </div>
    {% set task_form_redirect = "/" %}
    {% include "tasks/_task_form.html" %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var qopWalletBalanceMap = {
  {% for w in dash_wallets %}
  "{{ w.wallet_id }}": { balance: {{ w.balance }}, currency: "{{ w.currency }}" }{{ "," if not loop.last }}
  {% endfor %}
};

function fmtQopBalance(amount, currency) {
  var n = Math.round(Math.abs(amount)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '\u00a0');
  var sym = currency === 'RUB' ? '\u20bd' : currency;
  return '–ë–∞–ª–∞–Ω—Å: ' + (amount < 0 ? '\u2212' : '') + n + '\u00a0' + sym;
}

function showQopHint(id, amount, currency) {
  var el = document.getElementById(id);
  if (!el) return;
  if (amount === undefined || amount === null) { el.style.display = 'none'; return; }
  el.textContent = fmtQopBalance(amount, currency);
  el.style.display = 'block';
}

function updateQopWalletHint() {
  var sel = document.getElementById('qopWallet');
  var info = qopWalletBalanceMap[sel ? sel.value : ''];
  showQopHint('qopWalletHint', info ? info.balance : undefined, info ? info.currency : '');
}
function updateQopFromHint() {
  var sel = document.getElementById('qopFrom');
  var info = qopWalletBalanceMap[sel ? sel.value : ''];
  showQopHint('qopFromHint', info ? info.balance : undefined, info ? info.currency : '');
}
function updateQopToHint() {
  var sel = document.getElementById('qopTo');
  var info = qopWalletBalanceMap[sel ? sel.value : ''];
  showQopHint('qopToHint', info ? info.balance : undefined, info ? info.currency : '');
}
</script>
<script src="/static/js/dashboard-actions.js"></script>

<script>
/* ‚îÄ‚îÄ Task form logic (shared with tasks page) ‚îÄ‚îÄ */
(function() {
  var mode = 'once';
  var btnOnce = document.getElementById('btnOnce');
  var btnRecurring = document.getElementById('btnRecurring');
  var blockOnce = document.getElementById('blockOnce');
  var blockRecurring = document.getElementById('blockRecurring');
  var taskMode = document.getElementById('taskMode');
  var taskFreq = document.getElementById('taskFreq');
  var blockWeekdays = document.getElementById('blockWeekdays');
  var blockMonthday = document.getElementById('blockMonthday');

  window.setMode = function(m) {
    mode = m;
    taskMode.value = m;
    if (m === 'once') {
      btnOnce.className = 'seg-active';
      btnRecurring.className = '';
      blockOnce.style.display = '';
      blockRecurring.style.display = 'none';
    } else {
      btnOnce.className = '';
      btnRecurring.className = 'seg-active';
      blockOnce.style.display = 'none';
      blockRecurring.style.display = '';
      toggleFreqFields();
    }
  };

  function toggleFreqFields() {
    var freq = taskFreq.value;
    blockWeekdays.style.display = freq === 'WEEKLY' ? '' : 'none';
    blockMonthday.style.display = freq === 'MONTHLY' ? '' : 'none';
  }
  taskFreq.addEventListener('change', toggleFreqFields);
  toggleFreqFields();

  var dueKind = 'NONE';
  var dkButtons = {
    NONE: document.getElementById('dkNone'),
    DATE: document.getElementById('dkDate'),
    DATETIME: document.getElementById('dkDatetime'),
    WINDOW: document.getElementById('dkWindow'),
  };
  var blockDueDate = document.getElementById('blockDueDate');
  var blockDueTime = document.getElementById('blockDueTime');
  var blockDueWindow = document.getElementById('blockDueWindow');
  var blockReminders = document.getElementById('blockReminders');
  var dueKindInput = document.getElementById('dueKind');

  window.setDueKind = function(kind) {
    dueKind = kind;
    dueKindInput.value = kind;
    for (var k in dkButtons) {
      dkButtons[k].className = (k === kind) ? 'seg-active' : '';
    }
    blockDueDate.style.display = (kind !== 'NONE') ? '' : 'none';
    blockDueTime.style.display = (kind === 'DATETIME') ? '' : 'none';
    blockDueWindow.style.display = (kind === 'WINDOW') ? '' : 'none';
    blockReminders.style.display = (kind === 'DATETIME' || kind === 'WINDOW') ? '' : 'none';
    if (kind !== 'DATETIME' && kind !== 'WINDOW') {
      _reminders = [];
      renderReminderChips();
    }
  };

  var _reminders = [];
  var reminderChips = document.getElementById('reminderChips');
  var reminderPresetSelect = document.getElementById('reminderPresetSelect');
  var customReminderBlock = document.getElementById('customReminderBlock');
  var remindersJsonInput = document.getElementById('remindersJson');

  function renderReminderChips() {
    reminderChips.innerHTML = '';
    _reminders.forEach(function(rem, idx) {
      var chip = document.createElement('span');
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:var(--bg-table-header, #e9ecef);padding:4px 10px;border-radius:12px;font-size:12px;';
      chip.textContent = formatOffset(rem.offset_minutes);
      var closeBtn = document.createElement('span');
      closeBtn.textContent = '\u00d7';
      closeBtn.style.cssText = 'cursor:pointer;font-weight:700;color:#888;margin-left:2px;';
      closeBtn.onclick = (function(i) {
        return function() { _reminders.splice(i, 1); renderReminderChips(); };
      })(idx);
      chip.appendChild(closeBtn);
      reminderChips.appendChild(chip);
    });
    remindersJsonInput.value = _reminders.length ? JSON.stringify(_reminders) : '';
  }

  function formatOffset(minutes) {
    if (minutes === 0) return '–í –º–æ–º–µ–Ω—Ç —Å—Ä–æ–∫–∞';
    var abs = Math.abs(minutes);
    if (abs < 60) return '–ó–∞ ' + abs + ' –º–∏–Ω';
    if (abs % 60 === 0 && abs < 1440) return '–ó–∞ ' + (abs / 60) + ' —á';
    if (abs === 1440) return '–ó–∞ 1 –¥–µ–Ω—å';
    if (abs % 1440 === 0) return '–ó–∞ ' + (abs / 1440) + ' –¥–Ω';
    return '–ó–∞ ' + abs + ' –º–∏–Ω';
  }

  function addReminder(offsetMinutes) {
    if (_reminders.length >= 5) return;
    if (_reminders.some(function(r) { return r.offset_minutes === offsetMinutes; })) return;
    _reminders.push({offset_minutes: offsetMinutes});
    renderReminderChips();
  }

  if (reminderPresetSelect) {
    reminderPresetSelect.addEventListener('change', function() {
      var val = this.value;
      if (val === '__custom__') {
        customReminderBlock.style.display = 'flex';
      } else if (val !== '') {
        addReminder(parseInt(val, 10));
        customReminderBlock.style.display = 'none';
      }
      this.value = '';
    });
  }

  window.addCustomReminder = function() {
    var input = document.getElementById('customReminderMinutes');
    var minutes = parseInt(input.value, 10);
    if (isNaN(minutes) || minutes < 0) return;
    addReminder(-minutes);
    input.value = '';
    customReminderBlock.style.display = 'none';
  };

  renderReminderChips();
})();

/* ‚îÄ‚îÄ Task preset pre-fill ‚îÄ‚îÄ */
function applyTaskPreset(presetId) {
  var sel = document.getElementById('presetSelect');
  if (!sel) return;
  var opt = sel.options[sel.selectedIndex];
  var form = document.getElementById('taskForm');
  var titleInput = form.querySelector('input[name="title"]');
  var noteInput  = form.querySelector('input[name="note"]');
  var catSelect  = form.querySelector('select[name="category_id"]');

  if (!presetId) {
    if (titleInput) titleInput.value = '';
    if (noteInput)  noteInput.value = '';
    if (catSelect)  catSelect.value = '';
    return;
  }
  if (titleInput) titleInput.value = opt.dataset.title || '';
  if (noteInput)  noteInput.value = opt.dataset.note || '';
  if (catSelect)  catSelect.value = opt.dataset.category || '';
}

/* ‚îÄ‚îÄ Multi-date chips ‚îÄ‚îÄ */
(function() {
  var _dates = [];
  var chipsEl = document.getElementById('multiDateChips');
  var hiddenEl = document.getElementById('multiDatesJson');
  var hintEl = document.getElementById('multiDateHint');

  function renderChips() {
    if (!chipsEl) return;
    _dates.sort();
    chipsEl.innerHTML = '';
    _dates.forEach(function(d, idx) {
      var parts = d.split('-');
      var label = parts[2] + '.' + parts[1] + '.' + parts[0];
      var chip = document.createElement('span');
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:var(--bg-table-header, #e9ecef);padding:4px 10px;border-radius:12px;font-size:12px;';
      chip.textContent = label;
      var closeBtn = document.createElement('span');
      closeBtn.textContent = '\u00d7';
      closeBtn.style.cssText = 'cursor:pointer;font-weight:700;color:#888;margin-left:2px;';
      closeBtn.onclick = (function(i) {
        return function() { _dates.splice(i, 1); renderChips(); };
      })(idx);
      chip.appendChild(closeBtn);
      chipsEl.appendChild(chip);
    });
    hiddenEl.value = _dates.length ? _dates.join(',') : '';
    if (hintEl) hintEl.style.display = _dates.length ? 'none' : 'block';
  }

  window.addMultiDate = function() {
    var input = document.getElementById('inputMultiDate');
    if (!input || !input.value) return;
    var val = input.value;
    if (_dates.indexOf(val) !== -1) return;
    _dates.push(val);
    input.value = '';
    renderChips();
  };

  window.toggleMultiDates = function() {
    var chk = document.getElementById('chkMultiDates');
    var blockMulti = document.getElementById('blockMultiDates');
    var blockSwitcher = document.getElementById('blockDueKindSwitcher');
    var blockDate = document.getElementById('blockDueDate');
    var blockTime = document.getElementById('blockDueTime');
    var blockWindow = document.getElementById('blockDueWindow');
    var blockReminders = document.getElementById('blockReminders');

    if (chk && chk.checked) {
      if (blockSwitcher) blockSwitcher.style.display = 'none';
      if (blockDate) blockDate.style.display = 'none';
      if (blockTime) blockTime.style.display = 'none';
      if (blockWindow) blockWindow.style.display = 'none';
      if (blockReminders) blockReminders.style.display = 'none';
      if (blockMulti) blockMulti.style.display = '';
      var dueKindInput = document.getElementById('dueKind');
      if (dueKindInput) dueKindInput.value = 'DATE';
    } else {
      if (blockSwitcher) blockSwitcher.style.display = '';
      if (blockMulti) blockMulti.style.display = 'none';
      if (window.setDueKind) {
        var cur = document.getElementById('dueKind');
        window.setDueKind(cur ? cur.value : 'NONE');
      }
      _dates = [];
      renderChips();
    }
  };

  renderChips();
})();

/* ‚îÄ‚îÄ Quick-task modal open/close ‚îÄ‚îÄ */
(function() {
  var overlay = document.getElementById('quickTaskOverlay');
  var openBtn = document.getElementById('openQuickTask');
  var closeBtn = document.getElementById('qtCloseBtn');

  function openModal(e) {
    e.preventDefault();
    overlay.classList.add('open');
  }
  function closeModal() {
    overlay.classList.remove('open');
  }

  if (openBtn) openBtn.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);

  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) closeModal();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlay.classList.contains('open')) closeModal();
  });
})();
</script>
{% endblock %}
