{% extends "base.html" %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è ‚Äî FinLife{% endblock %}

{% macro fmt(val) %}{{ "{:,.0f}".format(val).replace(",", " ") }}{% endmacro %}

{% block extra_head %}<style>
/* ‚îÄ‚îÄ Dashboard v2 grid ‚îÄ‚îÄ */
.dash-v2-grid {
  display: grid;
  grid-template-columns: 320px 1fr 320px;
  gap: 16px;
  align-items: start;
  margin-top: 16px;
}
.dash-col-left,
.dash-col-center,
.dash-col-right {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ‚îÄ‚îÄ dash-card component ‚îÄ‚îÄ */
.dash-card {
  border-radius: 12px;
  border: 1px solid var(--border-color);
  background: var(--bg-card);
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.dash-card-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 14px;
}

/* ‚îÄ‚îÄ Skeleton placeholders ‚îÄ‚îÄ */
.skel {
  background: var(--border-color);
  border-radius: 6px;
  opacity: 0.45;
  display: block;
}
.skel-lg  { height: 32px; margin-bottom: 10px; }
.skel-md  { height: 14px; margin-bottom: 8px;  }
.skel-sm  { height: 10px; margin-bottom: 6px;  }
.w-30 { width: 30%; }
.w-40 { width: 40%; }
.w-60 { width: 60%; }
.w-70 { width: 70%; }
.w-80 { width: 80%; }

/* ‚îÄ‚îÄ Remove max-width on dashboard ‚îÄ‚îÄ */
.main-content { max-width: none; }

/* ‚îÄ‚îÄ Finance state card (#dash-fin-state) ‚îÄ‚îÄ */
.fs-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border-color);
}
.fs-row:last-of-type { border-bottom: none; }
.fs-label {
  font-size: 13px;
  color: var(--text-secondary);
  text-decoration: none;
}
a.fs-label:hover { color: var(--text-primary); }
.fs-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 3px;
}
.fs-amount {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}
.fs-delta {
  font-size: 12px;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}
.fs-delta--up   { color: #2e7d32; }
.fs-delta--down { color: #c62828; }
.fs-delta--zero { color: var(--text-secondary); }
.fs-monthly {
  margin-top: 14px;
  padding-top: 12px;
  border-top: 2px solid var(--border-color);
}
.fs-net-row {
  padding: 0;
  border-bottom: none;
}
.fs-net {
  font-size: 17px;
  font-weight: 700;
}
.fs-sub {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
  line-height: 1.4;
}

/* ‚îÄ‚îÄ Progress bar (shared) ‚îÄ‚îÄ */
.progress {
  height: 7px;
  border-radius: 999px;
  background: var(--border-color);
  overflow: hidden;
}
.progress__fill {
  height: 100%;
  background: var(--accent);
  border-radius: 999px;
}

/* ‚îÄ‚îÄ Level card (#dash-level) ‚îÄ‚îÄ */
a.dash-card-link {
  text-decoration: none;
  display: block;
}
.lv-main {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 10px;
}
.lv-num {
  font-size: 30px;
  font-weight: 700;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}
.lv-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
}
.lv-progress { margin-bottom: 8px; }
.lv-xp-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2px;
}
.lv-xp-main {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
}
.lv-xp-next {
  font-size: 12px;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}
.lv-month {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 8px;
  font-variant-numeric: tabular-nums;
}

/* ‚îÄ‚îÄ Activity card (#dash-activity) ‚îÄ‚îÄ */
.act-index {
  display: flex;
  align-items: baseline;
  gap: 2px;
  margin-bottom: 6px;
}
.act-num {
  font-size: 34px;
  font-weight: 700;
  color: var(--text-primary);
  font-variant-numeric: tabular-nums;
  line-height: 1;
}
.act-denom {
  font-size: 16px;
  color: var(--text-secondary);
  margin-left: 1px;
}
.act-trend {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-variant-numeric: tabular-nums;
}
.act-trend--up   { color: #2e7d32; }
.act-trend--down { color: #c62828; }
.act-trend--zero { color: var(--text-secondary); }
.act-trend-label {
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 400;
}
.act-sub {
  font-size: 12px;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

/* ‚îÄ‚îÄ Tablet: left+center side-by-side, right below ‚îÄ‚îÄ */
@media (max-width: 1199px) {
  .dash-v2-grid {
    grid-template-columns: 1fr 1fr;
  }
  .dash-col-right {
    grid-column: 1 / -1;
    flex-direction: row;
    flex-wrap: wrap;
  }
  .dash-col-right > .dash-card {
    flex: 1 1 240px;
  }
}

/* ‚îÄ‚îÄ Mobile: single column ‚îÄ‚îÄ */
@media (max-width: 767px) {
  .dash-v2-grid {
    grid-template-columns: 1fr;
  }
  .dash-col-right {
    grid-column: 1;
    flex-direction: column;
  }
  .dash-col-right > .dash-card {
    flex: none;
  }
}

/* ‚îÄ‚îÄ Focus card (#dash-focus) ‚îÄ‚îÄ */
.focus-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 0; border-bottom: 1px solid var(--border-color);
}
.focus-item:last-child { border-bottom: none; }
.focus-item-label { flex: 1; font-size: 14px; line-height: 1.3; }
.focus-item-date  { font-size: 11px; color: var(--text-secondary); white-space: nowrap; flex-shrink: 0; }
.focus-item--overdue .focus-item-label { color: #c62828; }
.focus-all-done { text-align: center; padding: 20px 0; color: var(--text-secondary); font-size: 14px; }
.focus-overflow { font-size: 12px; color: var(--text-secondary); margin-top: 6px; margin-bottom: 0; }

/* ‚îÄ‚îÄ Feed card (#dash-feed) ‚îÄ‚îÄ */
.feed-day { margin-bottom: 14px; }
.feed-day:last-child { margin-bottom: 0; }
.feed-day-header {
  font-size: 11px; font-weight: 700; color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: .06em;
  margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color);
}
.feed-event { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
.feed-event-time  { font-size: 12px; color: var(--text-secondary);
                    font-variant-numeric: tabular-nums; min-width: 34px; flex-shrink: 0; }
.feed-event-icon  { font-size: 13px; flex-shrink: 0; }
.feed-event-title { flex: 1; font-size: 13px; }
.feed-event-amount { font-size: 13px; font-weight: 600; font-variant-numeric: tabular-nums; flex-shrink: 0; }
.feed-event-amount--income   { color: #2e7d32; }
.feed-event-amount--expense  { color: #c62828; }
.feed-event-amount--transfer { color: var(--text-secondary); }
.feed-cancel-btn {
  background: none; border: none; cursor: pointer; padding: 2px 5px;
  font-size: 14px; color: var(--text-secondary); opacity: 0.4; line-height: 1;
  flex-shrink: 0; border-radius: 4px;
}
.feed-cancel-btn:hover { opacity: 1; color: #c62828; background: rgba(198,40,40,.08); }

/* ‚îÄ‚îÄ Quick-op modal ‚îÄ‚îÄ */
.qop-backdrop {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.35); align-items: center; justify-content: center;
}
.qop-backdrop.qop-open { display: flex; }
.qop-dialog {
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,.18);
  width: min(360px, calc(100vw - 32px)); padding: 20px 22px;
}
.qop-title {
  font-size: 15px; font-weight: 600; margin: 0 0 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.qop-close {
  background: none; border: none; cursor: pointer; font-size: 18px;
  color: var(--text-secondary); line-height: 1; padding: 0 2px;
}
.qop-close:hover { color: var(--text-primary); }
.qop-field { margin-bottom: 12px; }
.qop-field label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.qop-field input, .qop-field select {
  width: 100%; padding: 8px 10px; font-size: 14px;
  background: var(--bg-page); border: 1px solid var(--border-color);
  border-radius: 8px; color: var(--text-primary); box-sizing: border-box;
}
.qop-field input:focus, .qop-field select:focus {
  outline: none; border-color: var(--accent, #4a90d9);
}
.qop-actions { display: flex; gap: 8px; margin-top: 16px; }
.qop-submit {
  flex: 1; padding: 9px 0; font-size: 14px; font-weight: 600;
  background: var(--accent, #4a90d9); color: #fff;
  border: none; border-radius: 10px; cursor: pointer;
  transition: opacity .15s;
}
.qop-submit:hover { opacity: .88; }
.qop-cancel-btn {
  padding: 9px 16px; font-size: 14px;
  background: transparent; border: 1px solid var(--border-color);
  border-radius: 10px; cursor: pointer; color: var(--text-secondary);
}
.qop-cancel-btn:hover { background: var(--bg-hover, rgba(128,128,128,.1)); }

/* ‚îÄ‚îÄ Quick operation dropdown ‚îÄ‚îÄ */
.dash-card-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.dash-card-header .dash-card-title { margin-bottom: 0; }
.quick-op-wrapper { position: relative; }
.quick-op-btn {
  font-size: 13px; padding: 5px 10px; border-radius: 10px;
  background: transparent; border: 1px solid var(--border-color);
  color: var(--text-secondary); cursor: pointer; white-space: nowrap;
  transition: background .15s, color .15s;
  line-height: 1.4;
}
.quick-op-btn:hover { background: var(--bg-hover, rgba(128,128,128,.1)); color: var(--text-primary); }
.quick-op-menu {
  position: absolute; right: 0; top: calc(100% + 5px); z-index: 200;
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,.12);
  min-width: 160px; overflow: hidden;
}
.quick-op-menu a {
  display: block; padding: 10px 16px; font-size: 13px;
  color: var(--text-primary); text-decoration: none;
  transition: background .12s;
}
.quick-op-menu a:hover { background: var(--bg-hover, rgba(128,128,128,.08)); }
</style>{% endblock %}

{% block content %}
{% set wish_type_labels = {
    'PURCHASE': 'üí∞ –ü–æ–∫—É–ø–∫–∏',
    'EVENT': 'üéâ –°–æ–±—ã—Ç–∏—è',
    'PLACE': 'üåç –ú–µ—Å—Ç–∞',
    'OTHER': 'üìù –î—Ä—É–≥–æ–µ'
} %}
{% set wish_status_labels = {
    'IDEA': 'üí°',
    'CONSIDERING': 'ü§î',
    'PLANNED': 'üìÖ'
} %}
{% set has_wishes = wishes_this_month.PURCHASE or wishes_this_month.EVENT or wishes_this_month.PLACE or wishes_this_month.OTHER %}

<h1 style="margin-bottom: 0;">
  –ì–ª–∞–≤–Ω–∞—è
  <span class="muted" style="font-weight: 400; font-size: 16px; margin-left: 8px;">{{ today.strftime('%d.%m.%Y') }}</span>
</h1>

<div class="dash-v2-grid">

  {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT COLUMN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
  <div class="dash-col-left">

    {# ‚îÄ‚îÄ –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-fin-state">
      <div class="dash-card-title">–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>

      {# ‚îÄ‚îÄ –û–±—ã—á–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏ ‚îÄ‚îÄ #}
      <div class="fs-row">
        <a href="/wallets" class="fs-label">–û–±—ã—á–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏</a>
        <div class="fs-right">
          <span class="fs-amount">{{ format_money(fin_state.regular_total, "RUB") }}</span>
          <span class="fs-delta fs-delta--{{ fin_state.regular_delta_sign }}">
            {%- if fin_state.regular_delta_sign == "up" -%}
              ‚ñ≤ +{{ fin_state.regular_delta_fmt }}
            {%- elif fin_state.regular_delta_sign == "down" -%}
              ‚ñº ‚àí{{ fin_state.regular_delta_fmt }}
            {%- else -%}
              ‚Ä¢ 0
            {%- endif -%}
          </span>
        </div>
      </div>

      {# ‚îÄ‚îÄ –ö—Ä–µ–¥–∏—Ç—ã ‚îÄ‚îÄ #}
      <div class="fs-row">
        <a href="/wallets" class="fs-label">–ö—Ä–µ–¥–∏—Ç—ã</a>
        <div class="fs-right">
          <span class="fs-amount">{{ format_money(fin_state.credit_total, "RUB") }}</span>
          <span class="fs-delta fs-delta--{{ fin_state.credit_delta_sign }}">
            {%- if fin_state.credit_delta_sign == "up" -%}
              ‚ñ≤ +{{ fin_state.credit_delta_fmt }}
            {%- elif fin_state.credit_delta_sign == "down" -%}
              ‚ñº ‚àí{{ fin_state.credit_delta_fmt }}
            {%- else -%}
              ‚Ä¢ 0
            {%- endif -%}
          </span>
        </div>
      </div>

      {# ‚îÄ‚îÄ –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è ‚îÄ‚îÄ #}
      <div class="fs-row">
        <a href="/goals" class="fs-label">–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</a>
        <div class="fs-right">
          <span class="fs-amount">{{ format_money(fin_state.savings_total, "RUB") }}</span>
          <span class="fs-delta fs-delta--{{ fin_state.savings_delta_sign }}">
            {%- if fin_state.savings_delta_sign == "up" -%}
              ‚ñ≤ +{{ fin_state.savings_delta_fmt }}
            {%- elif fin_state.savings_delta_sign == "down" -%}
              ‚ñº ‚àí{{ fin_state.savings_delta_fmt }}
            {%- else -%}
              ‚Ä¢ 0
            {%- endif -%}
          </span>
        </div>
      </div>

      {# ‚îÄ‚îÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–µ—Å—è—Ü–∞ ‚îÄ‚îÄ #}
      <div class="fs-monthly">
        <div class="fs-row fs-net-row">
          <span class="fs-label">–†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî {{ current_month }}</span>
          <span class="fs-amount fs-net {% if fin_state.month_net >= 0 %}positive{% else %}negative{% endif %}">
            {%- if fin_state.month_net > 0 %}+{% endif -%}
            {{ format_money(fin_state.month_net, "RUB") }}
          </span>
        </div>
        <div class="fs-sub">
          –î–æ—Ö–æ–¥: {{ format_money(fin_state.month_income, "RUB") }}&nbsp;‚Ä¢&nbsp;–†–∞—Å—Ö–æ–¥: {{ format_money(fin_state.month_expense, "RUB") }}
        </div>
      </div>

      <p style="margin-top:12px;margin-bottom:0;">
        <a href="/wallets" style="font-size:12px;">–ö–æ—à–µ–ª—å–∫–∏ &rarr;</a>
        &nbsp;&nbsp;
        <a href="/budget" style="font-size:12px;">–ë—é–¥–∂–µ—Ç &rarr;</a>
      </p>
    </div>

    {# ‚îÄ‚îÄ –£—Ä–æ–≤–µ–Ω—å ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-level">
      <div class="dash-card-title">–£—Ä–æ–≤–µ–Ω—å</div>
      <a href="/profile" class="dash-card-link">
        <div class="lv-main">
          <span class="lv-num">{{ dash_xp.level }}</span>
          <span class="lv-title">{{ dash_xp.level_title }}</span>
        </div>
        <div class="lv-progress">
          <div class="progress">
            <div class="progress__fill" style="width: {{ dash_xp.percent_progress }}%;"></div>
          </div>
        </div>
        <div class="lv-xp-row">
          <span class="lv-xp-main">{{ dash_xp.current_level_xp }} / {{ dash_xp.total_level_target }} XP</span>
          <span class="lv-xp-next">‚àí{{ dash_xp.xp_to_next_level }} XP</span>
        </div>
        {% if dash_xp.xp_this_month > 0 %}
        <div class="lv-month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü: {{ dash_xp.xp_this_month }} XP</div>
        {% endif %}
      </a>
    </div>

    {# ‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-activity">
      <div class="dash-card-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      <a href="/profile" class="dash-card-link">
        <div class="act-index">
          <span class="act-num">{{ dash_activity.activity_index }}</span>
          <span class="act-denom"> / 100</span>
        </div>
        <div class="act-trend act-trend--{{ dash_activity.trend_sign }}">
          {%- if dash_activity.trend_sign == "up" -%}‚ñ≤ +{{ dash_activity.trend_abs }}
          {%- elif dash_activity.trend_sign == "down" -%}‚ñº ‚àí{{ dash_activity.trend_abs }}
          {%- else -%}‚Ä¢ 0{%- endif -%}
          <span class="act-trend-label"> –∑–∞ –Ω–µ–¥–µ–ª—é</span>
        </div>
        <div class="act-sub">7–¥: {{ dash_activity.points_7d }} ‚Ä¢ –ø—Ä–µ–¥: {{ dash_activity.points_prev_7d }}</div>
      </a>
    </div>

  </div>{# ‚îÄ‚îÄ end LEFT ‚îÄ‚îÄ #}


  {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CENTER COLUMN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
  <div class="dash-col-center">

    {# ‚îÄ‚îÄ –§–æ–∫—É—Å –¥–Ω—è ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-focus">
      <div class="dash-card-header">
        <div class="dash-card-title">–§–æ–∫—É—Å –¥–Ω—è</div>
        <div class="quick-op-wrapper" id="quickOpWrapper">
          <button class="quick-op-btn" type="button" aria-haspopup="true" aria-expanded="false">+ –ë—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</button>
          <div class="quick-op-menu" hidden>
            <a href="#" data-type="INCOME">–î–æ—Ö–æ–¥</a>
            <a href="#" data-type="EXPENSE">–†–∞—Å—Ö–æ–¥</a>
            <a href="#" data-type="TRANSFER">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</a>
          </div>
        </div>
      </div>
      {% set has_focus = focus_overdue or focus_tasks or focus_habits %}

      {# –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ #}
      {% for item in focus_overdue %}
      <div class="focus-item focus-item--overdue">
        <span class="focus-item-date">{{ item.date.strftime('%d.%m') }} &#9650;</span>
        <span class="focus-item-label">
          {% if item.category_emoji %}{{ item.category_emoji }} {% endif %}{{ item.title }}
        </span>
        {% if item.kind == "task" %}
        <form method="POST" action="/plan/tasks/{{ item.meta.task_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="btn-icon" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">&#10003;</button>
        </form>
        {% elif item.kind == "task_occ" %}
        <form method="POST" action="/plan/task-occurrences/{{ item.meta.occurrence_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="btn-icon" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">&#10003;</button>
        </form>
        {% endif %}
      </div>
      {% endfor %}

      {# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è #}
      {% for item in focus_tasks %}
      <div class="focus-item">
        <span class="focus-item-label">
          {% if item.category_emoji %}{{ item.category_emoji }} {% endif %}{{ item.title }}
        </span>
        {% if item.kind == "task" %}
        <form method="POST" action="/plan/tasks/{{ item.meta.task_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="btn-icon" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">&#10003;</button>
        </form>
        {% elif item.kind == "task_occ" %}
        <form method="POST" action="/plan/task-occurrences/{{ item.meta.occurrence_id }}/complete" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="btn-icon" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">&#10003;</button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
      {% if focus_tasks_overflow %}
      <p class="focus-overflow"><a href="/tasks">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ &rarr;</a></p>
      {% endif %}

      {# –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ —Å–µ–≥–æ–¥–Ω—è #}
      {% for item in focus_habits %}
      <div class="focus-item">
        <span class="focus-item-label">
          {% if item.category_emoji %}{{ item.category_emoji }} {% endif %}{{ item.title }}
          {% if item.meta.current_streak > 0 %}
          <small class="muted">&#128293; {{ item.meta.current_streak }}–¥</small>
          {% endif %}
        </span>
        <form method="POST" action="/plan/habit-occurrences/{{ item.meta.occurrence_id }}/toggle" style="margin:0;">
          <input type="hidden" name="redirect" value="/">
          <button type="submit" class="btn-icon" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">&#10003;</button>
        </form>
      </div>
      {% endfor %}
      {% if focus_habits_overflow %}
      <p class="focus-overflow"><a href="/habits">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–∏–≤—ã—á–∫–∏ &rarr;</a></p>
      {% endif %}

      {% if not has_focus %}
      <div class="focus-all-done">–°–µ–≥–æ–¥–Ω—è –≤—Å—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–æ &#10003;</div>
      {% endif %}

      <p style="margin-top:10px;margin-bottom:0;font-size:12px;">
        <a href="/plan">–û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞–Ω &rarr;</a>
      </p>
    </div>

    {# ‚îÄ‚îÄ –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-feed">
      <div class="dash-card-title">–õ–µ–Ω—Ç–∞</div>
      {% if feed_groups %}
      {% for group in feed_groups %}
      <div class="feed-day">
        <div class="feed-day-header">{{ group.label }}</div>
        {% for item in group.events %}
        <div class="feed-event">
          <span class="feed-event-time">{{ item.time_str }}</span>
          <span class="feed-event-icon">{{ item.icon }}</span>
          <span class="feed-event-title">{{ item.title }}</span>
          {% if item.amount_fmt %}
          <span class="feed-event-amount feed-event-amount--{{ item.amount_sign }}">{{ item.amount_fmt }}</span>
          {% endif %}
          {% if item.cancel_url %}
          <form method="POST" action="{{ item.cancel_url }}" style="margin:0;">
            <input type="hidden" name="redirect" value="/">
            <button type="submit" class="feed-cancel-btn" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚úï</button>
          </form>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endfor %}
      {% else %}
      <p class="muted" style="text-align:center;padding:16px 0;font-size:13px;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –∑–∞ 7 –¥–Ω–µ–π</p>
      {% endif %}
    </div>

    {# ‚îÄ‚îÄ –•–æ—Ç–µ–ª–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ ‚îÄ‚îÄ #}
    {% if has_wishes %}
    <div class="dash-card">
      <div class="dash-card-title">–•–æ—Ç–µ–ª–∫–∏ ‚Äî {{ current_month }}</div>
      {% for wish_type in ['PURCHASE', 'EVENT', 'PLACE', 'OTHER'] %}
        {% set wishes = wishes_this_month[wish_type] %}
        {% if wishes %}
        <div class="dash-group" style="margin-bottom:12px;">
          <div class="dash-group-label">{{ wish_type_labels[wish_type] }} ({{ wishes|length }})</div>
          {% for wish in wishes %}
          <div class="dash-item" style="padding:8px 0;border-bottom:1px solid var(--border-color);">
            <div class="dash-item-left">
              {{ wish_status_labels.get(wish.status, '') }}
              <span>{{ wish.title }}</span>
              {% if wish.estimated_amount %}
              <span class="badge" style="background:#e8f5e9;color:#2e7d32;">
                {{ "{:,.2f}".format(wish.estimated_amount).replace(',', ' ') }} —Ä—É–±.
              </span>
              {% endif %}
              {% if wish.is_recurring %}
              <span class="badge" style="background:#e3f2fd;color:#1976d2;">‚ôªÔ∏è</span>
              {% endif %}
              {% if wish.target_date %}
              <small class="muted">{{ wish.target_date.strftime('%d.%m.%Y') }}</small>
              {% elif wish.target_month %}
              <small class="muted">–≤–µ—Å—å –º–µ—Å—è—Ü</small>
              {% endif %}
            </div>
            <div class="dash-item-actions">
              <a href="/wishes/{{ wish.wish_id }}/edit"
                 style="font-size:18px;text-decoration:none;color:var(--text-secondary);">‚öôÔ∏è</a>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      {% endfor %}
      <p style="margin-top:8px;margin-bottom:0;">
        <a href="/wishes" style="font-size:12px;">–í—Å–µ —Ö–æ—Ç–µ–ª–∫–∏ &rarr;</a>
      </p>
    </div>
    {% endif %}

  </div>{# ‚îÄ‚îÄ end CENTER ‚îÄ‚îÄ #}


  {# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT COLUMN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
  <div class="dash-col-right">

    {# ‚îÄ‚îÄ –ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏ ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-upcoming">
      <div class="dash-card-title">–ë–ª–∏–∂–∞–π—à–∏–µ –ø–ª–∞—Ç–µ–∂–∏</div>
      {% if upcoming_payments %}
      {% for pay in upcoming_payments %}
      <div class="dash-item" style="flex-direction:column;align-items:flex-start;gap:2px;">
        <div class="dash-item-left">
          &#128197;
          <span>{{ pay.title }}</span>
          <span class="badge {% if pay.kind == 'INCOME' %}badge-income{% elif pay.kind == 'EXPENSE' %}badge-expense{% else %}badge-transfer{% endif %}">
            {{ pay.kind_label }} {{ pay.amount_formatted }}
          </span>
        </div>
        <small class="muted" style="font-size:11px;padding-left:22px;">
          —á–µ—Ä–µ–∑ {{ pay.days_until }} –¥–Ω. ({{ pay.scheduled_date.strftime('%d.%m') }})
        </small>
      </div>
      {% endfor %}
      <p style="margin-top:8px;margin-bottom:0;">
        <a href="/planned-operations" style="font-size:12px;">–í—Å–µ –ø–ª–∞–Ω–æ–≤—ã–µ &rarr;</a>
      </p>
      {% else %}
      <p class="muted" style="font-size:13px;text-align:center;padding:12px 0;">–ù–µ—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>
      {% endif %}
    </div>

    {# ‚îÄ‚îÄ –ü—Ä–æ–≥–Ω–æ–∑ (–∑–∞–≥–ª—É—à–∫–∞) ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-forecast">
      <div class="dash-card-title">–ü—Ä–æ–≥–Ω–æ–∑</div>
      <span class="skel skel-lg w-70"></span>
      <span class="skel skel-md w-60"></span>
      <span class="skel skel-sm w-40"></span>
      <span class="skel skel-sm w-30"></span>
    </div>

    {# ‚îÄ‚îÄ –¶–µ–ª–∏ (–∑–∞–≥–ª—É—à–∫–∞) ‚îÄ‚îÄ #}
    <div class="dash-card" id="dash-goals">
      <div class="dash-card-title">–¶–µ–ª–∏</div>
      <span class="skel skel-lg w-60"></span>
      <span class="skel skel-md w-80"></span>
      <span class="skel skel-sm w-40"></span>
      <p style="margin-top:10px;margin-bottom:0;">
        <a href="/goals" style="font-size:12px;">–í—Å–µ —Ü–µ–ª–∏ &rarr;</a>
      </p>
    </div>

  </div>{# ‚îÄ‚îÄ end RIGHT ‚îÄ‚îÄ #}

</div>{# ‚îÄ‚îÄ end dash-v2-grid ‚îÄ‚îÄ #}

{# ‚îÄ‚îÄ –ë—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è ‚Äî –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ‚îÄ‚îÄ #}
<div class="qop-backdrop" id="qopBackdrop" role="dialog" aria-modal="true" aria-labelledby="qopTitle">
  <div class="qop-dialog">
    <div class="qop-title">
      <span id="qopTitle">–ë—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</span>
      <button class="qop-close" id="qopClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&#x2715;</button>
    </div>
    <form method="POST" action="/transactions/create">
      <input type="hidden" name="redirect" value="/">
      <input type="hidden" name="operation_type" id="qopType" value="EXPENSE">

      <div class="qop-field">
        <label>–°—É–º–º–∞</label>
        <input type="number" name="amount" id="qopAmount" step="0.01" min="0.01" placeholder="0.00" required autofocus>
      </div>

      {# –û–¥–∏–Ω –∫–æ—à–µ–ª—ë–∫ (–¥–æ—Ö–æ–¥ / —Ä–∞—Å—Ö–æ–¥) #}
      <div class="qop-field" id="qopWalletRow">
        <label>–ö–æ—à–µ–ª—ë–∫</label>
        <select name="wallet_id" id="qopWallet">
          {% for w in dash_wallets %}
          <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
      </div>

      {# –î–≤–∞ –∫–æ—à–µ–ª—å–∫–∞ (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ) #}
      <div class="qop-field" id="qopFromRow" style="display:none;">
        <label>–ò–∑ –∫–æ—à–µ–ª—å–∫–∞</label>
        <select name="from_wallet_id" id="qopFrom" disabled>
          {% for w in dash_wallets %}
          <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="qop-field" id="qopToRow" style="display:none;">
        <label>–í –∫–æ—à–µ–ª—ë–∫</label>
        <select name="to_wallet_id" id="qopTo" disabled>
          {% for w in dash_wallets %}
          <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
      </div>

      <div class="qop-field">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ <span style="color:var(--text-secondary);">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <input type="text" name="description" id="qopDesc" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–æ–¥—É–∫—Ç—ã">
      </div>

      <div class="qop-actions">
        <button type="button" class="qop-cancel-btn" id="qopCancelBtn">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="qop-submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/dashboard-actions.js"></script>
{% endblock %}
