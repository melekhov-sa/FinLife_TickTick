{% extends "base.html" %}
{% block title %}Задачи - FinLife{% endblock %}

{% block content %}
<style>
/* ── Task create card ── */
.task-create-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 24px;
}
.task-create-card {
  max-width: 720px;
  width: 100%;
}
.task-form-grid {
  display: grid;
  grid-template-columns: 1.4fr 1fr;
  gap: 10px 16px;
}
.task-form-grid .span-full { grid-column: 1 / -1; }
@media (max-width: 820px) {
  .task-form-grid { grid-template-columns: 1fr; }
  .task-form-grid .span-full { grid-column: 1; }
}
/* ── Segmented control ── */
.seg-control {
  display: inline-flex;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border-color);
  background: var(--bg-input, #fff);
}
.seg-control button {
  flex: 1;
  border: none;
  border-radius: 0;
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 500;
  min-height: unset;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
}
.seg-control button:not(:last-child) {
  border-right: 1px solid var(--border-color);
}
.seg-control button:hover {
  background: var(--bg-table-header, #f0f0f0);
  color: var(--text-primary);
}
.seg-control button.seg-active {
  background: var(--accent);
  color: #fff;
}
.seg-control button.seg-active:hover {
  background: var(--accent-hover);
}
/* ── Compact form tweaks ── */
.task-form-grid label {
  margin-top: 0;
  margin-bottom: 2px;
  font-size: 13px;
}
.task-form-grid .form-row {
  margin-bottom: 0;
}
.task-form-grid input,
.task-form-grid select {
  max-width: 100%;
  height: 36px;
  font-size: 13px;
}
.task-form-grid textarea {
  max-width: 100%;
  font-size: 13px;
}
.task-form-grid details {
  margin-bottom: 0;
}
.task-form-submit {
  display: flex;
  justify-content: flex-start;
  padding-top: 4px;
}
.task-form-submit button[type="submit"] {
  min-width: 120px;
}
</style>
<h1>Задачи</h1>

<!-- One-off tasks -->
<div class="card">
  <h2>Разовые задачи</h2>
  {% set active_tasks = tasks | selectattr('status', 'equalto', 'ACTIVE') | list %}
  {% set done_tasks = tasks | selectattr('status', 'equalto', 'DONE') | list %}

  {% if active_tasks %}
    <table>
      <thead>
        <tr><th>Задача</th><th>Срок</th><th>Действия</th></tr>
      </thead>
      <tbody>
        {% for task in active_tasks %}
        <tr>
          <td>
            {{ task.title }}
            {% if task.note %}<br><small class="muted">{{ task.note }}</small>{% endif %}
          </td>
          <td class="{% if task.due_date and task.due_date < today %}negative{% endif %}">
            {% if task.due_kind == 'DATETIME' %}
              {{ task.due_date.strftime('%d.%m') }} {{ task.due_time.strftime('%H:%M') if task.due_time else '' }}
            {% elif task.due_kind == 'WINDOW' %}
              {{ task.due_date.strftime('%d.%m') }} {{ task.due_start_time.strftime('%H:%M') if task.due_start_time else '' }}–{{ task.due_end_time.strftime('%H:%M') if task.due_end_time else '' }}
            {% elif task.due_date %}
              {{ task.due_date.strftime('%d.%m.%Y') }}
            {% else %}
              —
            {% endif %}
          </td>
          <td style="white-space: nowrap;">
            <form method="POST" action="/tasks/{{ task.task_id }}/complete" style="display:inline;">
              <button type="submit" style="font-size: 12px; padding: 4px 10px;">Выполнить</button>
            </form>
            <form method="POST" action="/tasks/{{ task.task_id }}/archive" style="display:inline;">
              <button type="submit" class="danger" style="font-size: 12px; padding: 4px 10px;">Убрать</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Нет активных задач</p>
  {% endif %}

  {% if done_tasks %}
    <details style="margin-top: 12px;">
      <summary class="muted" style="cursor: pointer;">Выполненные ({{ done_tasks | length }})</summary>
      <table>
        <tbody>
          {% for task in done_tasks %}
          <tr style="opacity: 0.5;">
            <td><s>{{ task.title }}</s></td>
            <td class="muted">{{ task.completed_at.strftime('%d.%m %H:%M') if task.completed_at else '' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
  {% endif %}
</div>

<!-- Recurring task occurrences -->
{% if task_templates %}
<div class="card">
  <h2>Повторяющиеся задачи</h2>
  {% for tmpl in task_templates %}
    <h3 style="margin-bottom: 4px;">{{ tmpl.title }}</h3>
    {% set tmpl_occs = task_occurrences | selectattr('template_id', 'equalto', tmpl.template_id) | list %}
    {% if tmpl_occs %}
    <table>
      <thead><tr><th>Дата</th><th>Статус</th><th>Действия</th></tr></thead>
      <tbody>
        {% for occ in tmpl_occs %}
        <tr>
          <td class="{% if occ.scheduled_date == today %}positive{% elif occ.scheduled_date < today and occ.status == 'ACTIVE' %}negative{% endif %}">
            {{ occ.scheduled_date.strftime('%d.%m.%Y') }}
            {% if occ.scheduled_date == today %}<small>(сегодня)</small>{% endif %}
          </td>
          <td>
            {% if occ.status == 'DONE' %}<span class="positive">Выполнено</span>
            {% elif occ.status == 'SKIPPED' %}<span class="muted">Пропущено</span>
            {% else %}Активно{% endif %}
          </td>
          <td style="white-space: nowrap;">
            {% if occ.status == 'ACTIVE' %}
              <form method="POST" action="/tasks/occurrences/{{ occ.id }}/complete" style="display:inline;">
                <button type="submit" style="font-size: 12px; padding: 4px 10px;">Выполнить</button>
              </form>
              <form method="POST" action="/tasks/occurrences/{{ occ.id }}/skip" style="display:inline;">
                <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">Пропустить</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="muted">Нет предстоящих</p>
    {% endif %}
  {% endfor %}
</div>
{% endif %}

<!-- Create task (unified form) -->
<div class="task-create-wrapper">
<div class="card task-create-card">
  <h2>Создать задачу</h2>
  {% if error %}
    <div class="error-card">{{ error }}</div>
  {% endif %}
  {% include "tasks/_task_form.html" %}
</div>
</div>

<script>
(function() {
  // ── Mode toggle (once / recurring) ──
  var mode = 'once';
  var btnOnce = document.getElementById('btnOnce');
  var btnRecurring = document.getElementById('btnRecurring');
  var blockOnce = document.getElementById('blockOnce');
  var blockRecurring = document.getElementById('blockRecurring');
  var taskMode = document.getElementById('taskMode');
  var taskFreq = document.getElementById('taskFreq');
  var blockWeekdays = document.getElementById('blockWeekdays');
  var blockMonthday = document.getElementById('blockMonthday');

  window.setMode = function(m) {
    mode = m;
    taskMode.value = m;
    if (m === 'once') {
      btnOnce.className = 'seg-active';
      btnRecurring.className = '';
      blockOnce.style.display = '';
      blockRecurring.style.display = 'none';
    } else {
      btnOnce.className = '';
      btnRecurring.className = 'seg-active';
      blockOnce.style.display = 'none';
      blockRecurring.style.display = '';
      toggleFreqFields();
    }
  };

  function toggleFreqFields() {
    var freq = taskFreq.value;
    blockWeekdays.style.display = freq === 'WEEKLY' ? '' : 'none';
    blockMonthday.style.display = freq === 'MONTHLY' ? '' : 'none';
  }
  taskFreq.addEventListener('change', toggleFreqFields);
  toggleFreqFields();

  // ── DueSpec mode switcher ──
  var dueKind = 'NONE';
  var dkButtons = {
    NONE: document.getElementById('dkNone'),
    DATE: document.getElementById('dkDate'),
    DATETIME: document.getElementById('dkDatetime'),
    WINDOW: document.getElementById('dkWindow'),
  };
  var blockDueDate = document.getElementById('blockDueDate');
  var blockDueTime = document.getElementById('blockDueTime');
  var blockDueWindow = document.getElementById('blockDueWindow');
  var blockReminders = document.getElementById('blockReminders');
  var dueKindInput = document.getElementById('dueKind');

  window.setDueKind = function(kind) {
    dueKind = kind;
    dueKindInput.value = kind;
    for (var k in dkButtons) {
      dkButtons[k].className = (k === kind) ? 'seg-active' : '';
    }
    blockDueDate.style.display = (kind !== 'NONE') ? '' : 'none';
    blockDueTime.style.display = (kind === 'DATETIME') ? '' : 'none';
    blockDueWindow.style.display = (kind === 'WINDOW') ? '' : 'none';
    blockReminders.style.display = (kind === 'DATETIME' || kind === 'WINDOW') ? '' : 'none';

    if (kind !== 'DATETIME' && kind !== 'WINDOW') {
      _reminders = [];
      renderReminderChips();
    }
  };

  // ── Reminders ──
  var _reminders = [];
  var reminderChips = document.getElementById('reminderChips');
  var reminderPresetSelect = document.getElementById('reminderPresetSelect');
  var customReminderBlock = document.getElementById('customReminderBlock');
  var remindersJsonInput = document.getElementById('remindersJson');

  function renderReminderChips() {
    reminderChips.innerHTML = '';
    _reminders.forEach(function(rem, idx) {
      var chip = document.createElement('span');
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:var(--bg-table-header, #e9ecef);padding:4px 10px;border-radius:12px;font-size:12px;';
      chip.textContent = formatOffset(rem.offset_minutes);
      var closeBtn = document.createElement('span');
      closeBtn.textContent = '\u00d7';
      closeBtn.style.cssText = 'cursor:pointer;font-weight:700;color:#888;margin-left:2px;';
      closeBtn.onclick = (function(i) {
        return function() { _reminders.splice(i, 1); renderReminderChips(); };
      })(idx);
      chip.appendChild(closeBtn);
      reminderChips.appendChild(chip);
    });
    remindersJsonInput.value = _reminders.length ? JSON.stringify(_reminders) : '';
  }

  function formatOffset(minutes) {
    if (minutes === 0) return 'В момент срока';
    var abs = Math.abs(minutes);
    if (abs < 60) return 'За ' + abs + ' мин';
    if (abs % 60 === 0 && abs < 1440) return 'За ' + (abs / 60) + ' ч';
    if (abs === 1440) return 'За 1 день';
    if (abs % 1440 === 0) return 'За ' + (abs / 1440) + ' дн';
    return 'За ' + abs + ' мин';
  }

  function addReminder(offsetMinutes) {
    if (_reminders.length >= 5) return;
    if (_reminders.some(function(r) { return r.offset_minutes === offsetMinutes; })) return;
    _reminders.push({offset_minutes: offsetMinutes});
    renderReminderChips();
  }

  if (reminderPresetSelect) {
    reminderPresetSelect.addEventListener('change', function() {
      var val = this.value;
      if (val === '__custom__') {
        customReminderBlock.style.display = 'flex';
      } else if (val !== '') {
        addReminder(parseInt(val, 10));
        customReminderBlock.style.display = 'none';
      }
      this.value = '';
    });
  }

  window.addCustomReminder = function() {
    var input = document.getElementById('customReminderMinutes');
    var minutes = parseInt(input.value, 10);
    if (isNaN(minutes) || minutes < 0) return;
    addReminder(-minutes);
    input.value = '';
    customReminderBlock.style.display = 'none';
  };

  renderReminderChips();
})();
</script>
{% endblock %}
