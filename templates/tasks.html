{% extends "base.html" %}
{% block title %}–ó–∞–¥–∞—á–∏ - FinLife{% endblock %}

{% block content %}
<style>
/* ‚îÄ‚îÄ Task create card ‚îÄ‚îÄ */
.task-create-card {
  width: 100%;
  margin-top: 16px;
}
.task-form-grid {
  display: grid;
  grid-template-columns: 1.5fr 1fr;
  gap: 8px 16px;
}
.task-form-grid .span-full { grid-column: 1 / -1; }
@media (max-width: 900px) {
  .task-form-grid { grid-template-columns: 1fr; }
  .task-form-grid .span-full { grid-column: 1; }
}
/* ‚îÄ‚îÄ Segmented control ‚îÄ‚îÄ */
.seg-control {
  display: inline-flex;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border-color);
  background: var(--bg-input, #fff);
}
.seg-control button {
  flex: 1;
  border: none;
  border-radius: 0;
  padding: 4px 12px;
  font-size: 12px;
  font-weight: 500;
  min-height: unset;
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
}
.seg-control button:not(:last-child) {
  border-right: 1px solid var(--border-color);
}
.seg-control button:hover {
  background: var(--bg-table-header, #f0f0f0);
  color: var(--text-primary);
}
.seg-control button.seg-active {
  background: var(--accent);
  color: #fff;
}
.seg-control button.seg-active:hover {
  background: var(--accent-hover);
}
/* ‚îÄ‚îÄ Compact form tweaks ‚îÄ‚îÄ */
.task-form-grid label {
  margin-top: 0;
  margin-bottom: 2px;
  font-size: 13px;
}
.task-form-grid .form-row {
  margin-bottom: 0;
}
.task-form-grid input,
.task-form-grid select {
  max-width: 100%;
  height: 32px;
  font-size: 13px;
}
.task-form-grid textarea {
  max-width: 100%;
  font-size: 13px;
}
.task-form-grid details {
  margin-bottom: 0;
}
.task-form-submit {
  display: flex;
  justify-content: flex-start;
  padding-top: 4px;
}
.task-form-submit button[type="submit"] {
  min-width: 120px;
}
/* ‚îÄ‚îÄ Task list rows ‚îÄ‚îÄ */
.tsk-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border, #f0f0f0);
}
.tsk-row:last-child { border-bottom: none; }
.tsk-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.tsk-title {
  font-size: 15px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.tsk-note {
  font-size: 12px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.tsk-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.tsk-date {
  font-size: 13px;
  color: var(--text-secondary, #888);
  white-space: nowrap;
}
.tsk-check {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  cursor: pointer;
  accent-color: var(--accent, #4a90d9);
}
.tsk-del {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  line-height: 1;
  padding: 2px 4px;
  color: var(--text-secondary, #999);
  border-radius: 4px;
  transition: color 0.15s, background 0.15s;
  flex-shrink: 0;
}
.tsk-del:hover {
  color: #dc3545;
  background: rgba(220,53,69,.08);
}
.tsk-resc {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 15px;
  line-height: 1;
  padding: 2px 4px;
  color: var(--text-secondary, #999);
  border-radius: 4px;
  transition: color 0.15s, background 0.15s;
  flex-shrink: 0;
}
.tsk-resc:hover {
  color: var(--accent, #4a90d9);
  background: rgba(74,144,217,.08);
}
/* ‚îÄ‚îÄ Reschedule modal ‚îÄ‚îÄ */
.resc-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.resc-overlay.open { display: flex; }
.resc-modal {
  background: var(--bg-card, #fff);
  border-radius: 12px;
  padding: 24px;
  min-width: 320px;
  max-width: 400px;
  box-shadow: 0 8px 32px rgba(0,0,0,.2);
}
.resc-modal h3 { margin: 0 0 16px; font-size: 16px; }
.resc-modal .form-row { margin-bottom: 12px; }
.resc-modal label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 4px; }
.resc-modal input, .resc-modal select { width: 100%; }
.resc-modal-actions { display: flex; gap: 8px; margin-top: 16px; }
.tsk-overdue {
  border-left: 3px solid #dc3545;
  padding-left: 8px;
}
/* details chevron rotation */
details.card > summary .nav-chevron {
  transition: transform 0.15s ease;
}
details.card[open] > summary .nav-chevron {
  transform: rotate(90deg);
}
@media (max-width: 600px) {
  .tsk-row {
    flex-wrap: wrap;
    gap: 4px;
  }
  .tsk-meta {
    width: 100%;
    justify-content: space-between;
  }
}
/* ‚îÄ‚îÄ Progress card ‚îÄ‚îÄ */
.progress-bar {
  display: flex;
  gap: 24px;
  align-items: center;
}
.progress-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 64px;
}
.progress-num {
  font-size: 22px;
  font-weight: 700;
  line-height: 1.1;
}
.progress-label {
  font-size: 12px;
  color: var(--text-secondary, #888);
  margin-top: 2px;
}
.progress-num.clr-done { color: #16a34a; }
.progress-num.clr-overdue { color: #dc3545; }
.progress-num.clr-plan { color: var(--text-primary, #333); }
@media (max-width: 600px) {
  .progress-bar { gap: 16px; }
  .progress-num { font-size: 18px; }
}
/* ‚îÄ‚îÄ Analytics card ‚îÄ‚îÄ */
.analytics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
.analytics-period {
  background: var(--bg-table-header, #f8f9fa);
  border-radius: 8px;
  padding: 12px 16px;
}
.analytics-period-title {
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 8px;
  color: var(--text-secondary, #666);
}
.analytics-row {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  padding: 2px 0;
}
.analytics-row .val { font-weight: 600; }
.analytics-rate {
  font-size: 18px;
  font-weight: 700;
  margin-top: 4px;
}
.analytics-rate.good { color: #16a34a; }
.analytics-rate.ok { color: #d97706; }
.analytics-rate.low { color: #dc3545; }
.cat-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.cat-table th {
  text-align: left;
  font-weight: 600;
  padding: 6px 8px;
  border-bottom: 2px solid var(--border, #e5e7eb);
  font-size: 12px;
  color: var(--text-secondary, #888);
}
.cat-table td {
  padding: 5px 8px;
  border-bottom: 1px solid var(--border, #f0f0f0);
}
.cat-table tr:last-child td { border-bottom: none; }
.cat-table .num { text-align: right; }
@media (max-width: 600px) {
  .analytics-grid { grid-template-columns: 1fr; }
  .analytics-rate { font-size: 15px; }
}
/* ‚îÄ‚îÄ Mini-chart ‚îÄ‚îÄ */
.mini-chart {
  display: flex;
  align-items: flex-end;
  gap: 0;
  height: 120px;
  padding-top: 8px;
}
.mini-chart .bar-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  flex: 1;
  height: 100%;
}
.mini-chart .bar-count {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary, #888);
  margin-bottom: 3px;
}
.mini-chart .bar {
  width: 24px;
  border-radius: 4px 4px 0 0;
  background: var(--accent, #4a90d9);
  transition: background 0.15s;
}
.mini-chart .bar.bar-zero {
  background: var(--border, #e5e7eb);
}
.mini-chart .bar.bar-today {
  background: var(--accent-hover, #3570b5);
}
.mini-chart .bar-label {
  font-size: 11px;
  margin-top: 5px;
  color: var(--text-secondary, #888);
}
.mini-chart .bar-label.bar-today-label {
  font-weight: 600;
  color: var(--text-primary, #333);
}
@media (max-width: 600px) {
  .mini-chart { height: 90px; }
  .mini-chart .bar { width: 18px; }
}
/* ‚îÄ‚îÄ Discipline & reschedules ‚îÄ‚îÄ */
.disc-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
.disc-card {
  background: var(--bg-table-header, #f8f9fa);
  border-radius: 8px;
  padding: 12px 16px;
}
.disc-score {
  font-size: 28px;
  font-weight: 800;
  line-height: 1.1;
}
.disc-score.sc-high { color: #16a34a; }
.disc-score.sc-mid  { color: #d97706; }
.disc-score.sc-low  { color: #dc3545; }
.disc-detail {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  padding: 2px 0;
  color: var(--text-secondary, #666);
}
.disc-detail .dv { font-weight: 600; color: var(--text-primary, #333); }
.resc-top-list {
  list-style: none;
  padding: 0;
  margin: 6px 0 0;
  font-size: 12px;
}
.resc-top-list li {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
  border-bottom: 1px solid var(--border, #f0f0f0);
}
.resc-top-list li:last-child { border-bottom: none; }
.resc-top-list .resc-cnt { font-weight: 600; white-space: nowrap; }
.resc-top-list .resc-name {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  min-width: 0;
}
@media (max-width: 600px) {
  .disc-grid { grid-template-columns: 1fr; }
  .disc-score { font-size: 22px; }
}
</style>
<h1>–ó–∞–¥–∞—á–∏</h1>

{# ‚îÄ‚îÄ Progress card ‚îÄ‚îÄ #}
{% if planned_today or completed_today or overdue_count %}
<div class="card" style="padding: 14px 24px; margin-bottom: 16px;">
  <div style="font-weight: 600; font-size: 14px; margin-bottom: 10px;">–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–µ–≥–æ–¥–Ω—è</div>
  <div class="progress-bar">
    <div class="progress-stat">
      <span class="progress-num clr-plan">{{ planned_today }}</span>
      <span class="progress-label">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>
    </div>
    <div class="progress-stat">
      <span class="progress-num clr-done">{{ completed_today }}</span>
      <span class="progress-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
    </div>
    {% if overdue_count %}
    <div class="progress-stat">
      <span class="progress-num clr-overdue">{{ overdue_count }}</span>
      <span class="progress-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{# ‚îÄ‚îÄ Analytics card ‚îÄ‚îÄ #}
{% if analytics %}
<details class="card" style="margin-bottom: 16px;">
  <summary style="cursor: pointer; font-weight: 600; font-size: 15px; list-style: none; display: flex; align-items: center; gap: 8px;">
    <span class="nav-chevron" style="font-size: 10px;">&#9658;</span>
    –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
  </summary>
  <div style="margin-top: 12px;">
    <div class="analytics-grid">
      {# 7 days #}
      <div class="analytics-period">
        <div class="analytics-period-title">–ó–∞ 7 –¥–Ω–µ–π</div>
        <div class="analytics-row"><span>–°–æ–∑–¥–∞–Ω–æ</span><span class="val">{{ analytics.days7.created }}</span></div>
        <div class="analytics-row"><span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span><span class="val">{{ analytics.days7.completed }}</span></div>
        <div class="analytics-rate {% if analytics.days7.completion_rate >= 70 %}good{% elif analytics.days7.completion_rate >= 40 %}ok{% else %}low{% endif %}">
          {{ analytics.days7.completion_rate }}%
        </div>
      </div>
      {# 30 days #}
      <div class="analytics-period">
        <div class="analytics-period-title">–ó–∞ 30 –¥–Ω–µ–π</div>
        <div class="analytics-row"><span>–°–æ–∑–¥–∞–Ω–æ</span><span class="val">{{ analytics.days30.created }}</span></div>
        <div class="analytics-row"><span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span><span class="val">{{ analytics.days30.completed }}</span></div>
        <div class="analytics-rate {% if analytics.days30.completion_rate >= 70 %}good{% elif analytics.days30.completion_rate >= 40 %}ok{% else %}low{% endif %}">
          {{ analytics.days30.completion_rate }}%
        </div>
      </div>
    </div>

    {# Discipline + Reschedules #}
    {% if discipline %}
    <div class="disc-grid">
      <div class="disc-card">
        <div class="analytics-period-title">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ (7 –¥–Ω–µ–π)</div>
        <div class="disc-score {% if discipline.score >= 70 %}sc-high{% elif discipline.score >= 40 %}sc-mid{% else %}sc-low{% endif %}">
          {{ discipline.score }}<span style="font-size: 14px; font-weight: 500;">/100</span>
        </div>
        <div style="margin-top: 6px;">
          <div class="disc-detail"><span>–í —Å—Ä–æ–∫</span><span class="dv">{{ discipline.completed_on_time_7 }}</span></div>
          <div class="disc-detail"><span>–° –ø—Ä–æ—Å—Ä–æ—á–∫–æ–π</span><span class="dv">{{ discipline.completed_late_7 }}</span></div>
          <div class="disc-detail"><span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ —Å–µ–π—á–∞—Å</span><span class="dv">{{ discipline.overdue_now }}</span></div>
          <div class="disc-detail"><span>–ü–µ—Ä–µ–Ω–æ—Å–æ–≤</span><span class="dv">{{ discipline.reschedules_7 }}</span></div>
        </div>
      </div>
      <div class="disc-card">
        <div class="analytics-period-title">–ü–µ—Ä–µ–Ω–æ—Å—ã</div>
        <div class="disc-detail" style="font-size: 13px;"><span>–ó–∞ 7 –¥–Ω–µ–π</span><span class="dv">{{ discipline.reschedules_7 }}</span></div>
        <div class="disc-detail" style="font-size: 13px;"><span>–ó–∞ 30 –¥–Ω–µ–π</span><span class="dv">{{ discipline.reschedules_30 }}</span></div>
        {% if discipline.reschedule_top_30 %}
        <div style="font-size: 11px; color: var(--text-secondary, #888); margin-top: 8px;">–¢–æ–ø-5 –∑–∞–¥–∞—á (30 –¥–Ω.)</div>
        <ul class="resc-top-list">
          {% for r in discipline.reschedule_top_30 %}
          <li><span class="resc-name">{{ r.title }}</span><span class="resc-cnt">{{ r.count }}</span></li>
          {% endfor %}
        </ul>
        {% endif %}
        {% if discipline.reason_top_30 %}
        <div style="font-size: 11px; color: var(--text-secondary, #888); margin-top: 8px;">–ü—Ä–∏—á–∏–Ω—ã (30 –¥–Ω.)</div>
        <ul class="resc-top-list">
          {% for r in discipline.reason_top_30 %}
          <li><span class="resc-name">{{ r.name }}</span><span class="resc-cnt">{{ r.count }}</span></li>
          {% endfor %}
        </ul>
        {% endif %}
        {% if not discipline.reschedule_top_30 and not discipline.reason_top_30 %}
        <div style="font-size: 12px; color: var(--text-secondary, #aaa); margin-top: 8px;">–ü–µ—Ä–µ–Ω–æ—Å–æ–≤ –Ω–µ—Ç</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# Mini-chart: 7 days productivity #}
    {% if analytics.productivity_7 %}
    {% set max_count = analytics.productivity_7|map(attribute='count')|max %}
    <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: var(--text-secondary, #666);">–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π</div>
    <div class="mini-chart">
      {% for day in analytics.productivity_7 %}
      <div class="bar-col" title="{{ day.date }}: {{ day.count }}">
        <span class="bar-count">{{ day.count }}</span>
        <div class="bar{% if day.count == 0 %} bar-zero{% endif %}{% if day.is_today %} bar-today{% endif %}"
             style="height: {% if max_count > 0 and day.count > 0 %}{{ (day.count / max_count * 80)|round|int }}px{% else %}4{% endif %}px;"></div>
        <span class="bar-label{% if day.is_today %} bar-today-label{% endif %}">{{ day.weekday }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {# By category table #}
    {% if analytics.by_category_30 %}
    <div style="font-weight: 600; font-size: 13px; margin-top: 16px; margin-bottom: 6px; color: var(--text-secondary, #666);">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (30 –¥–Ω–µ–π)</div>
    <table class="cat-table">
      <thead>
        <tr><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th class="num">–°–æ–∑–¥–∞–Ω–æ</th><th class="num">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</th><th class="num">%</th></tr>
      </thead>
      <tbody>
        {% for row in analytics.by_category_30 %}
        <tr>
          <td>{{ row.category_name }}</td>
          <td class="num">{{ row.created }}</td>
          <td class="num">{{ row.completed }}</td>
          <td class="num">{{ row.rate }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
</details>
{% endif %}

{# ‚îÄ‚îÄ Macro: one-off task row ‚îÄ‚îÄ #}
{# (defined before layout so it's available inside) #}
{% macro task_row(task, show_overdue=false) %}
<div class="tsk-row{% if show_overdue and task.due_date and task.due_date < today %} tsk-overdue{% endif %}">
  <form id="frm-c-{{ task.task_id }}" method="POST" action="/tasks/{{ task.task_id }}/complete" style="display:none;"></form>
  <form id="frm-a-{{ task.task_id }}" method="POST" action="/tasks/{{ task.task_id }}/archive" style="display:none;"></form>
  {% if enable_task_expense_link and task.requires_expense %}
  <input type="checkbox" class="tsk-check"
         onchange="this.checked=false; openExpenseModal({{ task.task_id }}, {{ task.suggested_expense_category_id or 'null' }}, '{{ task.suggested_amount or '' }}', '{{ task.title|e }}')">
  {% else %}
  <input type="checkbox" class="tsk-check"
         onchange="tskConfirmComplete(this, 'frm-c-{{ task.task_id }}')">
  {% endif %}
  <div class="tsk-info">
    <span class="tsk-title">{{ task.title }}</span>
    {% if task.note %}<span class="tsk-note muted">{{ task.note }}</span>{% endif %}
  </div>
  <div class="tsk-meta">
    {% if task.due_kind == 'DATETIME' %}
      <span class="tsk-date">{{ task.due_date.strftime('%d.%m') }} {{ task.due_time.strftime('%H:%M') if task.due_time else '' }}</span>
    {% elif task.due_kind == 'WINDOW' %}
      <span class="tsk-date">{{ task.due_date.strftime('%d.%m') }} {{ task.due_start_time.strftime('%H:%M') if task.due_start_time else '' }}‚Äì{{ task.due_end_time.strftime('%H:%M') if task.due_end_time else '' }}</span>
    {% elif task.due_date %}
      <span class="tsk-date">{{ task.due_date.strftime('%d.%m.%Y') }}</span>
    {% endif %}
    {% if enable_reschedule_reasons and task.due_date %}
    <button type="button" class="tsk-resc" title="–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏"
            onclick="openRescheduleModal({{ task.task_id }}, '{{ task.due_date.isoformat() }}', '{{ task.title|e }}')">&#8634;</button>
    {% endif %}
    <button type="button" class="tsk-del" onclick="tskConfirmArchive('frm-a-{{ task.task_id }}')" title="–£–±—Ä–∞—Ç—å">&#x2715;</button>
  </div>
</div>
{% endmacro %}

{# ‚îÄ‚îÄ Block: –°–µ–≥–æ–¥–Ω—è ‚îÄ‚îÄ #}
<div class="card">
  <h2 style="margin-bottom: 12px;">üî• –°–µ–≥–æ–¥–Ω—è ({{ today_tasks|length }})</h2>
  {% if today_tasks %}
    {% for task in today_tasks %}
      {{ task_row(task, show_overdue=true) }}
    {% endfor %}
  {% else %}
    <p class="muted" style="margin: 0;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç.</p>
  {% endif %}
</div>

{# ‚îÄ‚îÄ Block: –ë–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π ‚îÄ‚îÄ #}
<div class="card" style="margin-top: 16px;">
  <h2 style="margin-bottom: 12px;">üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π ({{ upcoming_14|length }})</h2>
  {% if upcoming_14 %}
    {% for task in upcoming_14 %}
      {{ task_row(task) }}
    {% endfor %}
  {% else %}
    <p class="muted" style="margin: 0;">–í –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π –∑–∞–¥–∞—á –Ω–µ—Ç.</p>
  {% endif %}
</div>

{# ‚îÄ‚îÄ Block: –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è ‚îÄ‚îÄ #}
{% if recurring_items %}
<div class="card" style="margin-top: 16px;">
  <h2 style="margin-bottom: 12px;">üîÅ –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è ({{ recurring_items|length }})</h2>
  {% for ri in recurring_items %}
    {% set tmpl = ri.template %}
    {% set occ = ri.nearest_occ %}
    <div class="tsk-row">
      {% if occ %}
      <form id="frm-oc-{{ occ.id }}" method="POST" action="/tasks/occurrences/{{ occ.id }}/complete" style="display:none;"></form>
      <form id="frm-os-{{ occ.id }}" method="POST" action="/tasks/occurrences/{{ occ.id }}/skip" style="display:none;"></form>
      <input type="checkbox" class="tsk-check"
             onchange="tskConfirmComplete(this, 'frm-oc-{{ occ.id }}')">
      {% endif %}
      <div class="tsk-info">
        <span class="tsk-title">{{ tmpl.title }}</span>
      </div>
      <div class="tsk-meta">
        {% if occ %}
          <span class="tsk-date{% if occ.scheduled_date < today %} negative{% elif occ.scheduled_date == today %} positive{% endif %}">
            {{ occ.scheduled_date.strftime('%d.%m.%Y') }}
            {% if occ.scheduled_date == today %}<small>(—Å–µ–≥–æ–¥–Ω—è)</small>{% endif %}
          </span>
          <button type="button" class="tsk-del" onclick="tskConfirmSkip('frm-os-{{ occ.id }}')" title="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å">&#x2715;</button>
        {% else %}
          <span class="tsk-date muted">–Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö</span>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}

{# ‚îÄ‚îÄ Create task form (inline) ‚îÄ‚îÄ #}
<div class="card task-create-card">
  <h2 style="margin-bottom: 10px; font-size: 16px;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
  {% if error %}
    <div class="error-card">{{ error }}</div>
  {% endif %}
  {% include "tasks/_task_form.html" %}
</div>

{# ‚îÄ‚îÄ Block: –ë–µ–∑ —Å—Ä–æ–∫–∞ ‚îÄ‚îÄ #}
{% if no_date_tasks %}
<details class="card" style="margin-top: 16px;" open>
  <summary style="cursor: pointer; font-weight: 600; font-size: 16px; list-style: none; display: flex; align-items: center; gap: 8px;">
    <span class="nav-chevron" style="font-size: 10px;">&#9658;</span>
    –ë–µ–∑ —Å—Ä–æ–∫–∞ ({{ no_date_tasks|length }})
  </summary>
  <div style="margin-top: 12px;">
    {% for task in no_date_tasks %}
      {{ task_row(task) }}
    {% endfor %}
  </div>
</details>
{% endif %}

{# ‚îÄ‚îÄ Block: –ü–æ–∑–∂–µ (>14 –¥–Ω–µ–π) ‚îÄ‚îÄ #}
{% if later_tasks %}
<details class="card" style="margin-top: 16px;">
  <summary style="cursor: pointer; font-weight: 600; font-size: 16px; list-style: none; display: flex; align-items: center; gap: 8px;">
    <span class="nav-chevron" style="font-size: 10px;">&#9658;</span>
    –ü–æ–∑–∂–µ ({{ later_tasks|length }})
  </summary>
  <div style="margin-top: 12px;">
    {% for task in later_tasks %}
      {{ task_row(task) }}
    {% endfor %}
  </div>
</details>
{% endif %}

{# ‚îÄ‚îÄ Block: –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ ‚îÄ‚îÄ #}
{% if done_tasks %}
<details class="card" style="margin-top: 16px;">
  <summary class="muted" style="cursor: pointer; font-size: 14px; list-style: none; display: flex; align-items: center; gap: 8px;">
    <span class="nav-chevron" style="font-size: 10px;">&#9658;</span>
    –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ ({{ done_tasks|length }})
  </summary>
  <div style="margin-top: 12px;">
    {% for task in done_tasks %}
    <div class="tsk-row" style="opacity: 0.5;">
      <div class="tsk-info">
        <span class="tsk-title"><s>{{ task.title }}</s></span>
      </div>
      <div class="tsk-meta">
        <span class="tsk-date muted">{{ task.completed_at.strftime('%d.%m %H:%M') if task.completed_at else '' }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
</details>
{% endif %}


<script>
/* ‚îÄ‚îÄ Task action confirmations ‚îÄ‚îÄ */
function tskConfirmComplete(chk, formId) {
  if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞—á—É?')) {
    document.getElementById(formId).submit();
  } else {
    chk.checked = false;
  }
}
function tskConfirmArchive(formId) {
  if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
    document.getElementById(formId).submit();
  }
}
function tskConfirmSkip(formId) {
  if (confirm('–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
    document.getElementById(formId).submit();
  }
}
</script>

<script>
(function() {
  // ‚îÄ‚îÄ Mode toggle (once / recurring) ‚îÄ‚îÄ
  var mode = 'once';
  var btnOnce = document.getElementById('btnOnce');
  var btnRecurring = document.getElementById('btnRecurring');
  var blockOnce = document.getElementById('blockOnce');
  var blockRecurring = document.getElementById('blockRecurring');
  var taskMode = document.getElementById('taskMode');
  var taskFreq = document.getElementById('taskFreq');
  var blockWeekdays = document.getElementById('blockWeekdays');
  var blockMonthday = document.getElementById('blockMonthday');

  window.setMode = function(m) {
    mode = m;
    taskMode.value = m;
    if (m === 'once') {
      btnOnce.className = 'seg-active';
      btnRecurring.className = '';
      blockOnce.style.display = '';
      blockRecurring.style.display = 'none';
    } else {
      btnOnce.className = '';
      btnRecurring.className = 'seg-active';
      blockOnce.style.display = 'none';
      blockRecurring.style.display = '';
      toggleFreqFields();
    }
  };

  function toggleFreqFields() {
    var freq = taskFreq.value;
    blockWeekdays.style.display = freq === 'WEEKLY' ? '' : 'none';
    blockMonthday.style.display = freq === 'MONTHLY' ? '' : 'none';
  }
  taskFreq.addEventListener('change', toggleFreqFields);
  toggleFreqFields();

  // ‚îÄ‚îÄ DueSpec mode switcher ‚îÄ‚îÄ
  var dueKind = 'NONE';
  var dkButtons = {
    NONE: document.getElementById('dkNone'),
    DATE: document.getElementById('dkDate'),
    DATETIME: document.getElementById('dkDatetime'),
    WINDOW: document.getElementById('dkWindow'),
  };
  var blockDueDate = document.getElementById('blockDueDate');
  var blockDueTime = document.getElementById('blockDueTime');
  var blockDueWindow = document.getElementById('blockDueWindow');
  var blockReminders = document.getElementById('blockReminders');
  var dueKindInput = document.getElementById('dueKind');

  window.setDueKind = function(kind) {
    dueKind = kind;
    dueKindInput.value = kind;
    for (var k in dkButtons) {
      dkButtons[k].className = (k === kind) ? 'seg-active' : '';
    }
    blockDueDate.style.display = (kind !== 'NONE') ? '' : 'none';
    blockDueTime.style.display = (kind === 'DATETIME') ? '' : 'none';
    blockDueWindow.style.display = (kind === 'WINDOW') ? '' : 'none';
    blockReminders.style.display = (kind === 'DATETIME' || kind === 'WINDOW') ? '' : 'none';

    if (kind !== 'DATETIME' && kind !== 'WINDOW') {
      _reminders = [];
      renderReminderChips();
    }
  };

  // ‚îÄ‚îÄ Reminders ‚îÄ‚îÄ
  var _reminders = [];
  var reminderChips = document.getElementById('reminderChips');
  var reminderPresetSelect = document.getElementById('reminderPresetSelect');
  var customReminderBlock = document.getElementById('customReminderBlock');
  var remindersJsonInput = document.getElementById('remindersJson');

  function renderReminderChips() {
    reminderChips.innerHTML = '';
    _reminders.forEach(function(rem, idx) {
      var chip = document.createElement('span');
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:var(--bg-table-header, #e9ecef);padding:4px 10px;border-radius:12px;font-size:12px;';
      chip.textContent = formatOffset(rem.offset_minutes);
      var closeBtn = document.createElement('span');
      closeBtn.textContent = '\u00d7';
      closeBtn.style.cssText = 'cursor:pointer;font-weight:700;color:#888;margin-left:2px;';
      closeBtn.onclick = (function(i) {
        return function() { _reminders.splice(i, 1); renderReminderChips(); };
      })(idx);
      chip.appendChild(closeBtn);
      reminderChips.appendChild(chip);
    });
    remindersJsonInput.value = _reminders.length ? JSON.stringify(_reminders) : '';
  }

  function formatOffset(minutes) {
    if (minutes === 0) return '–í –º–æ–º–µ–Ω—Ç —Å—Ä–æ–∫–∞';
    var abs = Math.abs(minutes);
    if (abs < 60) return '–ó–∞ ' + abs + ' –º–∏–Ω';
    if (abs % 60 === 0 && abs < 1440) return '–ó–∞ ' + (abs / 60) + ' —á';
    if (abs === 1440) return '–ó–∞ 1 –¥–µ–Ω—å';
    if (abs % 1440 === 0) return '–ó–∞ ' + (abs / 1440) + ' –¥–Ω';
    return '–ó–∞ ' + abs + ' –º–∏–Ω';
  }

  function addReminder(offsetMinutes) {
    if (_reminders.length >= 5) return;
    if (_reminders.some(function(r) { return r.offset_minutes === offsetMinutes; })) return;
    _reminders.push({offset_minutes: offsetMinutes});
    renderReminderChips();
  }

  if (reminderPresetSelect) {
    reminderPresetSelect.addEventListener('change', function() {
      var val = this.value;
      if (val === '__custom__') {
        customReminderBlock.style.display = 'flex';
      } else if (val !== '') {
        addReminder(parseInt(val, 10));
        customReminderBlock.style.display = 'none';
      }
      this.value = '';
    });
  }

  window.addCustomReminder = function() {
    var input = document.getElementById('customReminderMinutes');
    var minutes = parseInt(input.value, 10);
    if (isNaN(minutes) || minutes < 0) return;
    addReminder(-minutes);
    input.value = '';
    customReminderBlock.style.display = 'none';
  };

  renderReminderChips();

  // ‚îÄ‚îÄ Task-expense link: toggle fields in create form ‚îÄ‚îÄ
  window.toggleExpenseFields = function() {
    var chk = document.getElementById('chkRequiresExpense');
    var block = document.getElementById('blockExpenseFields');
    if (chk && block) {
      block.style.display = chk.checked ? '' : 'none';
      if (!chk.checked) {
        var sel = document.getElementById('selExpenseCat');
        var inp = document.getElementById('inputExpenseAmount');
        if (sel) sel.value = '';
        if (inp) inp.value = '';
      }
    }
  };

  // Hide expense link block when mode is recurring
  var origSetMode = window.setMode;
  window.setMode = function(m) {
    origSetMode(m);
    var expBlock = document.getElementById('blockExpenseLink');
    if (expBlock) {
      expBlock.style.display = (m === 'once') ? '' : 'none';
      if (m !== 'once') {
        var chk = document.getElementById('chkRequiresExpense');
        if (chk) { chk.checked = false; toggleExpenseFields(); }
      }
    }
  };
})();
</script>

<script>
/* ‚îÄ‚îÄ Task preset pre-fill ‚îÄ‚îÄ */
function applyTaskPreset(presetId) {
  var sel = document.getElementById('presetSelect');
  if (!sel) return;
  var opt = sel.options[sel.selectedIndex];
  var form = document.getElementById('taskForm');
  var titleInput = form.querySelector('input[name="title"]');
  var noteInput  = form.querySelector('input[name="note"]');
  var catSelect  = form.querySelector('select[name="category_id"]');

  if (!presetId) {
    if (titleInput) titleInput.value = '';
    if (noteInput)  noteInput.value = '';
    if (catSelect)  catSelect.value = '';
    return;
  }
  if (titleInput) titleInput.value = opt.dataset.title || '';
  if (noteInput)  noteInput.value = opt.dataset.note || '';
  if (catSelect)  catSelect.value = opt.dataset.category || '';
}
</script>

<script>
/* ‚îÄ‚îÄ Multi-date chips ‚îÄ‚îÄ */
(function() {
  var _dates = [];
  var chipsEl = document.getElementById('multiDateChips');
  var hiddenEl = document.getElementById('multiDatesJson');
  var hintEl = document.getElementById('multiDateHint');

  function renderChips() {
    if (!chipsEl) return;
    _dates.sort();
    chipsEl.innerHTML = '';
    _dates.forEach(function(d, idx) {
      var parts = d.split('-');
      var label = parts[2] + '.' + parts[1] + '.' + parts[0];
      var chip = document.createElement('span');
      chip.style.cssText = 'display:inline-flex;align-items:center;gap:4px;background:var(--bg-table-header, #e9ecef);padding:4px 10px;border-radius:12px;font-size:12px;';
      chip.textContent = label;
      var closeBtn = document.createElement('span');
      closeBtn.textContent = '\u00d7';
      closeBtn.style.cssText = 'cursor:pointer;font-weight:700;color:#888;margin-left:2px;';
      closeBtn.onclick = (function(i) {
        return function() { _dates.splice(i, 1); renderChips(); };
      })(idx);
      chip.appendChild(closeBtn);
      chipsEl.appendChild(chip);
    });
    hiddenEl.value = _dates.length ? _dates.join(',') : '';
    if (hintEl) hintEl.style.display = _dates.length ? 'none' : 'block';
  }

  window.addMultiDate = function() {
    var input = document.getElementById('inputMultiDate');
    if (!input || !input.value) return;
    var val = input.value; // YYYY-MM-DD
    if (_dates.indexOf(val) !== -1) return; // duplicate
    _dates.push(val);
    input.value = '';
    renderChips();
  };

  window.toggleMultiDates = function() {
    var chk = document.getElementById('chkMultiDates');
    var blockMulti = document.getElementById('blockMultiDates');
    var blockSwitcher = document.getElementById('blockDueKindSwitcher');
    var blockDate = document.getElementById('blockDueDate');
    var blockTime = document.getElementById('blockDueTime');
    var blockWindow = document.getElementById('blockDueWindow');
    var blockReminders = document.getElementById('blockReminders');

    if (chk && chk.checked) {
      // Multi-date mode: hide due_kind switcher and single-date fields, show multi block
      if (blockSwitcher) blockSwitcher.style.display = 'none';
      if (blockDate) blockDate.style.display = 'none';
      if (blockTime) blockTime.style.display = 'none';
      if (blockWindow) blockWindow.style.display = 'none';
      if (blockReminders) blockReminders.style.display = 'none';
      if (blockMulti) blockMulti.style.display = '';
      // Force due_kind to DATE for multi-date tasks
      var dueKindInput = document.getElementById('dueKind');
      if (dueKindInput) dueKindInput.value = 'DATE';
    } else {
      // Single-date mode: restore
      if (blockSwitcher) blockSwitcher.style.display = '';
      if (blockMulti) blockMulti.style.display = 'none';
      // Reset to current due_kind state
      if (window.setDueKind) {
        var cur = document.getElementById('dueKind');
        window.setDueKind(cur ? cur.value : 'NONE');
      }
      // Clear multi-date state
      _dates = [];
      renderChips();
    }
  };

  renderChips();
})();
</script>

{% if enable_task_expense_link %}
{# ‚îÄ‚îÄ Expense completion modal ‚îÄ‚îÄ #}
<style>
.te-backdrop {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.35); align-items: center; justify-content: center;
}
.te-backdrop.te-open { display: flex; }
.te-dialog {
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,.18);
  width: min(380px, calc(100vw - 32px)); padding: 20px 22px;
}
.te-title {
  font-size: 15px; font-weight: 600; margin: 0 0 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.te-close {
  background: none; border: none; cursor: pointer; font-size: 18px;
  color: var(--text-secondary); line-height: 1; padding: 0 2px;
}
.te-close:hover { color: var(--text-primary); }
.te-field { margin-bottom: 12px; }
.te-field label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.te-field input, .te-field select {
  width: 100%; padding: 8px 10px; font-size: 14px;
  background: var(--bg-page); border: 1px solid var(--border-color);
  border-radius: 8px; color: var(--text-primary); box-sizing: border-box;
}
.te-field input:focus, .te-field select:focus {
  outline: none; border-color: var(--accent, #4a90d9);
}
.te-actions { display: flex; gap: 8px; margin-top: 16px; }
.te-submit {
  flex: 1; padding: 9px 0; font-size: 14px; font-weight: 600;
  background: var(--accent, #4a90d9); color: #fff;
  border: none; border-radius: 10px; cursor: pointer;
  transition: opacity .15s;
}
.te-submit:hover { opacity: .88; }
.te-cancel {
  padding: 9px 16px; font-size: 14px;
  background: transparent; border: 1px solid var(--border-color);
  border-radius: 10px; cursor: pointer; color: var(--text-secondary);
}
.te-cancel:hover { background: var(--bg-hover, rgba(128,128,128,.1)); }
</style>

<div class="te-backdrop" id="teBackdrop" role="dialog" aria-modal="true">
  <div class="te-dialog">
    <div class="te-title">
      <span id="teTitle">–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å —Ä–∞—Å—Ö–æ–¥–æ–º</span>
      <button class="te-close" id="teClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&#x2715;</button>
    </div>
    <form method="POST" action="" id="teForm">
      <div class="te-field">
        <label>–°—É–º–º–∞</label>
        <input type="number" name="expense_amount" id="teAmount" step="0.01" min="0.01" placeholder="0.00" required>
      </div>
      <div class="te-field">
        <label>–ö–æ—à–µ–ª—ë–∫</label>
        <select name="expense_wallet_id" id="teWallet" required>
          {% for w in task_wallets %}
            <option value="{{ w.wallet_id }}">{{ w.title }} ({{ w.currency }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="te-field">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–∞</label>
        <select name="expense_category_id" id="teCategory" required>
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
          {% for c in expense_categories %}
            <option value="{{ c.category_id }}">{{ c.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="te-actions">
        <button type="button" class="te-cancel" id="teCancelBtn">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="te-submit">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  var backdrop = document.getElementById('teBackdrop');
  var form = document.getElementById('teForm');
  var amountInput = document.getElementById('teAmount');
  var catSelect = document.getElementById('teCategory');
  var closeBtn = document.getElementById('teClose');
  var cancelBtn = document.getElementById('teCancelBtn');

  window.openExpenseModal = function(taskId, suggestedCatId, suggestedAmount, taskTitle) {
    form.action = '/tasks/' + taskId + '/complete-with-expense';
    if (suggestedAmount) amountInput.value = suggestedAmount;
    else amountInput.value = '';
    if (suggestedCatId) catSelect.value = suggestedCatId;
    else catSelect.value = '';
    document.getElementById('teTitle').textContent = '–†–∞—Å—Ö–æ–¥: ' + taskTitle;
    backdrop.classList.add('te-open');
    amountInput.focus();
  };

  function closeModal() {
    backdrop.classList.remove('te-open');
  }

  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', function(e) {
    if (e.target === backdrop) closeModal();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && backdrop.classList.contains('te-open')) closeModal();
  });
})();
</script>
{% endif %}

{# ‚îÄ‚îÄ Reschedule modal ‚îÄ‚îÄ #}
{% if enable_reschedule_reasons and reschedule_reasons %}
<div class="resc-overlay" id="rescOverlay">
  <div class="resc-modal">
    <h3 id="rescTitle">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∑–∞–¥–∞—á—É</h3>
    <form method="POST" id="rescForm" action="">
      <div class="form-row">
        <label>–ù–æ–≤–∞—è –¥–∞—Ç–∞</label>
        <input type="date" name="new_due_date" id="rescDate" required>
      </div>
      <div class="form-row">
        <label>–ü—Ä–∏—á–∏–Ω–∞</label>
        <select name="reason_id" id="rescReason" required>
          <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É ‚Äî</option>
          {% for r in reschedule_reasons %}
          <option value="{{ r.id }}">{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="resc-modal-actions">
        <button type="submit">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>
        <button type="button" class="btn secondary" onclick="closeRescheduleModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>
<script>
function openRescheduleModal(taskId, currentDate, title) {
  document.getElementById('rescForm').action = '/tasks/' + taskId + '/reschedule';
  document.getElementById('rescTitle').textContent = '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏: ' + title;
  var dateInput = document.getElementById('rescDate');
  dateInput.value = '';
  dateInput.min = new Date().toISOString().split('T')[0];
  document.getElementById('rescReason').value = '';
  document.getElementById('rescOverlay').classList.add('open');
}
function closeRescheduleModal() {
  document.getElementById('rescOverlay').classList.remove('open');
}
document.getElementById('rescOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeRescheduleModal();
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeRescheduleModal();
});
</script>
{% endif %}

{% endblock %}
