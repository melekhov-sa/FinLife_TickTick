{% extends "base.html" %}
{% block title %}Стратегия — FinLife{% endblock %}

{% block extra_head %}
<style>
  .st-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
  .st-nav a { text-decoration: none; color: #007AFF; font-size: 14px; }
  .st-nav-month { font-size: 18px; font-weight: 700; }

  /* Life Score hero */
  .st-hero {
    background: var(--bg-card, #fff);
    border-radius: 12px;
    padding: 28px 32px;
    box-shadow: var(--shadow-card, 0 1px 3px rgba(0,0,0,0.06));
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 32px;
  }
  .st-hero-score { font-size: 64px; font-weight: 900; line-height: 1; }
  .st-hero-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary, #888); margin-bottom: 4px; }
  .st-hero-proj { font-size: 14px; color: var(--text-secondary, #888); }
  .st-hero-proj b { font-weight: 700; }

  /* Grid */
  .st-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 16px; }
  .st-card {
    background: var(--bg-card, #fff);
    border-radius: 10px;
    padding: 20px;
    box-shadow: var(--shadow-card, 0 1px 3px rgba(0,0,0,0.06));
  }
  .st-card-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary, #888); margin-bottom: 14px; }
  .st-card-score { font-size: 36px; font-weight: 800; line-height: 1; margin-bottom: 12px; }
  .st-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 14px; }
  .st-row:not(:last-child) { border-bottom: 1px solid var(--border-color, #f0f0f0); }
  .st-row-label { color: var(--text-secondary, #888); }
  .st-row-val { font-weight: 600; font-variant-numeric: tabular-nums; }

  /* Section card */
  .st-section {
    background: var(--bg-card, #fff);
    border-radius: 10px;
    padding: 20px;
    box-shadow: var(--shadow-card, 0 1px 3px rgba(0,0,0,0.06));
    margin-bottom: 16px;
  }

  /* Trend bars */
  .st-trend-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
  .st-trend-label { width: 52px; font-size: 12px; color: var(--text-secondary, #888); flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .st-trend-track { flex: 1; background: var(--border-color, #eee); border-radius: 3px; height: 18px; overflow: hidden; position: relative; }
  .st-trend-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
  .st-trend-num { width: 30px; text-align: right; font-size: 12px; font-weight: 700; flex-shrink: 0; font-variant-numeric: tabular-nums; }

  /* Breakdown */
  .st-bd-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; font-size: 14px; }
  .st-bd-item:not(:last-child) { border-bottom: 1px solid var(--border-color, #f0f0f0); }
  .st-bd-reason { flex: 1; }
  .st-bd-penalty { font-weight: 700; color: #dc3545; width: 60px; text-align: right; font-variant-numeric: tabular-nums; flex-shrink: 0; }
  .st-bd-fix { font-size: 12px; text-decoration: none; color: #007AFF; flex-shrink: 0; }
  .st-bd-component { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-secondary, #888); display: inline-block; background: var(--border-color, #f0f0f0); border-radius: 3px; padding: 1px 6px; margin-right: 6px; }

  /* Simulator */
  .st-sim { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: end; }
  .st-sim-field label { display: block; font-size: 12px; color: var(--text-secondary, #888); margin-bottom: 4px; }
  .st-sim-field input { width: 100%; padding: 6px 8px; border: 1px solid var(--border-color, #ddd); border-radius: 6px; font-size: 14px; font-variant-numeric: tabular-nums; background: var(--bg-card, #fff); color: var(--text-primary, #333); }
  .st-sim-btn { padding: 7px 16px; background: #007AFF; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; white-space: nowrap; }
  .st-sim-btn:hover { background: #0060d0; }
  .st-sim-result { display: flex; align-items: center; gap: 16px; margin-top: 14px; padding: 12px; border-radius: 8px; background: var(--border-color, #f5f5f5); }
  .st-sim-big { font-size: 32px; font-weight: 800; line-height: 1; }
  .st-sim-delta { font-size: 18px; font-weight: 700; }
  .st-sim-detail { font-size: 13px; color: var(--text-secondary, #888); }

  .clr-good { color: #22c55e; }
  .clr-ok   { color: #eab308; }
  .clr-bad  { color: #dc3545; }
  .clr-pos  { color: #22c55e; }
  .clr-neg  { color: #dc3545; }

  @media (max-width: 800px) {
    .st-grid { grid-template-columns: repeat(2, 1fr); }
    .st-sim { grid-template-columns: repeat(2, 1fr); }
    .st-hero { flex-direction: column; text-align: center; gap: 12px; padding: 20px; }
    .st-hero-score { font-size: 48px; }
    .st-card-score { font-size: 28px; }
  }
  @media (max-width: 480px) {
    .st-grid { grid-template-columns: 1fr; }
    .st-sim { grid-template-columns: 1fr; }
  }

  [data-theme$="-dark"] .st-hero,
  [data-theme$="-dark"] .st-card,
  [data-theme$="-dark"] .st-section { background: var(--bg-card, #161b22); }
  [data-theme$="-dark"] .st-row:not(:last-child),
  [data-theme$="-dark"] .st-bd-item:not(:last-child) { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .st-trend-track { background: #21262d; }
  [data-theme$="-dark"] .st-sim-result { background: #21262d; }
  [data-theme$="-dark"] .st-sim-field input { background: #0d1117; border-color: #30363d; color: #c9d1d9; }
  [data-theme$="-dark"] .st-bd-component { background: #21262d; }

  /* Risk mode */
  .st-risk {
    background: #dc3545;
    color: #fff;
    border-radius: 10px;
    padding: 16px 20px;
    margin-bottom: 16px;
  }
  .st-risk-title { font-size: 16px; font-weight: 800; margin-bottom: 8px; }
  .st-risk-reasons { font-size: 13px; margin-bottom: 8px; opacity: 0.9; }
  .st-risk-tips { font-size: 13px; opacity: 0.85; }
  .st-risk-tips li { margin-bottom: 2px; }

  /* Dynamics */
  .st-dyn-row { display: flex; align-items: center; gap: 8px; padding: 3px 0; }
  .st-dyn-date { width: 44px; font-size: 12px; color: var(--text-secondary, #888); flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .st-dyn-track { flex: 1; background: var(--border-color, #eee); border-radius: 3px; height: 14px; overflow: hidden; }
  .st-dyn-fill { height: 100%; border-radius: 3px; }
  .st-dyn-num { width: 28px; text-align: right; font-size: 12px; font-weight: 700; flex-shrink: 0; font-variant-numeric: tabular-nums; }
  .st-dyn-delta { width: 40px; text-align: right; font-size: 11px; font-weight: 600; flex-shrink: 0; font-variant-numeric: tabular-nums; }

  /* ── Strategy targets (Мои цели) ── */
  .st-tgt-item {
    padding: 14px 0;
    border-bottom: 1px solid var(--border-color, #f0f0f0);
  }
  .st-tgt-item:last-child { border-bottom: none; }
  .st-tgt-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
  }
  .st-tgt-title {
    font-size: 15px;
    font-weight: 600;
    flex: 1;
    min-width: 0;
  }
  .st-tgt-values {
    font-size: 13px;
    color: var(--text-secondary, #888);
    white-space: nowrap;
    flex-shrink: 0;
  }
  .st-tgt-values b { color: var(--text-primary, #333); }
  .st-tgt-actions { display: flex; gap: 4px; flex-shrink: 0; }
  .st-tgt-edit-btn, .st-tgt-del-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--text-secondary, #999);
    transition: color 0.15s, background 0.15s;
    line-height: 1;
  }
  .st-tgt-edit-btn:hover { color: #007AFF; background: rgba(0,122,255,.08); }
  .st-tgt-del-btn:hover  { color: #dc3545; background: rgba(220,53,69,.08); }
  .st-tgt-track {
    height: 10px;
    background: var(--border-color, #eee);
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 4px;
  }
  .st-tgt-fill { height: 100%; border-radius: 5px; transition: width 0.4s; }
  .st-tgt-footer { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary, #888); }
  .st-tgt-badge {
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    letter-spacing: 0.3px;
  }
  .st-tgt-badge.done { background: rgba(34,197,94,.15); color: #16a34a; }
  .st-tgt-badge.going { background: rgba(234,179,8,.12); color: #a16207; }
  .st-tgt-badge.behind { background: rgba(220,53,69,.1); color: #dc3545; }

  /* Add target form */
  .st-add-form {
    margin-top: 16px;
    padding: 16px;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 10px;
    display: none;
  }
  .st-add-form.open { display: block; }
  .st-add-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .st-add-field label { display: block; font-size: 12px; color: var(--text-secondary, #888); margin-bottom: 4px; }
  .st-add-field input, .st-add-field select {
    width: 100%; padding: 7px 10px; border: 1px solid var(--border-color, #ddd);
    border-radius: 6px; font-size: 13px; background: var(--bg-card, #fff);
    color: var(--text-primary, #111); box-sizing: border-box;
  }
  .st-add-field.span-2 { grid-column: 1 / -1; }
  .st-add-actions { display: flex; gap: 8px; }
  .st-add-submit {
    padding: 7px 18px; background: #007AFF; color: #fff;
    border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .st-add-submit:hover { background: #0060d0; }
  .st-add-cancel {
    padding: 7px 14px; background: none; border: 1px solid var(--border-color, #ddd);
    border-radius: 6px; font-size: 13px; cursor: pointer; color: var(--text-secondary, #888);
  }

  /* Inline edit form */
  .st-tgt-edit-form { display: none; margin-top: 8px; }
  .st-tgt-edit-form.open { display: flex; gap: 8px; align-items: center; }
  .st-tgt-edit-form input {
    width: 100px; padding: 5px 8px; border: 1px solid var(--border-color, #ddd);
    border-radius: 6px; font-size: 13px; background: var(--bg-card, #fff); color: var(--text-primary, #111);
  }
  .st-tgt-edit-form input.title-inp { flex: 1; width: auto; }
  .st-tgt-edit-save {
    padding: 5px 14px; background: #007AFF; color: #fff; border: none;
    border-radius: 6px; font-size: 13px; cursor: pointer;
  }

  @media (max-width: 600px) {
    .st-add-grid { grid-template-columns: 1fr; }
  }

  /* Weekly review */
  .st-wr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
  .st-wr-metric { text-align: center; }
  .st-wr-metric-val { font-size: 28px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .st-wr-metric-label { font-size: 11px; color: var(--text-secondary, #888); text-transform: uppercase; }
  .st-wr-rec { font-size: 13px; padding: 10px 12px; border-radius: 6px; background: var(--border-color, #f5f5f5); margin-top: 8px; }
  [data-theme$="-dark"] .st-wr-rec { background: #21262d; }
</style>
{% endblock %}

{% macro score_color(val) %}{% if val >= 75 %}clr-good{% elif val >= 55 %}clr-ok{% else %}clr-bad{% endif %}{% endmacro %}
{% macro bar_color(val) %}{% if val >= 75 %}#22c55e{% elif val >= 55 %}#eab308{% else %}#dc3545{% endif %}{% endmacro %}

{% block content %}
<h1 style="font-size: 22px; margin-bottom: 16px;">Стратегия</h1>

{# ── Month navigation ── #}
<div class="st-nav">
  <a href="/strategy?year={{ prev_year }}&month={{ prev_month }}">&larr;</a>
  <span class="st-nav-month">{{ month_label }}</span>
  <a href="/strategy?year={{ next_year }}&month={{ next_month }}">&rarr;</a>
</div>

{# ── Risk mode banner ── #}
{% if risk %}
<div class="st-risk">
  <div class="st-risk-title">&#9888; Risk Mode</div>
  <div class="st-risk-reasons">
    {% for r in risk.reasons %}{{ r }}{% if not loop.last %} &middot; {% endif %}{% endfor %}
  </div>
  <div class="st-risk-tips">
    <ul style="margin: 0; padding-left: 18px;">
      {% for tip in risk.tips %}<li>{{ tip }}</li>{% endfor %}
    </ul>
  </div>
</div>
{% endif %}

{# ── Life Score hero ── #}
<div class="st-hero">
  <div>
    <div class="st-hero-label">Life Score</div>
    <div class="st-hero-score {{ score_color(s.life_score) }}">{{ s.life_score|round(0)|int }}</div>
  </div>
  <div>
    <div class="st-hero-proj">Прогноз: <b>{{ s.life_score_projection|round(0)|int }}</b></div>
  </div>
</div>

{# ── Score cards ── #}
<div class="st-grid">

  {# Finance #}
  <div class="st-card">
    <div class="st-card-title">Финансы</div>
    <div class="st-card-score {{ score_color(s.finance_score) }}">{{ s.finance_score|round(0)|int }}</div>
    <div class="st-row">
      <span class="st-row-label">Капитал</span>
      <span class="st-row-val">{{ "{:,.0f}".format(s.assets_total) }} &#8381;</span>
    </div>
    <div class="st-row">
      <span class="st-row-label">Долг</span>
      <span class="st-row-val" style="color: {% if s.debt_total > 0 %}#dc3545{% else %}inherit{% endif %};">{{ "{:,.0f}".format(s.debt_total) }} &#8381;</span>
    </div>
    <div class="st-row">
      <span class="st-row-label">Долговая нагрузка</span>
      <span class="st-row-val">{{ s.debt_ratio }}%</span>
    </div>
    <div class="st-row">
      <span class="st-row-label">Норма сбережений</span>
      <span class="st-row-val" style="color: {% if s.savings_rate >= 25 %}#22c55e{% elif s.savings_rate <= 0 %}#dc3545{% else %}inherit{% endif %};">{{ s.savings_rate }}%</span>
    </div>
  </div>

  {# Discipline #}
  <div class="st-card">
    <div class="st-card-title">Дисциплина</div>
    <div class="st-card-score {{ score_color(s.discipline_score) }}">{{ s.discipline_score|round(0)|int }}</div>
    <div class="st-row">
      <span class="st-row-label">Выполнение в срок</span>
      <span class="st-row-val {{ score_color(s.global_discipline_percent) }}">{{ s.global_discipline_percent }}%</span>
    </div>
  </div>

  {# Projects #}
  <div class="st-card">
    <div class="st-card-title">Проекты</div>
    <div class="st-card-score {{ score_color(s.project_score) }}">{{ s.project_score|round(0)|int }}</div>
    <div class="st-row">
      <span class="st-row-label">Активных</span>
      <span class="st-row-val">{{ s.active_projects_count }}</span>
    </div>
    <div class="st-row">
      <span class="st-row-label">Средн. дисциплина</span>
      <span class="st-row-val {{ score_color(s.projects_avg_discipline) }}">{{ s.projects_avg_discipline }}%</span>
    </div>
    <div class="st-row">
      <span class="st-row-label">Просрочено</span>
      <span class="st-row-val" style="color: {% if s.projects_overdue_total > 0 %}#dc3545{% else %}inherit{% endif %};">{{ s.projects_overdue_total }}</span>
    </div>
  </div>

  {# Focus #}
  <div class="st-card">
    <div class="st-card-title">Фокус</div>
    <div class="st-card-score {{ score_color(s.focus_score) }}">{{ s.focus_score|round(0)|int }}</div>
    <div class="st-row">
      <span class="st-row-label">Задач в работе</span>
      <span class="st-row-val" style="color: {% if s.in_progress_total > 5 %}#dc3545{% elif s.in_progress_total > 3 %}#eab308{% else %}#22c55e{% endif %};">{{ s.in_progress_total }}</span>
    </div>
  </div>

</div>

{# ── Month dynamics (daily) ── #}
{% if dynamics %}
<div class="st-section">
  <div class="st-card-title">Динамика месяца</div>
  {% for d in dynamics %}
  <div class="st-dyn-row">
    <span class="st-dyn-date">{{ d.date.strftime('%d.%m') }}</span>
    <div class="st-dyn-track">
      <div class="st-dyn-fill" style="width: {{ d.life_score }}%; background: {{ bar_color(d.life_score) }};"></div>
    </div>
    <span class="st-dyn-num {{ score_color(d.life_score) }}">{{ d.life_score|round(0)|int }}</span>
    <span class="st-dyn-delta {% if d.delta > 0 %}clr-pos{% elif d.delta < 0 %}clr-neg{% endif %}">
      {% if d.delta > 0 %}+{% endif %}{% if d.delta != 0 %}{{ d.delta }}{% else %}&mdash;{% endif %}
    </span>
  </div>
  {% endfor %}
</div>
{% endif %}

{# ── Weekly Review ── #}
{% if weekly_review %}
<div class="st-section">
  <div class="st-card-title">Еженедельный отч&#1105;т (неделя {{ weekly_review.week_number }})</div>
  <div class="st-wr-grid">
    <div class="st-wr-metric">
      <div class="st-wr-metric-val {{ score_color(weekly_review.life_score_avg) }}">{{ weekly_review.life_score_avg|round(0)|int }}</div>
      <div class="st-wr-metric-label">Life Score (&#216;)</div>
    </div>
    <div class="st-wr-metric">
      <div class="st-wr-metric-val {% if weekly_review.improvement_trend > 0 %}clr-pos{% elif weekly_review.improvement_trend < 0 %}clr-neg{% endif %}">
        {% if weekly_review.improvement_trend > 0 %}+{% endif %}{{ weekly_review.improvement_trend }}
      </div>
      <div class="st-wr-metric-label">&#916; к пред. неделе</div>
    </div>
    <div class="st-wr-metric">
      <div class="st-wr-metric-val clr-bad" style="font-size: 18px;">{{ weekly_review.main_problem }}</div>
      <div class="st-wr-metric-label">Слабая зона</div>
    </div>
  </div>
  {% if weekly_review.recommendation %}
  <div class="st-wr-rec">
    &#128161; {{ weekly_review.recommendation }}
  </div>
  {% endif %}
</div>
{% endif %}

{# ── Trend (12 months) ── #}
{% if history %}
<div class="st-section">
  <div class="st-card-title">Тренд Life Score (12 мес.)</div>
  {% for h in history %}
  <div class="st-trend-row">
    <span class="st-trend-label">{{ h.month_label }}</span>
    <div class="st-trend-track">
      <div class="st-trend-fill" style="width: {{ h.life_score }}%; background: {{ bar_color(h.life_score) }};"></div>
    </div>
    <span class="st-trend-num {{ score_color(h.life_score) }}">{{ h.life_score|round(0)|int }}</span>
  </div>
  {% endfor %}
</div>
{% endif %}

{# ── Breakdown ("Что тянет вниз") ── #}
{% if breakdown %}
<div class="st-section">
  <div class="st-card-title">Что тянет вниз</div>
  {% for b in breakdown %}
  <div class="st-bd-item">
    <div class="st-bd-reason">
      <span class="st-bd-component">{{ b.component }}</span>
      {{ b.penalty_reason or b.metric_key }}
    </div>
    <span class="st-bd-penalty">&minus;{{ b.penalty_value }}</span>
    {% if b.link_url %}
    <a href="{{ b.link_url }}" class="st-bd-fix">Исправить &rarr;</a>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endif %}

{# ── Мои цели ── #}
<div class="st-section">
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
    <div class="st-card-title" style="margin-bottom: 0;">Мои цели</div>
    <button type="button" class="st-sim-btn" style="font-size: 12px; padding: 5px 12px;"
            onclick="document.getElementById('stAddForm').classList.toggle('open')">+ Добавить</button>
  </div>

  {% if flash and flash.type == 'error' %}
  <div style="padding: 8px 12px; background: #fef2f2; border: 1px solid #fca5a5; color: #b91c1c; border-radius: 6px; font-size: 13px; margin-bottom: 10px;">{{ flash.message }}</div>
  {% endif %}

  {% if targets_progress %}
    {% for t in targets_progress %}
    <div class="st-tgt-item">
      <div class="st-tgt-header">
        <span class="st-tgt-title">{{ t.title }}</span>
        <span class="st-tgt-values">
          <b>{{ "{:,.0f}".format(t.current).replace(",", " ") }}{{ t.unit }}</b>
          &rarr; {{ "{:,.0f}".format(t.target).replace(",", " ") }}{{ t.unit }}
        </span>
        <div class="st-tgt-actions">
          <button type="button" class="st-tgt-edit-btn" title="Изменить"
                  onclick="toggleTgtEdit({{ t.id }})">&#9998;</button>
          <form method="POST" action="/strategy/targets/{{ t.id }}/delete" style="display:inline;">
            <button type="submit" class="st-tgt-del-btn" title="Удалить"
                    onclick="return confirm('Удалить цель?')">&#x2715;</button>
          </form>
        </div>
      </div>
      <div class="st-tgt-track">
        <div class="st-tgt-fill" style="width: {{ t.progress_pct }}%;
          background: {% if t.achieved %}#22c55e{% elif t.progress_pct >= 60 %}#eab308{% else %}#dc3545{% endif %};"></div>
      </div>
      <div class="st-tgt-footer">
        <span>
          {% if t.direction == 'DOWN' %}снизить до{% else %}достичь{% endif %}
          {{ "{:,.0f}".format(t.target).replace(",", " ") }}{{ t.unit }}
        </span>
        <span class="st-tgt-badge {% if t.achieved %}done{% elif t.progress_pct >= 60 %}going{% else %}behind{% endif %}">
          {% if t.achieved %}Выполнено{% else %}{{ t.progress_pct }}%{% endif %}
        </span>
      </div>
      {# Inline edit form #}
      <form method="POST" action="/strategy/targets/{{ t.id }}/edit"
            class="st-tgt-edit-form" id="tgtEdit{{ t.id }}">
        <input type="text" name="title" class="title-inp" value="{{ t.title }}" placeholder="Название">
        <input type="number" name="target_value" step="0.1" value="{{ t.target }}" placeholder="Цель">
        <button type="submit" class="st-tgt-edit-save">OK</button>
      </form>
    </div>
    {% endfor %}
  {% else %}
    <p style="font-size: 14px; color: var(--text-secondary, #888); margin: 12px 0 4px;">
      Целей ещё нет. Нажмите «+ Добавить», чтобы поставить цель.
    </p>
  {% endif %}

  {# ── Add target form ── #}
  <div class="st-add-form" id="stAddForm">
    <form method="POST" action="/strategy/targets/add" id="stAddFormInner">
      <div class="st-add-grid">
        <div class="st-add-field">
          <label>Тип метрики</label>
          <select name="metric_type" id="stMetricType" onchange="stUpdateAddForm()">
            <option value="DEBT_LOAD">Долговая нагрузка</option>
            <option value="TASK_DISCIPLINE">Дисциплина задач</option>
            <option value="HABIT_DISCIPLINE">Дисциплина привычек</option>
            <option value="INCOME_CATEGORY">Доход по категории</option>
          </select>
        </div>
        <div class="st-add-field">
          <label>Целевое значение (<span id="stUnitHint">%</span>)</label>
          <input type="number" name="target_value" id="stTargetVal" step="0.1" min="0" required
                 placeholder="напр. 20">
        </div>
        <div class="st-add-field span-2" id="stCatField" style="display: none;">
          <label>Категория доходов</label>
          <select name="category_id">
            <option value="">— выберите —</option>
            {% for c in income_cats %}
            <option value="{{ c.category_id }}">{{ c.title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="st-add-field span-2">
          <label>Название цели</label>
          <input type="text" name="title" id="stTitleInput" required
                 placeholder="напр. Снизить долговую нагрузку до 20%">
        </div>
      </div>
      <div style="font-size: 12px; color: var(--text-secondary, #888); margin-bottom: 10px;">
        Текущее значение: <b id="stCurrentHint">
          {% if s.debt_ratio is defined %}{{ s.debt_ratio }}%{% endif %}
        </b>
      </div>
      <div class="st-add-actions">
        <button type="submit" class="st-add-submit">Сохранить цель</button>
        <button type="button" class="st-add-cancel"
                onclick="document.getElementById('stAddForm').classList.remove('open')">Отмена</button>
      </div>
    </form>
  </div>
</div>

{# ── Simulator "Что если" ── #}
<div class="st-section">
  <div class="st-card-title">Что если улучшить&hellip;</div>
  <form method="get" action="/strategy">
    <input type="hidden" name="year" value="{{ sel_year }}">
    <input type="hidden" name="month" value="{{ sel_month }}">
    <input type="hidden" name="simulate" value="1">
    <div class="st-sim">
      <div class="st-sim-field">
        <label>Дисциплина, %</label>
        <input type="number" name="discipline_target" min="0" max="100" step="1"
               value="{{ sim.discipline_target|round(0)|int if sim else s.global_discipline_percent|round(0)|int }}">
      </div>
      <div class="st-sim-field">
        <label>Задач в работе</label>
        <input type="number" name="focus_target" min="0" max="50" step="1"
               value="{{ sim.focus_target if sim else s.in_progress_total }}">
      </div>
      <div class="st-sim-field">
        <label>Долг. нагрузка, %</label>
        <input type="number" name="debt_ratio_target" min="0" max="100" step="0.1"
               value="{{ sim.debt_ratio if sim else s.debt_ratio }}">
      </div>
      <div class="st-sim-field">
        <label>Норма сбереж., %</label>
        <input type="number" name="savings_rate_target" min="-100" max="100" step="0.1"
               value="{{ sim.savings_rate if sim else s.savings_rate }}">
      </div>
    </div>
    <div style="margin-top: 12px;">
      <button type="submit" class="st-sim-btn">Рассчитать</button>
    </div>
  </form>

  {% if sim %}
  <div class="st-sim-result">
    <div>
      <div style="font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--text-secondary, #888); margin-bottom: 2px;">Было</div>
      <div class="st-sim-big {{ score_color(s.life_score) }}">{{ s.life_score|round(0)|int }}</div>
    </div>
    <div style="font-size: 24px; color: var(--text-secondary, #888);">&rarr;</div>
    <div>
      <div style="font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--text-secondary, #888); margin-bottom: 2px;">Станет</div>
      <div class="st-sim-big {{ score_color(sim.life_score) }}">{{ sim.life_score|round(0)|int }}</div>
    </div>
    <div>
      <span class="st-sim-delta {% if sim.delta > 0 %}clr-pos{% elif sim.delta < 0 %}clr-neg{% endif %}">
        {% if sim.delta > 0 %}+{% endif %}{{ sim.delta }}
      </span>
    </div>
    <div class="st-sim-detail">
      Фин: {{ sim.finance_score|round(0)|int }}
      &middot; Дисц: {{ sim.discipline_score|round(0)|int }}
      &middot; Проекты: {{ sim.project_score|round(0)|int }}
      &middot; Фокус: {{ sim.focus_score|round(0)|int }}
    </div>
  </div>
  {% endif %}
</div>

<script>
/* ── Strategy targets UI ── */
var ST_CURRENT = {
  DEBT_LOAD:        '{{ s.debt_ratio }}%',
  TASK_DISCIPLINE:  '{{ s.global_discipline_percent }}%',
  HABIT_DISCIPLINE: '—',
  INCOME_CATEGORY:  '—',
};
var ST_UNITS = {
  DEBT_LOAD: '%', TASK_DISCIPLINE: '%', HABIT_DISCIPLINE: '%', INCOME_CATEGORY: '₽/мес',
};
var ST_TITLES = {
  DEBT_LOAD: 'Снизить долговую нагрузку',
  TASK_DISCIPLINE: 'Повысить дисциплину задач',
  HABIT_DISCIPLINE: 'Повысить дисциплину привычек',
  INCOME_CATEGORY: 'Повысить доход по категории',
};

function stUpdateAddForm() {
  var type = document.getElementById('stMetricType').value;
  document.getElementById('stUnitHint').textContent = ST_UNITS[type] || '%';
  document.getElementById('stCurrentHint').textContent = ST_CURRENT[type] || '—';
  document.getElementById('stCatField').style.display = (type === 'INCOME_CATEGORY') ? '' : 'none';
  var titleInp = document.getElementById('stTitleInput');
  var usedTitles = Object.values(ST_TITLES);
  if (!titleInp.value || usedTitles.indexOf(titleInp.value) !== -1) {
    titleInp.value = ST_TITLES[type] || '';
  }
}

function toggleTgtEdit(id) {
  var el = document.getElementById('tgtEdit' + id);
  if (el) el.classList.toggle('open');
}

stUpdateAddForm();
</script>
{% endblock %}
