{% extends "base.html" %}
{% block title %}{{ project.title }} — FinLife{% endblock %}

{% block extra_head %}
<style>
  /* Status badges */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
  .badge-planned { background: #e9ecef; color: #555; }
  .badge-active { background: #dbeafe; color: #1d4ed8; }
  .badge-paused { background: #fef3c7; color: #92400e; }
  .badge-done { background: #d1fae5; color: #065f46; }
  .badge-archived { background: #374151; color: #d1d5db; }

  /* Board status badges */
  .board-badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; letter-spacing: 0.2px; text-transform: uppercase; }
  .board-backlog { background: #e9ecef; color: #555; }
  .board-todo { background: #dbeafe; color: #1d4ed8; }
  .board-in_progress { background: #ede9fe; color: #6d28d9; }
  .board-waiting { background: #ffedd5; color: #c2410c; }
  .board-done { background: #d1fae5; color: #065f46; }
  .board-badge:not(.board-backlog):not(.board-todo):not(.board-in_progress):not(.board-waiting):not(.board-done) { background: #e9ecef; color: #555; }

  /* Project header */
  .prj-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
  .prj-header h1 { margin: 0; font-size: 24px; }
  .prj-header-actions { display: flex; gap: 8px; margin-left: auto; align-items: center; }
  .prj-header-actions a, .prj-header-actions select { font-size: 13px; }

  /* Progress bar */
  .prj-progress-bar { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; flex: 1; min-width: 100px; max-width: 200px; }
  .prj-progress-fill { height: 100%; background: #22c55e; border-radius: 3px; transition: width 0.3s; }
  .prj-progress-text { font-size: 13px; font-weight: 600; color: var(--text-secondary, #888); }

  /* View switcher */
  .view-switcher { display: inline-flex; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; font-size: 12px; }
  .view-switcher a { padding: 4px 12px; text-decoration: none; color: #666; background: var(--bg-input, #fff); }
  .view-switcher a.active { background: #007AFF; color: #fff; }
  .view-switcher a:not(:last-child) { border-right: 1px solid #ddd; }

  /* Project tags */
  .ptag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; letter-spacing: 0.2px; }
  .ptag-gray { background: #e9ecef; color: #555; }
  .ptag-blue { background: #dbeafe; color: #1d4ed8; }
  .ptag-green { background: #d1fae5; color: #065f46; }
  .ptag-orange { background: #ffedd5; color: #c2410c; }
  .ptag-purple { background: #ede9fe; color: #6d28d9; }
  .ptag-remove { cursor: pointer; margin-left: 2px; opacity: 0.6; }
  .ptag-remove:hover { opacity: 1; }
  .tag-add-select { font-size: 10px; padding: 1px 2px; border: 1px solid #ddd; border-radius: 3px; background: var(--bg-input, #fff); color: var(--text-secondary, #888); width: 28px; cursor: pointer; }
  .task-tags { display: flex; gap: 3px; flex-wrap: wrap; align-items: center; }
  .tag-filter-bar { display: flex; gap: 6px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
  .tag-filter-link { text-decoration: none; }

  /* Add task form (list view) */
  .add-task-form { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
  .add-task-form select { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; flex: 1; background: var(--bg-input, #fff); color: var(--text-primary); }
  .add-task-form button { padding: 6px 14px; background: #007AFF; color: #fff; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; white-space: nowrap; }

  /* ── Kanban Board ── */
  .kanban-board { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; align-items: flex-start; }
  .kanban-col { width: 280px; min-width: 280px; flex-shrink: 0; }
  .kanban-col-hdr { position: sticky; top: 0; z-index: 2; padding: 10px 12px; display: flex; align-items: center; gap: 8px; background: var(--bg-card, #fff); border-radius: 8px 8px 0 0; border: 1px solid var(--border-color, #e5e7eb); border-bottom: none; }
  .kanban-col-count { background: #eee; border-radius: 10px; padding: 0 7px; font-size: 11px; font-weight: 600; color: #666; }
  .kanban-col-body { background: var(--bg-secondary, #f6f8fa); border: 1px solid var(--border-color, #e5e7eb); border-top: none; border-radius: 0 0 8px 8px; padding: 8px; min-height: 60px; display: flex; flex-direction: column; gap: 8px; }

  /* Mobile column tabs */
  .kanban-tabs { display: none; }

  /* Mobile: snap-scroll one column at a time */
  @media (max-width: 640px) {
    .kanban-tabs { display: flex; gap: 4px; margin-bottom: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .kanban-tab { padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.2px; cursor: pointer; white-space: nowrap; background: var(--bg-input, #fff); color: var(--text-secondary, #888); flex-shrink: 0; }
    .kanban-tab.active { background: #007AFF; color: #fff; border-color: #007AFF; }
    .kanban-board { scroll-snap-type: x mandatory; gap: 0; padding-bottom: 4px; scrollbar-width: none; -ms-overflow-style: none; }
    .kanban-board::-webkit-scrollbar { display: none; }
    .kanban-col { width: calc(100vw - 40px); min-width: calc(100vw - 40px); scroll-snap-align: start; padding: 0 6px; }
    .kanban-col:first-child { padding-left: 0; }
    .kanban-col:last-child { padding-right: 0; }
    .kanban-card-unlink { opacity: 0.5; }
  }

  /* WIP limit */
  .wip-badge { font-size: 10px; color: #888; margin-left: auto; }
  .wip-over { color: #dc3545; font-weight: 600; }

  /* Kanban card */
  .kanban-card { background: var(--bg-card, #fff); border: 1px solid var(--border-color, #e5e7eb); border-radius: 6px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); position: relative; transition: box-shadow 0.15s; }
  .kanban-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .kanban-card-title { font-size: 13px; font-weight: 500; line-height: 1.35; margin-bottom: 6px; color: var(--text-primary); }
  .kanban-card-done .kanban-card-title { text-decoration: line-through; color: var(--text-secondary, #999); }
  .kanban-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .kanban-card-due { font-size: 11px; color: var(--text-secondary, #888); }
  .kanban-card-overdue { color: #dc3545; font-weight: 500; }
  .kanban-card-arrows { display: flex; gap: 2px; margin-left: auto; }
  .kanban-arrow { background: none; border: 1px solid #ddd; border-radius: 3px; width: 22px; height: 22px; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #888; padding: 0; line-height: 1; }
  .kanban-arrow:hover { background: #f0f0f0; color: #333; border-color: #bbb; }
  .kanban-arrow:disabled { opacity: 0.3; cursor: default; }
  .kanban-arrow:disabled:hover { background: none; color: #888; border-color: #ddd; }

  /* Hover-reveal unlink × */
  .kanban-card-unlink { position: absolute; top: 6px; right: 6px; background: none; border: none; cursor: pointer; font-size: 14px; color: #ccc; padding: 0 2px; line-height: 1; opacity: 0; transition: opacity 0.15s; }
  .kanban-card:hover .kanban-card-unlink { opacity: 1; }
  .kanban-card-unlink:hover { color: #dc3545; }

  /* Quick-add form */
  .kanban-quick-add { display: flex; gap: 4px; }
  .kanban-quick-add input { flex: 1; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: var(--bg-input, #fff); color: var(--text-primary); }
  .kanban-quick-add input::placeholder { color: #bbb; }
  .kanban-quick-add button { padding: 6px 10px; background: #007AFF; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap; }

  /* ── List view (vertical) ── */
  .board-group { margin-bottom: 20px; }
  .board-group-hdr { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary, #888); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .board-group-count { background: #eee; border-radius: 10px; padding: 0 6px; font-size: 11px; font-weight: 600; color: #666; }
  .task-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 14px; }
  .task-row:last-child { border-bottom: none; }
  .task-row-title { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .task-row-due { font-size: 12px; color: var(--text-secondary, #888); white-space: nowrap; }
  .task-row-overdue { color: #dc3545; font-weight: 500; }
  .task-row-done .task-row-title { text-decoration: line-through; color: var(--text-secondary, #999); }
  .task-board-select { font-size: 11px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 3px; background: var(--bg-input, #fff); color: var(--text-primary); }
  .task-unlink { background: none; border: none; cursor: pointer; font-size: 14px; color: #999; padding: 2px 4px; line-height: 1; }
  .task-unlink:hover { color: #dc3545; }

  /* Dark mode */
  [data-theme$="-dark"] .board-group-count, [data-theme$="-dark"] .kanban-col-count { background: #21262d; color: #8b949e; }
  [data-theme$="-dark"] .task-row { border-bottom-color: #21262d; }
  [data-theme$="-dark"] .task-board-select { background: #0d1117; border-color: #30363d; color: #c9d1d9; }
  [data-theme$="-dark"] .prj-progress-bar { background: #21262d; }
  [data-theme$="-dark"] .badge-planned { background: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .badge-active { background: #1e3a5f; color: #58a6ff; }
  [data-theme$="-dark"] .badge-paused { background: #3d2e00; color: #f5a623; }
  [data-theme$="-dark"] .badge-done { background: #0d3320; color: #6fcf97; }
  [data-theme$="-dark"] .badge-archived { background: #21262d; color: #6e7681; }
  [data-theme$="-dark"] .board-backlog { background: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .board-todo { background: #1e3a5f; color: #58a6ff; }
  [data-theme$="-dark"] .board-in_progress { background: #2d1b69; color: #a78bfa; }
  [data-theme$="-dark"] .board-waiting { background: #3d2200; color: #fb923c; }
  [data-theme$="-dark"] .board-done { background: #0d3320; color: #6fcf97; }
  [data-theme$="-dark"] .board-badge:not(.board-backlog):not(.board-todo):not(.board-in_progress):not(.board-waiting):not(.board-done) { background: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .ptag-gray { background: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .ptag-blue { background: #1e3a5f; color: #58a6ff; }
  [data-theme$="-dark"] .ptag-green { background: #0d3320; color: #6fcf97; }
  [data-theme$="-dark"] .ptag-orange { background: #3d2200; color: #fb923c; }
  [data-theme$="-dark"] .ptag-purple { background: #2d1b69; color: #a78bfa; }
  [data-theme$="-dark"] .tag-add-select { background: #0d1117; border-color: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .view-switcher { border-color: #30363d; }
  [data-theme$="-dark"] .view-switcher a { background: #0d1117; color: #8b949e; border-color: #30363d; }
  [data-theme$="-dark"] .view-switcher a.active { background: #007AFF; color: #fff; }
  [data-theme$="-dark"] .kanban-col-hdr { background: var(--bg-card, #161b22); border-color: #30363d; }
  [data-theme$="-dark"] .kanban-col-body { background: #0d1117; border-color: #30363d; }
  [data-theme$="-dark"] .kanban-card { background: var(--bg-card, #161b22); border-color: #30363d; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  [data-theme$="-dark"] .kanban-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
  [data-theme$="-dark"] .kanban-arrow { border-color: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .kanban-arrow:hover { background: #21262d; color: #c9d1d9; border-color: #484f58; }
  [data-theme$="-dark"] .kanban-quick-add input { background: #0d1117; border-color: #30363d; color: #c9d1d9; }
  [data-theme$="-dark"] .kanban-card-unlink { color: #484f58; }
  [data-theme$="-dark"] .kanban-card-unlink:hover { color: #f85149; }
  [data-theme$="-dark"] .kanban-tab { background: #0d1117; border-color: #30363d; color: #8b949e; }
  [data-theme$="-dark"] .kanban-tab.active { background: #007AFF; color: #fff; border-color: #007AFF; }
</style>
{% endblock %}

{% set STATUS_LABELS = {"planned": "Запланирован", "active": "Активный", "paused": "Пауза", "done": "Завершён", "archived": "Архив"} %}
{# board_labels and board_statuses come from route context (dynamic per project) #}
{% set WIP_LIMIT = 5 %}

{% block content %}

{# ── Header ── #}
<div style="margin-bottom: 4px;">
  <a href="/projects" style="font-size: 13px; color: #007AFF; text-decoration: none;">&larr; Проекты</a>
</div>

<div class="prj-header">
  <h1>{{ project.title }}</h1>
  <span class="badge badge-{{ project.status }}">{{ STATUS_LABELS.get(project.status, project.status) }}</span>
  <div style="display: flex; align-items: center; gap: 8px;">
    <span class="prj-progress-text">{{ project.progress }}%</span>
    <div class="prj-progress-bar"><div class="prj-progress-fill" style="width: {{ project.progress }}%"></div></div>
    <span style="font-size: 12px; color: var(--text-secondary, #888);">{{ project.done_tasks }}/{{ project.total_tasks }}</span>
  </div>
  <div class="prj-header-actions">
    <div class="view-switcher">
      <a href="/projects/{{ project.id }}?view=list{% if active_tag_filter %}&tag={{ active_tag_filter.id }}{% endif %}" class="{{ 'active' if current_view == 'list' }}">Список</a>
      <a href="/projects/{{ project.id }}?view=kanban{% if active_tag_filter %}&tag={{ active_tag_filter.id }}{% endif %}" class="{{ 'active' if current_view == 'kanban' }}">Канбан</a>
    </div>
    <form method="POST" action="/projects/{{ project.id }}/status" style="display: flex; gap: 4px;">
      <select name="status" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: var(--bg-input, #fff); color: var(--text-primary);">
        {% for s in all_statuses %}
        {% if s != "archived" %}
        <option value="{{ s }}" {{ 'selected' if project.status == s }}>{{ STATUS_LABELS.get(s, s) }}</option>
        {% endif %}
        {% endfor %}
      </select>
      <button type="submit" style="padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; cursor: pointer; background: var(--bg-input, #fff); color: var(--text-primary);">OK</button>
    </form>
    <a href="/projects/{{ project.id }}/edit" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-decoration: none; color: #666;">Ред.</a>
    <a href="/projects/{{ project.id }}/tags" style="padding: 4px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-decoration: none; color: #666;">Теги</a>
  </div>
</div>

{% if project.description %}
<p style="font-size: 14px; color: var(--text-secondary, #888); margin: 0 0 16px;">{{ project.description }}</p>
{% endif %}

{# ── Actions bar ── #}
<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
  <a href="/projects/{{ project.id }}/tasks/create"
     style="padding: 6px 14px; background: #007AFF; color: #fff; border: none; border-radius: 4px; font-size: 13px; text-decoration: none; white-space: nowrap;">+ Добавить задачу</a>
  {% if unassigned_tasks %}
  <form method="POST" class="add-task-form" style="margin-bottom: 0;">
  <select name="task_id_and_project" id="assignSelect">
    <option value="">Добавить задачу в проект...</option>
    {% for t in unassigned_tasks %}
    <option value="{{ t.task_id }}">{{ t.title }}{% if t.due_date %} ({{ t.due_date.strftime('%d.%m') }}){% endif %}</option>
    {% endfor %}
  </select>
  <button type="button" onclick="assignTask()">Добавить</button>
  </form>
  {% endif %}
</div>

{# ── Tag filter ── #}
{% if active_tag_filter %}
<div class="tag-filter-bar">
  <span style="font-size: 12px; color: var(--text-secondary, #888);">Фильтр:</span>
  <span class="ptag ptag-{{ active_tag_filter.color or 'gray' }}">{{ active_tag_filter.name }}</span>
  <a href="/projects/{{ project.id }}?view={{ current_view }}" style="font-size: 12px; color: #dc3545; text-decoration: none;">&times; сбросить</a>
</div>
{% elif project.project_tags %}
<div class="tag-filter-bar">
  {% for pt in project.project_tags %}
  <a href="/projects/{{ project.id }}?tag={{ pt.id }}&view={{ current_view }}" class="tag-filter-link"><span class="ptag ptag-{{ pt.color or 'gray' }}">{{ pt.name }}</span></a>
  {% endfor %}
</div>
{% endif %}

{# ══════════════ KANBAN VIEW ══════════════ #}
{% if current_view == 'kanban' %}

{# Mobile column tabs #}
<div class="kanban-tabs" id="kanbanTabs">
  {% for bs in board_statuses %}
  {% set col_count = project.groups.get(bs, [])|length %}
  <button type="button" class="kanban-tab{{ ' active' if loop.first }}" data-col="{{ loop.index0 }}">{{ board_labels.get(bs, bs) }} <span style="opacity:0.6;">{{ col_count }}</span></button>
  {% endfor %}
</div>

<div class="kanban-board" id="kanbanBoard">
  {% for bs in board_statuses %}
  {% set tasks = project.groups.get(bs, []) %}
  {% set col_count = tasks|length %}
  <div class="kanban-col">
    <div class="kanban-col-hdr">
      <span class="board-badge board-{{ bs }}">{{ board_labels.get(bs, bs) }}</span>
      <span class="kanban-col-count">{{ col_count }}</span>
      {% if bs == 'in_progress' %}
      <span class="wip-badge{{ ' wip-over' if col_count > WIP_LIMIT }}">WIP {{ col_count }}/{{ WIP_LIMIT }}</span>
      {% endif %}
    </div>
    <div class="kanban-col-body">
      {% for t in tasks %}
      <div class="kanban-card{{ ' kanban-card-done' if t.board_status == 'done' }}">
        {# Hover-reveal × remove #}
        <form method="POST" action="/tasks/{{ t.task_id }}/assign" style="display:inline;">
          <input type="hidden" name="project_id" value="0">
          <button type="submit" class="kanban-card-unlink" title="Убрать из проекта">&times;</button>
        </form>

        <div class="kanban-card-title">{{ t.title }}</div>

        {# Tags #}
        {% if t.tags %}
        <div class="task-tags" style="margin-bottom: 6px;">
          {% for tag in t.tags %}
          <span class="ptag ptag-{{ tag.color or 'gray' }}">{{ tag.name }}<form method="POST" action="/projects/{{ project.id }}/tasks/{{ t.task_id }}/tags/remove" style="display:inline;"><input type="hidden" name="project_tag_id" value="{{ tag.id }}"><button type="submit" class="ptag-remove" title="Убрать тег">&times;</button></form></span>
          {% endfor %}
        </div>
        {% endif %}

        <div class="kanban-card-meta">
          {# Due date #}
          {% if t.due_date %}
          <span class="kanban-card-due{{ ' kanban-card-overdue' if t.is_overdue }}">{{ t.due_date.strftime('%d.%m') }}</span>
          {% endif %}
          {# Add tag #}
          {% if project.project_tags %}
          <form method="POST" action="/projects/{{ project.id }}/tasks/{{ t.task_id }}/tags/add" style="display:inline;">
            <select name="project_tag_id" class="tag-add-select" onchange="if(this.value)this.form.submit()" title="Добавить тег">
              <option value="">+</option>
              {% for pt in project.project_tags if pt.id not in t.tag_ids %}
              <option value="{{ pt.id }}">{{ pt.name }}</option>
              {% endfor %}
            </select>
          </form>
          {% endif %}
          {# ← → arrows #}
          {% set last_idx = board_statuses|length - 1 %}
          <div class="kanban-card-arrows">
            {% set idx = board_statuses.index(bs) if bs in board_statuses else 0 %}
            <form method="POST" action="/tasks/{{ t.task_id }}/board-status" style="display:inline;">
              <input type="hidden" name="project_id" value="{{ project.id }}">
              <input type="hidden" name="board_status" value="{{ board_statuses[idx - 1] if idx > 0 else bs }}">
              <button type="submit" class="kanban-arrow" title="{{ board_labels.get(board_statuses[idx - 1], '') if idx > 0 else '' }}" {{ 'disabled' if idx == 0 }}>&larr;</button>
            </form>
            <form method="POST" action="/tasks/{{ t.task_id }}/board-status" style="display:inline;">
              <input type="hidden" name="project_id" value="{{ project.id }}">
              <input type="hidden" name="board_status" value="{{ board_statuses[idx + 1] if idx < last_idx else bs }}">
              <button type="submit" class="kanban-arrow" title="{{ board_labels.get(board_statuses[idx + 1], '') if idx < last_idx else '' }}" {{ 'disabled' if idx == last_idx }}>&rarr;</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}

      {# Quick-add form in all columns except done #}
      {% if bs != 'done' %}
      <form method="POST" action="/projects/{{ project.id }}/tasks/quick-add" class="kanban-quick-add">
        <input type="hidden" name="board_status" value="{{ bs }}">
        <input name="title" placeholder="Новая задача..." required>
        <button type="submit">+</button>
      </form>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

{# ══════════════ LIST VIEW ══════════════ #}
{% else %}

{% for bs in board_statuses %}
{% set tasks = project.groups.get(bs, []) %}
<div class="board-group">
  <div class="board-group-hdr">
    <span class="board-badge board-{{ bs }}">{{ board_labels.get(bs, bs) }}</span>
    <span class="board-group-count">{{ tasks|length }}</span>
  </div>

  {% if tasks %}
  <div class="card" style="padding: 0;">
    {% for t in tasks %}
    <div class="task-row{% if t.board_status == 'done' %} task-row-done{% endif %}">
      <div class="task-row-title">
        {{ t.title }}
        {% if t.tags %}
        <div class="task-tags" style="margin-top: 2px;">
          {% for tag in t.tags %}
          <span class="ptag ptag-{{ tag.color or 'gray' }}">{{ tag.name }}<form method="POST" action="/projects/{{ project.id }}/tasks/{{ t.task_id }}/tags/remove" style="display: inline;"><input type="hidden" name="project_tag_id" value="{{ tag.id }}"><button type="submit" class="ptag-remove" title="Убрать тег">&times;</button></form></span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% if t.due_date %}
      <span class="task-row-due{% if t.is_overdue %} task-row-overdue{% endif %}">{{ t.due_date.strftime('%d.%m') }}</span>
      {% endif %}
      {% if project.project_tags %}
      <form method="POST" action="/projects/{{ project.id }}/tasks/{{ t.task_id }}/tags/add" style="display: inline;">
        <select name="project_tag_id" class="tag-add-select" onchange="if(this.value)this.form.submit()" title="Добавить тег">
          <option value="">+</option>
          {% for pt in project.project_tags if pt.id not in t.tag_ids %}
          <option value="{{ pt.id }}">{{ pt.name }}</option>
          {% endfor %}
        </select>
      </form>
      {% endif %}
      <form method="POST" action="/tasks/{{ t.task_id }}/board-status" style="display: inline;">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <select name="board_status" class="task-board-select" onchange="this.form.submit()">
          {% for s in board_statuses %}
          <option value="{{ s }}" {{ 'selected' if t.board_status == s }}>{{ board_labels.get(s, s) }}</option>
          {% endfor %}
        </select>
      </form>
      <form method="POST" action="/tasks/{{ t.task_id }}/assign" style="display: inline;">
        <input type="hidden" name="project_id" value="0">
        <button type="submit" class="task-unlink" title="Убрать из проекта">&times;</button>
      </form>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endfor %}

{% endif %}

{# ── Related articles ── #}
{% if related_articles %}
<div style="margin-top: 8px;">
  <div style="font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary, #888); margin-bottom: 8px;">Связанные статьи</div>
  <div class="card" style="padding: 0;">
    {% set KB_TYPE_LABELS = {"note": "Заметка", "instruction": "Инструкция", "checklist": "Чеклист", "template": "Шаблон", "reference": "Справка"} %}
    {% for a in related_articles %}
    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border-color, #f0f0f0); font-size: 14px;">
      <a href="/knowledge/{{ a.id }}" style="flex: 1; color: inherit; text-decoration: none;">{{ a.title }}</a>
      <span class="board-badge" style="background: #e9ecef; color: #555; font-size: 9px;">{{ KB_TYPE_LABELS.get(a.type, a.type) }}</span>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<script>
function assignTask() {
  var sel = document.getElementById('assignSelect');
  var taskId = sel.value;
  if (!taskId) return;
  var form = document.createElement('form');
  form.method = 'POST';
  form.action = '/tasks/' + taskId + '/assign';
  var input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'project_id';
  input.value = '{{ project.id }}';
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}

// Mobile kanban tab ↔ scroll sync
(function() {
  var board = document.getElementById('kanbanBoard');
  var tabs = document.getElementById('kanbanTabs');
  if (!board || !tabs) return;
  var tabBtns = tabs.querySelectorAll('.kanban-tab');
  var cols = board.querySelectorAll('.kanban-col');

  // Click tab → scroll to column
  tabBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var idx = parseInt(btn.dataset.col);
      if (cols[idx]) cols[idx].scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
    });
  });

  // Scroll → update active tab
  var scrollTimer;
  board.addEventListener('scroll', function() {
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(function() {
      var boardRect = board.getBoundingClientRect();
      var center = boardRect.left + boardRect.width / 2;
      var closest = 0, minDist = Infinity;
      cols.forEach(function(col, i) {
        var colRect = col.getBoundingClientRect();
        var dist = Math.abs(colRect.left + colRect.width / 2 - center);
        if (dist < minDist) { minDist = dist; closest = i; }
      });
      tabBtns.forEach(function(b, i) {
        b.classList.toggle('active', i === closest);
      });
    }, 50);
  });
})();
</script>
{% endblock %}
