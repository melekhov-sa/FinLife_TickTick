{% extends "base.html" %}

{% block title %}–•–æ—Ç–µ–ª–∫–∏{% endblock %}

{% block content %}
<!-- Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
  <div style="display: flex; gap: 12px; align-items: baseline;">
    <h1 style="margin: 0;">–•–æ—Ç–µ–ª–∫–∏</h1>
    <a href="/wishes/purchase" style="text-decoration: none; font-size: 14px; color: var(--text-secondary, #666);">–ó–∞–∫—É–ø–∫–∞</a>
  </div>
  <a href="/wishes/new" class="btn">+ –ù–æ–≤–∞—è —Ö–æ—Ç–µ–ª–∫–∞</a>
</div>

<!-- Toolbar: filters -->
<div class="card" style="padding: 12px 16px; margin-bottom: 12px;">
  <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
    <select onchange="updateFilter('period', this.value)" style="font-size: 13px;">
      <option value="all" {% if period == 'all' %}selected{% endif %}>–í—Å–µ</option>
      <option value="14days" {% if period == '14days' %}selected{% endif %}>14 –¥–Ω–µ–π</option>
      <option value="this_month" {% if period == 'this_month' %}selected{% endif %}>–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
      <option value="next_month" {% if period == 'next_month' %}selected{% endif %}>–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü</option>
    </select>
    <select onchange="updateFilter('status', this.value)" style="font-size: 13px;">
      <option value="active" {% if status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
      <option value="IDEA" {% if status == 'IDEA' %}selected{% endif %}>–ò–¥–µ–∏</option>
      <option value="CONSIDERING" {% if status == 'CONSIDERING' %}selected{% endif %}>–î—É–º–∞—é</option>
      <option value="PLANNED" {% if status == 'PLANNED' %}selected{% endif %}>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
      <option value="DONE" {% if status == 'DONE' %}selected{% endif %}>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
      <option value="all" {% if status == 'all' %}selected{% endif %}>–í—Å–µ</option>
    </select>
    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫..." value="{{ search }}"
           onkeyup="if(event.key === 'Enter') updateFilter('search', this.value)"
           style="font-size: 13px; flex: 1; min-width: 180px;">
    <button onclick="updateFilter('search', document.getElementById('search-input').value)"
            style="padding: 6px 12px; background: transparent; border: 1px solid var(--border-color, #ddd); border-radius: 6px; cursor: pointer; font-size: 13px;">
      üîç
    </button>
  </div>
</div>

{# ‚îÄ‚îÄ Summary line ‚îÄ‚îÄ #}
<div class="wish-summary">
  –ê–∫—Ç–∏–≤–Ω—ã—Ö: {{ count_active }} ¬∑ –í –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π: {{ count_next30 }} ¬∑ –° –ø–æ–≤—Ç–æ—Ä–æ–º: {{ count_recurring }}
</div>

{# ‚îÄ‚îÄ Wishes grouped by type ‚îÄ‚îÄ #}
{% set type_labels = {
    'PURCHASE': 'üí∞ –ü–æ–∫—É–ø–∫–∏',
    'EVENT': 'üéâ –°–æ–±—ã—Ç–∏—è',
    'PLACE': 'üåç –ú–µ—Å—Ç–∞',
    'OTHER': 'üìù –î—Ä—É–≥–æ–µ'
} %}

{% set has_any = grouped_wishes.get('PURCHASE', []) or grouped_wishes.get('EVENT', []) or grouped_wishes.get('PLACE', []) or grouped_wishes.get('OTHER', []) %}

{% if has_any %}
{% for type_key in ['PURCHASE', 'EVENT', 'PLACE', 'OTHER'] %}
  {% set items = grouped_wishes.get(type_key, []) %}
  {% if items %}
  <div class="card wish-group">
    <div class="wish-group-header">
      <span>{{ type_labels.get(type_key, type_key) }}</span>
      <span class="badge" style="font-size: 12px;">{{ items|length }}</span>
    </div>
    {% for it in items %}
    <div class="wish-row{% if it.is_overdue %} wish-row--overdue{% endif %}">
      <div class="wish-body">
        <div class="wish-title">
          <a href="/wishes/{{ it.wish.wish_id }}/edit" style="color: inherit; text-decoration: none;">{{ it.wish.title }}</a>
          {% if it.wish.is_recurring %}
          <span class="wish-badge-repeat">–ø–æ–≤—Ç–æ—Ä</span>
          {% endif %}
        </div>
        <div class="wish-meta{% if it.is_overdue %} wish-meta--overdue{% endif %}">{{ it.meta }}</div>
        {% if it.wish.estimated_amount %}
        <div class="wish-meta">{{ "{:,.0f}".format(it.wish.estimated_amount).replace(",", " ") }} —Ä—É–±.</div>
        {% endif %}
        {% if it.wish.notes %}
        <div class="wish-notes">{{ it.wish.notes[:80] }}{% if it.wish.notes|length > 80 %}...{% endif %}</div>
        {% endif %}
      </div>
      <div class="wish-actions">
        <form method="POST" action="/wishes/{{ it.wish.wish_id }}/to-task" style="margin:0;">
          <button type="submit" class="wish-btn-task" title="–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É">‚Üí –í –∑–∞–¥–∞—á—É</button>
        </form>
        <a href="/wishes/{{ it.wish.wish_id }}/edit" class="btn-gear" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">&#9881;</a>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
{% endfor %}
{% else %}
<div class="card" style="text-align: center; padding: 48px 20px; color: var(--text-secondary, #999);">
  <div style="font-size: 40px; margin-bottom: 12px;">üí≠</div>
  <div style="font-size: 15px;">–•–æ—Ç–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  <div style="font-size: 13px; margin-top: 8px;">
    <a href="/wishes/new" style="color: #007AFF;">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Ö–æ—Ç–µ–ª–∫—É</a>
  </div>
</div>
{% endif %}

<style>
/* ‚îÄ‚îÄ Wish summary ‚îÄ‚îÄ */
.wish-summary {
  font-size: 13px;
  color: var(--text-secondary, #888);
  margin-bottom: 16px;
  padding: 0 2px;
}

/* ‚îÄ‚îÄ Wish group ‚îÄ‚îÄ */
.wish-group {
  margin-bottom: 12px;
}
.wish-group-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: var(--text-secondary, #888);
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color, #eee);
  margin-bottom: 4px;
}

/* ‚îÄ‚îÄ Wish row ‚îÄ‚îÄ */
.wish-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 9px 0;
  border-bottom: 1px solid var(--border-color, #f5f5f5);
}
.wish-row:last-child {
  border-bottom: none;
  padding-bottom: 0;
}
.wish-body {
  flex: 1;
  min-width: 0;
}
.wish-title {
  font-size: 14px;
  font-weight: 500;
  line-height: 1.3;
}
.wish-badge-repeat {
  font-size: 11px;
  font-weight: 400;
  background: #e3f2fd;
  color: #1976d2;
  padding: 1px 6px;
  border-radius: 3px;
  margin-left: 4px;
  vertical-align: middle;
}
.wish-meta {
  font-size: 12px;
  color: var(--text-secondary, #888);
  margin-top: 2px;
}
.wish-meta--overdue {
  color: #c62828;
}
.wish-row--overdue .wish-title {
  color: #c62828;
}
.wish-notes {
  font-size: 11px;
  color: var(--text-secondary, #999);
  margin-top: 2px;
}
.wish-actions {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}
.wish-btn-task {
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 6px;
  border: 1px solid var(--border-color, #ddd);
  background: transparent;
  color: var(--text-secondary, #666);
  cursor: pointer;
  white-space: nowrap;
  transition: background .15s, color .15s;
}
.wish-btn-task:hover {
  background: var(--bg-hover, rgba(128,128,128,.1));
  color: var(--text-primary, #333);
}

/* ‚îÄ‚îÄ Dark mode ‚îÄ‚îÄ */
[data-theme$="-dark"] .wish-badge-repeat {
  background: #1a3040;
  color: #58a6ff;
}
[data-theme$="-dark"] .wish-btn-task {
  border-color: #444;
  color: #aaa;
}
[data-theme$="-dark"] .wish-btn-task:hover {
  background: rgba(255,255,255,.08);
  color: #ddd;
}

/* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
@media (max-width: 600px) {
  .wish-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
    padding: 10px 8px;
  }
  .wish-actions {
    align-self: flex-end;
  }
}
</style>

<script>
function updateFilter(param, value) {
    const url = new URL(window.location);
    if (value) {
        url.searchParams.set(param, value);
    } else {
        url.searchParams.delete(param);
    }
    window.location = url.toString();
}
</script>
{% endblock %}
