{% extends "base.html" %}
{% block title %}События - FinLife{% endblock %}

{% block content %}
<h1>&#128198; События</h1>

{% if error %}
<div class="error-card">{{ error }}</div>
{% endif %}

<!-- Filter presets (moved to top) -->
{% if presets %}
<div class="card" style="padding: 12px 24px;">
  <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
    <span class="muted" style="font-size: 13px; font-weight: 600;">Фильтры:</span>
    {% for preset in presets %}
      <div style="display: inline-flex; align-items: center; gap: 4px;">
        {% if preset.is_selected %}
          <span class="badge" style="background: #d4edda; color: #155724;">{{ preset.name }}</span>
        {% else %}
          <form method="POST" action="/events/presets/{{ preset.id }}/select" style="margin:0; display:inline;">
            <button type="submit" style="font-size: 11px; padding: 2px 8px;">{{ preset.name }}</button>
          </form>
        {% endif %}
        <form method="POST" action="/events/presets/{{ preset.id }}/delete" style="margin:0; display:inline;">
          <button type="submit" class="danger" style="font-size: 10px; padding: 1px 5px;"
                  onclick="return confirm('Удалить пресет?')">&#10005;</button>
        </form>
      </div>
    {% endfor %}
    <details style="display: inline;">
      <summary style="cursor: pointer; font-size: 12px; color: #007AFF;">+ Пресет</summary>
      <form method="POST" action="/events/presets/create" style="padding: 8px 0; display: flex; gap: 8px; align-items: end;">
        <div>
          <label style="font-size: 12px;">Название</label>
          <input name="name" placeholder="Например: Работа" required style="max-width: 150px; font-size: 12px; padding: 4px 8px;">
        </div>
        <div>
          <label style="font-size: 12px;">ID категорий</label>
          <input name="category_ids" placeholder="1,2,3" style="max-width: 100px; font-size: 12px; padding: 4px 8px;">
        </div>
        <button type="submit" style="font-size: 12px; padding: 4px 10px;">Создать</button>
      </form>
    </details>
  </div>
</div>
{% endif %}

<!-- Today's events -->
<div class="card">
  <h2>Сегодня ({{ today.strftime('%d.%m.%Y') }})</h2>
  {% if today_events %}
    <table>
      <thead>
        <tr><th>Время</th><th>Событие</th><th>Категория</th><th></th></tr>
      </thead>
      <tbody>
        {% for occ in today_events %}
          {% set ev = event_map.get(occ.event_id) %}
          {% set wc = wc_map.get(ev.category_id) if ev else None %}
        <tr>
          <td style="white-space: nowrap;">
            {% if occ.start_time %}
              {{ occ.start_time.strftime('%H:%M') }}
              {% if occ.end_time %} — {{ occ.end_time.strftime('%H:%M') }}{% endif %}
            {% else %}
              <span class="muted">весь день</span>
            {% endif %}
          </td>
          <td>
            <strong>{{ ev.title if ev else 'Событие #' ~ occ.event_id }}</strong>
            {% if ev and ev.importance > 0 %}
              <span class="badge">&#9733; {{ ev.importance }}</span>
            {% endif %}
            {% if ev and ev.description %}
              <br><small class="muted">{{ ev.description }}</small>
            {% endif %}
            {% if occ.end_date and occ.end_date != occ.start_date %}
              <br><small class="muted">до {{ occ.end_date.strftime('%d.%m.%Y') }}</small>
            {% endif %}
          </td>
          <td>
            {% if wc %}
              {{ wc.emoji or '' }} {{ wc.title }}
            {% endif %}
          </td>
          <td>
            {% if not occ.is_cancelled %}
              <form method="POST" action="/events/occurrences/{{ occ.id }}/cancel" style="display:inline;">
                <button type="submit" class="danger" style="font-size: 12px; padding: 4px 10px;"
                        onclick="return confirm('Отменить это вхождение?')">Отменить</button>
              </form>
            {% else %}
              <span class="muted">отменено</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Нет событий на сегодня</p>
  {% endif %}
</div>

<!-- Week events -->
<div class="card">
  <h2>Ближайшие 7 дней</h2>
  {% if week_events %}
    <table>
      <thead>
        <tr><th>Дата</th><th>Время</th><th>Событие</th><th>Категория</th><th></th></tr>
      </thead>
      <tbody>
        {% for occ in week_events %}
          {% set ev = event_map.get(occ.event_id) %}
          {% set wc = wc_map.get(ev.category_id) if ev else None %}
        <tr>
          <td style="white-space: nowrap;">
            {{ occ.start_date.strftime('%d.%m') }}
            {% if occ.start_date == today %}<small class="positive">(сегодня)</small>{% endif %}
          </td>
          <td style="white-space: nowrap;">
            {% if occ.start_time %}
              {{ occ.start_time.strftime('%H:%M') }}
            {% else %}
              <span class="muted">весь день</span>
            {% endif %}
          </td>
          <td>
            <strong>{{ ev.title if ev else 'Событие #' ~ occ.event_id }}</strong>
            {% if ev and ev.importance > 0 %}
              <span class="badge">&#9733; {{ ev.importance }}</span>
            {% endif %}
            {% if occ.end_date and occ.end_date != occ.start_date %}
              <small class="muted">до {{ occ.end_date.strftime('%d.%m') }}</small>
            {% endif %}
          </td>
          <td>
            {% if wc %}
              {{ wc.emoji or '' }} {{ wc.title }}
            {% endif %}
          </td>
          <td>
            {% if not occ.is_cancelled %}
              <form method="POST" action="/events/occurrences/{{ occ.id }}/cancel" style="display:inline;">
                <button type="submit" class="danger" style="font-size: 12px; padding: 4px 10px;"
                        onclick="return confirm('Отменить?')">Отменить</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Нет событий на ближайшие 7 дней</p>
  {% endif %}
  <p style="margin-top: 8px;"><a href="/events/history">История событий &rarr;</a></p>
</div>

<!-- Event management -->
<div class="card">
  <h2>Управление событиями</h2>
  {% if active_events %}
    <table>
      <thead>
        <tr><th>Название</th><th>Категория</th><th>Важность</th><th>Повтор</th><th>Действия</th></tr>
      </thead>
      <tbody>
        {% for ev in active_events %}
          {% set wc = wc_map.get(ev.category_id) %}
          {% set rule = rule_map.get(ev.repeat_rule_id) if ev.repeat_rule_id else None %}
        <tr>
          <td>
            {{ ev.title }}
            {% if ev.description %}<br><small class="muted">{{ ev.description }}</small>{% endif %}
          </td>
          <td>{% if wc %}{{ wc.emoji or '' }} {{ wc.title }}{% endif %}</td>
          <td>{% if ev.importance > 0 %}&#9733; {{ ev.importance }}{% else %}<span class="muted">-</span>{% endif %}</td>
          <td>
            {% if rule %}
              <span class="badge">
                {% if rule.freq == 'YEARLY' %}ежегодно
                {% elif rule.freq == 'MONTHLY' %}ежемесячно
                {% elif rule.freq == 'WEEKLY' %}еженедельно
                {% elif rule.freq in ('DAILY', 'INTERVAL_DAYS') %}каждые {{ rule.interval }} дн.
                {% else %}повтор{% endif %}
              </span>
            {% else %}
              <span class="muted">разово</span>
            {% endif %}
          </td>
          <td style="white-space: nowrap;">
            <!-- Edit event -->
            <details style="display: inline;">
              <summary style="cursor: pointer; font-size: 12px; color: #007AFF;">Изменить</summary>
              <div style="padding: 8px 0;">
                <form method="POST" action="/events/{{ ev.event_id }}/update">
                  <div class="form-row">
                    <label>Название</label>
                    <input name="title" value="{{ ev.title }}" required>
                  </div>
                  <div class="form-row">
                    <label>Категория</label>
                    <select name="category_id" required>
                      {% for wc2 in work_categories %}
                        <option value="{{ wc2.category_id }}" {% if wc2.category_id == ev.category_id %}selected{% endif %}>{{ wc2.emoji or '' }} {{ wc2.title }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-row">
                    <label>Описание</label>
                    <input name="description" value="{{ ev.description or '' }}">
                  </div>
                  <div class="form-row">
                    <label>Важность (0-5)</label>
                    <input name="importance" type="number" min="0" max="5" value="{{ ev.importance }}" style="max-width: 80px;">
                  </div>
                  {% if rule %}
                  <!-- Recurrence editing -->
                  <input type="hidden" name="edit_recurrence" value="1">
                  <div class="form-row">
                    <label>Тип повтора</label>
                    <select name="recurrence_type" onchange="toggleEditRecFields(this, 'edit-rec-{{ ev.event_id }}')">
                      <option value="yearly" {% if rule.freq == 'YEARLY' %}selected{% endif %}>Ежегодно</option>
                      <option value="monthly" {% if rule.freq == 'MONTHLY' %}selected{% endif %}>Ежемесячно</option>
                      <option value="weekly" {% if rule.freq == 'WEEKLY' %}selected{% endif %}>Еженедельно</option>
                      <option value="interval" {% if rule.freq in ('DAILY', 'INTERVAL_DAYS') %}selected{% endif %}>Каждые N дней</option>
                    </select>
                  </div>
                  <div id="edit-rec-{{ ev.event_id }}">
                    <div class="rec-yearly-fields" {% if rule.freq != 'YEARLY' %}style="display:none;"{% endif %}>
                      <div class="form-row">
                        <label>Месяц</label>
                        <select name="rec_month">
                          {% for m in range(1, 13) %}
                          <option value="{{ m }}" {% if rule.by_month == m %}selected{% endif %}>
                            {{ ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'][m-1] }}
                          </option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="form-row">
                        <label>День</label>
                        <input name="rec_day" type="number" min="1" max="31" value="{{ rule.by_monthday_for_year or 1 }}" style="max-width: 80px;">
                      </div>
                    </div>
                    <div class="rec-monthly-fields" {% if rule.freq != 'MONTHLY' %}style="display:none;"{% endif %}>
                      <div class="form-row">
                        <label>День месяца</label>
                        <input name="rec_day" type="number" min="1" max="31" value="{{ rule.by_monthday or 1 }}" style="max-width: 80px;">
                      </div>
                    </div>
                    <div class="rec-weekly-fields" {% if rule.freq != 'WEEKLY' %}style="display:none;"{% endif %}>
                      <div class="form-row">
                        <label>Дни недели</label>
                        <div class="weekday-checkboxes">
                          {% set current_weekdays = (rule.by_weekday or '').split(',') %}
                          {% for code, label in [('MO','ПН'),('TU','ВТ'),('WE','СР'),('TH','ЧТ'),('FR','ПТ'),('SA','СБ'),('SU','ВС')] %}
                          <label><input type="checkbox" name="rec_weekdays" value="{{ code }}" {% if code in current_weekdays %}checked{% endif %}><span>{{ label }}</span></label>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    <div class="rec-interval-fields" {% if rule.freq not in ('DAILY', 'INTERVAL_DAYS') %}style="display:none;"{% endif %}>
                      <div class="form-row">
                        <label>Каждые N дней</label>
                        <input name="rec_interval" type="number" min="1" value="{{ rule.interval or 1 }}" style="max-width: 80px;">
                      </div>
                      <div class="form-row">
                        <label>Начать с</label>
                        <input name="rec_start_date" type="date" value="{{ rule.start_date.isoformat() if rule.start_date else today.isoformat() }}">
                      </div>
                    </div>
                  </div>
                  {% endif %}
                  <button type="submit" style="font-size: 12px; padding: 4px 10px;">Сохранить</button>
                </form>
              </div>
            </details>

            <!-- Add manual occurrence (per-event) -->
            <details style="display: inline; margin-left: 4px;">
              <summary style="cursor: pointer; font-size: 12px; color: #007AFF;">+ Вхождение</summary>
              <div style="padding: 8px 0;">
                <form method="POST" action="/events/occurrences/create">
                  <input type="hidden" name="event_id" value="{{ ev.event_id }}">
                  <div class="form-row">
                    <label>Дата начала</label>
                    <input name="start_date" type="date" value="{{ today.isoformat() }}" required>
                  </div>
                  <div class="form-row">
                    <label>Время начала</label>
                    <input name="start_time" type="time">
                  </div>
                  <div class="form-row">
                    <label>Дата окончания</label>
                    <input name="end_date" type="date">
                  </div>
                  <div class="form-row">
                    <label>Время окончания</label>
                    <input name="end_time" type="time">
                  </div>
                  <button type="submit" style="font-size: 12px; padding: 4px 10px;">Добавить</button>
                </form>
              </div>
            </details>

            <form method="POST" action="/events/{{ ev.event_id }}/deactivate" style="display:inline; margin-left: 4px;">
              <button type="submit" class="danger" style="font-size: 12px; padding: 4px 10px;"
                      onclick="return confirm('Деактивировать событие? Новые вхождения не будут генерироваться.')">Выключить</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Нет активных событий</p>
  {% endif %}
</div>

<!-- Create event (redesigned) -->
<div class="card">
  <h2>Создать событие</h2>
  <form method="POST" action="/events/create" id="create-event-form">
    <div class="form-row">
      <label>Название</label>
      <input name="title" placeholder="Например: День рождения" required>
    </div>
    <div class="form-row">
      <label>Категория</label>
      <select name="category_id" required>
        {% for wc in work_categories %}
          <option value="{{ wc.category_id }}">{{ wc.emoji or '' }} {{ wc.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-row">
      <label>Описание</label>
      <input name="description" placeholder="Опционально">
    </div>
    <div class="form-row">
      <label>Важность (0-5)</label>
      <input name="importance" type="number" min="0" max="5" value="0" style="max-width: 80px;">
    </div>

    <!-- Event type toggle -->
    <div class="form-row">
      <label>Тип события</label>
      <div class="event-type-toggle">
        <input type="radio" name="event_type" value="onetime" id="et-onetime" checked>
        <label for="et-onetime">Однократное</label>
        <input type="radio" name="event_type" value="recurring" id="et-recurring">
        <label for="et-recurring">Повторяющееся</label>
      </div>
    </div>

    <!-- One-time fields -->
    <div id="onetime-fields">
      <div class="form-row">
        <label>Дата начала</label>
        <input name="start_date" type="date" value="{{ today.isoformat() }}">
      </div>
      <div class="form-row">
        <label>Время начала (опционально)</label>
        <input name="start_time" type="time">
      </div>
      <div class="form-row">
        <label>Дата окончания (опционально, для периодов)</label>
        <input name="end_date" type="date">
      </div>
      <div class="form-row">
        <label>Время окончания (опционально)</label>
        <input name="end_time" type="time">
      </div>
    </div>

    <!-- Recurring fields -->
    <div id="recurring-fields" style="display: none;">
      <div class="form-row">
        <label>Тип повтора</label>
        <select name="recurrence_type" id="recurrence-type-select">
          <option value="">-- Выберите --</option>
          <option value="yearly">Ежегодно</option>
          <option value="monthly">Ежемесячно</option>
          <option value="weekly">Еженедельно</option>
          <option value="interval">Каждые N дней</option>
        </select>
      </div>

      <!-- Yearly fields -->
      <div id="rec-yearly" class="rec-type-fields" style="display: none;">
        <div class="form-row">
          <label>Месяц</label>
          <select name="rec_month" disabled>
            <option value="">-- Выберите --</option>
            <option value="1">Январь</option>
            <option value="2">Февраль</option>
            <option value="3">Март</option>
            <option value="4">Апрель</option>
            <option value="5">Май</option>
            <option value="6">Июнь</option>
            <option value="7">Июль</option>
            <option value="8">Август</option>
            <option value="9">Сентябрь</option>
            <option value="10">Октябрь</option>
            <option value="11">Ноябрь</option>
            <option value="12">Декабрь</option>
          </select>
        </div>
        <div class="form-row">
          <label>День</label>
          <input name="rec_day" type="number" min="1" max="31" placeholder="1-31" style="max-width: 80px;" disabled>
        </div>
      </div>

      <!-- Monthly fields -->
      <div id="rec-monthly" class="rec-type-fields" style="display: none;">
        <div class="form-row">
          <label>День месяца</label>
          <input name="rec_day" type="number" min="1" max="31" placeholder="1-31" style="max-width: 80px;" disabled>
        </div>
      </div>

      <!-- Weekly fields -->
      <div id="rec-weekly" class="rec-type-fields" style="display: none;">
        <div class="form-row">
          <label>Дни недели</label>
          <div class="weekday-checkboxes">
            <label><input type="checkbox" name="rec_weekdays" value="MO" disabled><span>ПН</span></label>
            <label><input type="checkbox" name="rec_weekdays" value="TU" disabled><span>ВТ</span></label>
            <label><input type="checkbox" name="rec_weekdays" value="WE" disabled><span>СР</span></label>
            <label><input type="checkbox" name="rec_weekdays" value="TH" disabled><span>ЧТ</span></label>
            <label><input type="checkbox" name="rec_weekdays" value="FR" disabled><span>ПТ</span></label>
            <label><input type="checkbox" name="rec_weekdays" value="SA" disabled><span>СБ</span></label>
            <label><input type="checkbox" name="rec_weekdays" value="SU" disabled><span>ВС</span></label>
          </div>
        </div>
      </div>

      <!-- Interval fields -->
      <div id="rec-interval" class="rec-type-fields" style="display: none;">
        <div class="form-row">
          <label>Каждые N дней</label>
          <input name="rec_interval" type="number" min="1" value="1" style="max-width: 80px;" disabled>
        </div>
        <div class="form-row">
          <label>Начать с</label>
          <input name="rec_start_date" type="date" value="{{ today.isoformat() }}" disabled>
        </div>
      </div>
    </div>

    <button type="submit">Создать</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Create form: event type toggle
  var radios = document.querySelectorAll('input[name="event_type"]');
  var onetimeFields = document.getElementById('onetime-fields');
  var recurringFields = document.getElementById('recurring-fields');

  radios.forEach(function(radio) {
    radio.addEventListener('change', function() {
      if (this.value === 'onetime') {
        onetimeFields.style.display = '';
        recurringFields.style.display = 'none';
      } else {
        onetimeFields.style.display = 'none';
        recurringFields.style.display = '';
      }
    });
  });

  // Create form: recurrence type toggle
  var recSelect = document.getElementById('recurrence-type-select');
  if (recSelect) {
    recSelect.addEventListener('change', function() {
      var fields = document.querySelectorAll('#recurring-fields .rec-type-fields');
      fields.forEach(function(f) {
        f.style.display = 'none';
        f.querySelectorAll('input, select').forEach(function(el) { el.disabled = true; });
      });
      var target = document.getElementById('rec-' + this.value);
      if (target) {
        target.style.display = '';
        target.querySelectorAll('input, select').forEach(function(el) { el.disabled = false; });
      }
    });
  }
});

// Edit form: recurrence type toggle (for inline edit)
function toggleEditRecFields(select, containerId) {
  var container = document.getElementById(containerId);
  if (!container) return;
  container.querySelectorAll('.rec-yearly-fields, .rec-monthly-fields, .rec-weekly-fields, .rec-interval-fields').forEach(function(f) {
    f.style.display = 'none';
  });
  var cls = 'rec-' + select.value + '-fields';
  var target = container.querySelector('.' + cls);
  if (target) target.style.display = '';
}
</script>

{% endblock %}
