{% extends "base.html" %}
{% block title %}История XP — FinLife{% endblock %}

{% block content %}
<style>
  .xp-hist-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .xp-hist-table th { background: #f9f9f9; padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; border-bottom: 2px solid #ddd; }
  .xp-hist-table td { padding: 9px 12px; border-bottom: 1px solid #eee; vertical-align: top; }
  .xp-hist-table tr:last-child td { border-bottom: none; }
  .xp-amount-col { font-weight: 700; color: #007AFF; white-space: nowrap; text-align: right; }
  .xp-date-col { white-space: nowrap; color: #666; font-size: 13px; font-variant-numeric: tabular-nums; }
  .xp-filter-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 16px; }
  .xp-filter-field { display: flex; flex-direction: column; gap: 4px; }
  .xp-filter-field label { font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.3px; }
  .xp-filter-field input, .xp-filter-field select { max-width: 160px; font-size: 13px; padding: 6px 10px; }
  .xp-pagination { display: flex; align-items: center; gap: 16px; padding: 16px 0; font-size: 14px; }
  .xp-page-info { color: #666; font-size: 13px; }

  /* Dark theme */
  [data-theme="dark"] .xp-hist-table th { background: #21262d; color: #8b949e; border-bottom-color: #30363d; }
  [data-theme="dark"] .xp-hist-table td { border-bottom-color: #21262d; }
  [data-theme="dark"] .xp-date-col { color: #8b949e; }
  [data-theme="dark"] .xp-filter-field label { color: #8b949e; }
  [data-theme="dark"] .xp-page-info { color: #8b949e; }
</style>

<div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 20px;">
  <h1 style="margin: 0;">История XP</h1>
  <a href="/profile" style="font-size: 13px; color: #007AFF; text-decoration: none;">← Профиль</a>
</div>

{# ── Filters ── #}
<div class="card" style="padding: 16px 20px; margin-bottom: 16px;">
  <form method="GET" action="/profile/xp-history">
    <div class="xp-filter-row">
      <div class="xp-filter-field">
        <label for="f_from">С</label>
        <input type="date" id="f_from" name="from_date" value="{{ from_date }}">
      </div>
      <div class="xp-filter-field">
        <label for="f_to">По</label>
        <input type="date" id="f_to" name="to_date" value="{{ to_date }}">
      </div>
      <div class="xp-filter-field">
        <label for="f_type">Тип</label>
        <select id="f_type" name="reason" style="max-width: 220px;">
          <option value="">— Все типы —</option>
          {% for val, label in reason_options %}
          <option value="{{ val }}" {% if reason == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="xp-filter-field">
        <label for="f_min">Мин. XP</label>
        <input type="number" id="f_min" name="min_xp" value="{{ min_xp }}" min="1" style="max-width: 90px;">
      </div>
      <div style="padding-bottom: 2px;">
        <button type="submit" style="font-size: 13px; padding: 7px 18px;">Применить</button>
        <a href="/profile/xp-history" style="font-size: 13px; color: #666; text-decoration: none; margin-left: 8px;">Сбросить</a>
      </div>
    </div>
  </form>
</div>

{# ── Table ── #}
<div class="card" style="padding: 0; overflow: hidden;">
  {% if items %}
  <table class="xp-hist-table">
    <thead>
      <tr>
        <th style="width: 130px;">Дата и время</th>
        <th>Описание</th>
        <th style="width: 90px; text-align: right;">XP</th>
      </tr>
    </thead>
    <tbody>
      {% for ev in items %}
      <tr>
        <td class="xp-date-col">{{ ev.created_at }}</td>
        <td>{{ ev.description }}</td>
        <td class="xp-amount-col">+{{ ev.xp_amount }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div style="padding: 24px; color: #888; font-size: 14px; text-align: center;">
    Событий не найдено. Попробуйте изменить фильтры.
  </div>
  {% endif %}
</div>

{# ── Pagination ── #}
{% if total_pages > 1 %}
<div class="xp-pagination">
  {% if has_prev %}
  <a href="?page={{ page - 1 }}&from_date={{ from_date }}&to_date={{ to_date }}&min_xp={{ min_xp }}&reason={{ reason }}"
     class="btn secondary" style="font-size: 13px; padding: 6px 16px;">← Назад</a>
  {% else %}
  <span style="color: #ccc; font-size: 13px; padding: 6px 16px;">← Назад</span>
  {% endif %}

  <span class="xp-page-info">Страница {{ page }} из {{ total_pages }} ({{ total }} событий)</span>

  {% if has_next %}
  <a href="?page={{ page + 1 }}&from_date={{ from_date }}&to_date={{ to_date }}&min_xp={{ min_xp }}&reason={{ reason }}"
     class="btn secondary" style="font-size: 13px; padding: 6px 16px;">Далее →</a>
  {% else %}
  <span style="color: #ccc; font-size: 13px; padding: 6px 16px;">Далее →</span>
  {% endif %}
</div>
{% else %}
<div class="xp-page-info" style="padding: 12px 0; font-size: 13px;">
  Всего: {{ total }} событий
</div>
{% endif %}

{% endblock %}
