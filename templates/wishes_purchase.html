{% extends "base.html" %}

{% block title %}–ó–∞–∫—É–ø–∫–∞{% endblock %}

{% block content %}
<div style="padding: 20px;">
    <!-- Header with tabs -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; gap: 15px;">
            <a href="/wishes" style="text-decoration: none; font-size: 16px; color: #666;">
                –•–æ—Ç–µ–ª–∫–∏
            </a>
            <a href="/wishes/purchase" style="text-decoration: none; font-size: 20px; font-weight: 600; color: #333;">
                –ó–∞–∫—É–ø–∫–∞
            </a>
        </div>
    </div>

    <div class="notice-amber" style="padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 13px;">
        üí° –†–µ–∂–∏–º "–ó–∞–∫—É–ø–∫–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –ø–æ–∫—É–ø–∫–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ "–ò–¥–µ—è" –∏–ª–∏ "–î—É–º–∞—é". –û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≥–∞–ª–æ—á–∫–∞–º–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫—É–ø–∫—É".
    </div>

    {% if wishes %}
    <form method="POST" action="/wishes/purchase/complete" id="purchase-form">
        <div class="item-card" style="border-radius: 8px; overflow: hidden; margin-bottom: 16px;">
            {% for wish in wishes %}
            <label style="display: flex; padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; align-items: center;">
                <input type="checkbox" name="wish_{{ wish.wish_id }}" value="1"
                       onchange="toggleWish({{ wish.wish_id }})"
                       style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">
                        {{ wish.title }}
                        {% if wish.is_recurring %}
                        <span style="font-size: 11px; background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">
                            ‚ôªÔ∏è –ø–æ–≤—Ç–æ—Ä
                        </span>
                        {% endif %}
                    </div>
                    <div style="font-size: 12px; color: #666; display: flex; gap: 12px;">
                        {% if wish.status %}
                        <span>
                            {% if wish.status == 'IDEA' %}üí° –ò–¥–µ—è
                            {% elif wish.status == 'CONSIDERING' %}ü§î –î—É–º–∞—é
                            {% endif %}
                        </span>
                        {% endif %}
                        {% if wish.target_date %}
                        <span>üéØ {{ wish.target_date.strftime('%d.%m.%Y') }}</span>
                        {% elif wish.target_month %}
                        <span>üéØ {{ wish.target_month }}</span>
                        {% endif %}
                        {% if wish.estimated_amount %}
                        <span>üíµ {{ "{:,.2f}".format(wish.estimated_amount).replace(',', ' ') }} —Ä—É–±.</span>
                        {% endif %}
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>

        <input type="hidden" name="wish_ids" id="selected-wish-ids" value="">

        <div style="display: flex; gap: 12px; align-items: center;">
            <button type="submit" id="complete-btn" disabled
                    style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                ‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫—É–ø–∫—É
            </button>
            <span id="selected-count" style="font-size: 13px; color: #666;">
                –í—ã–±—Ä–∞–Ω–æ: 0
            </span>
            <span id="selected-total" style="font-size: 13px; color: #666; margin-left: auto;">
            </span>
        </div>
    </form>

    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: #999;">
        <div style="font-size: 48px; margin-bottom: 12px;">üõí</div>
        <div style="font-size: 16px;">–ù–µ—Ç —Ö–æ—Ç–µ–ª–æ–∫ –¥–ª—è –∑–∞–∫—É–ø–∫–∏</div>
        <div style="font-size: 13px; margin-top: 8px;">
            –ü–æ–∫—É–ø–∫–∏ –≤ —Å—Ç–∞—Ç—É—Å–µ "–ò–¥–µ—è" –∏–ª–∏ "–î—É–º–∞—é" –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
        </div>
        <div style="margin-top: 16px;">
            <a href="/wishes" style="color: #4CAF50;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
const selectedWishes = new Set();

// Wish amounts mapping
const wishAmounts = {
    {% for wish in wishes %}
    {{ wish.wish_id }}: {{ wish.estimated_amount or 0 }},
    {% endfor %}
};

function toggleWish(wishId) {
    const checkbox = document.querySelector(`input[name="wish_${wishId}"]`);
    if (checkbox.checked) {
        selectedWishes.add(wishId);
    } else {
        selectedWishes.delete(wishId);
    }
    updateSelectedInfo();
}

function updateSelectedInfo() {
    const count = selectedWishes.size;
    const completeBtn = document.getElementById('complete-btn');
    const countSpan = document.getElementById('selected-count');
    const totalSpan = document.getElementById('selected-total');
    const idsInput = document.getElementById('selected-wish-ids');

    // Update count
    countSpan.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;

    // Update total
    let total = 0;
    selectedWishes.forEach(id => {
        total += wishAmounts[id] || 0;
    });
    if (total > 0) {
        totalSpan.textContent = `–°—É–º–º–∞: ${total.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}).replace(',', ' ')} —Ä—É–±.`;
    } else {
        totalSpan.textContent = '';
    }

    // Enable/disable button
    completeBtn.disabled = count === 0;
    if (count === 0) {
        completeBtn.style.opacity = '0.5';
        completeBtn.style.cursor = 'not-allowed';
    } else {
        completeBtn.style.opacity = '1';
        completeBtn.style.cursor = 'pointer';
    }

    // Update hidden input
    idsInput.value = Array.from(selectedWishes).join(',');
}
</script>
{% endblock %}
