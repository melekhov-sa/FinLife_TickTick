{% extends "base.html" %}
{% block title %}Предстоящие операции — FinLife{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
  <h1 style="margin: 0;">Предстоящие операции</h1>
  <a href="/planned-ops" class="btn secondary" style="text-decoration: none;">К шаблонам</a>
</div>

<!-- Active occurrences -->
<div class="card">
  <h2 style="margin-top: 0;">Ожидают действия</h2>
  {% if active_occs %}
  <table>
    <thead>
      <tr><th>Дата</th><th>Шаблон</th><th>Тип</th><th>Сумма</th><th>Действия</th></tr>
    </thead>
    <tbody>
      {% for occ in active_occs %}
        {% set tmpl = tmpl_map.get(occ.template_id) %}
      <tr>
        <td class="{% if occ.scheduled_date == today %}positive{% elif occ.scheduled_date < today %}negative{% endif %}">
          {{ occ.scheduled_date.strftime('%d.%m.%Y') }}
          {% if occ.scheduled_date == today %}<small>(сегодня)</small>{% endif %}
          {% if occ.scheduled_date < today %}<small>(просрочено)</small>{% endif %}
        </td>
        <td>
          {% if tmpl %}{{ tmpl.title }}{% else %}<span class="muted">Шаблон #{{ occ.template_id }}</span>{% endif %}
        </td>
        <td>
          {% if tmpl %}
            {% if tmpl.kind == 'INCOME' %}<span class="badge badge-income">Доход</span>
            {% else %}<span class="badge badge-expense">Расход</span>{% endif %}
          {% endif %}
        </td>
        <td>
          {% if tmpl %}{{ "{:,.2f}".format(tmpl.amount).replace(",", " ") }}{% endif %}
        </td>
        <td style="white-space: nowrap;">
          <a href="/plan/operation-occurrences/{{ occ.id }}/confirm?redirect=/planned-ops/upcoming"
             class="action-link"
             style="font-size: 12px; padding: 4px 10px; display: inline-block; text-decoration: none; border: 1px solid #28a745; border-radius: 6px; color: #28a745; background: #fff;">
            Создать факт
          </a>
          <form method="POST" action="/planned-ops/occurrences/{{ occ.id }}/skip" style="display:inline;">
            <button type="submit" class="secondary" style="font-size: 12px; padding: 4px 10px;">Пропустить</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="muted">Нет предстоящих операций</p>
  {% endif %}
</div>

<!-- Done / Skipped -->
{% if done_occs %}
<div class="card">
  <details>
    <summary class="muted" style="cursor: pointer;">Обработанные ({{ done_occs | length }})</summary>
    <table>
      <thead><tr><th>Дата</th><th>Шаблон</th><th>Статус</th></tr></thead>
      <tbody>
        {% for occ in done_occs %}
          {% set tmpl = tmpl_map.get(occ.template_id) %}
        <tr style="opacity: 0.6;">
          <td>{{ occ.scheduled_date.strftime('%d.%m.%Y') }}</td>
          <td>{{ tmpl.title if tmpl else 'Шаблон #' ~ occ.template_id }}</td>
          <td>
            {% if occ.status == 'DONE' %}<span class="positive">Подтверждено</span>
            {% else %}<span class="muted">Пропущено</span>{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </details>
</div>
{% endif %}
{% endblock %}
