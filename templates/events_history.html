{% extends "base.html" %}
{% block title %}История событий - FinLife{% endblock %}

{% block content %}
<h1>&#128198; История событий</h1>

<p><a href="/events">&larr; Назад к событиям</a></p>

<div class="card">
  {% if history %}
    <table>
      <thead>
        <tr><th>Дата</th><th>Время</th><th>Событие</th><th>Категория</th><th>Статус</th></tr>
      </thead>
      <tbody>
        {% set prev_date = namespace(val=None) %}
        {% for occ in history %}
          {% set ev = event_map.get(occ.event_id) %}
          {% set wc = wc_map.get(ev.category_id) if ev else None %}
          {% set show_header = occ.start_date != prev_date.val %}
          {% if show_header %}
            <tr style="background: #f9f9f9;">
              <td colspan="5" style="font-weight: 600; padding: 8px 12px;">
                {{ occ.start_date.strftime('%d.%m.%Y') }}
                {% set weekdays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'] %}
                <small class="muted">({{ weekdays[occ.start_date.weekday()] }})</small>
              </td>
            </tr>
          {% endif %}
          {% set prev_date.val = occ.start_date %}
        <tr style="opacity: 0.8;">
          <td>{{ occ.start_date.strftime('%d.%m') }}</td>
          <td>
            {% if occ.start_time %}
              {{ occ.start_time.strftime('%H:%M') }}
            {% else %}
              <span class="muted">весь день</span>
            {% endif %}
          </td>
          <td>
            {{ ev.title if ev else 'Событие #' ~ occ.event_id }}
            {% if ev and ev.importance > 0 %}
              <span class="badge">&#9733; {{ ev.importance }}</span>
            {% endif %}
            {% if occ.end_date and occ.end_date != occ.start_date %}
              <small class="muted">до {{ occ.end_date.strftime('%d.%m') }}</small>
            {% endif %}
          </td>
          <td>
            {% if wc %}
              {{ wc.emoji or '' }} {{ wc.title }}
            {% endif %}
          </td>
          <td>
            {% if occ.is_cancelled %}
              <span class="negative">отменено</span>
            {% else %}
              <span class="muted">прошло</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Нет прошедших событий</p>
  {% endif %}
</div>
{% endblock %}
